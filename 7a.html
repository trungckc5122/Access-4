<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Access 4 - Module 7a - Updated with IPA & Grammar</title>
    <style>
        /* ========================================================================
        TECHNICAL REQUIREMENTS:
        
        DATA & CONTENT:
        1. DATA INTEGRITY: 100% original content from all provided images. No modifications to vocabulary, definitions, or questions.
        2. CONTENT STRUCTURE: Maintain original task numbering (Task 1-6) and organization as per source material.
        3. NEW FEATURE: IPA pronunciation data for vocabulary items in matching exercises.
        4. NEW FEATURE: Grammar reference section with modal verbs explanation.
        
        UI/UX DESIGN SPECIFICATIONS:
        3. STICKY UI: Word Bank follows scrolling with position: sticky, top: 15px, z-index: 100.
        4. RESPONSIVE CONTAINER: Max-width: 1000px, centered with margin: 0 auto.
        5. COLOR SCHEME: 
           - Primary: #2980b9 (Blue)
           - Primary-dark: #1c5982 (Dark Blue)
           - Success: #27ae60 (Green)
           - Error: #e74c3c (Red)
           - Warning: #f1c40f (Yellow)
           - IPA: #8e44ad (Purple for IPA feature)
           - Background: #f4f7f9 (Light Gray)
           - Text: #2c3e50 (Dark Gray)
           - Card: #ffffff (White)
        6. TYPOGRAPHY: Times New Roman, 13pt, line-height: 1.6, serif font for academic appearance.
        7. CARD DESIGN: Exercise cards with 12px border-radius, 25px padding, box-shadow: 0 4px 15px rgba(0,0,0,0.05).
        8. EXERCISE TITLE: 1.25em, bold, var(--primary-dark) color, bottom border with 2px solid #eee.
        
        INTERACTION DESIGN:
        9. SINGLE SOLVE: Individual 'Show' (üëÅÔ∏è) buttons per question with 28x28px dimensions.
        10. PEDAGOGICAL HINTS: Detailed English explanations via (i) button (20x20px circle).
        11. IPA PRONUNCIATION: Speaker button (üîä) for vocabulary pronunciation with IPA display.
        12. SAFE-HIGHLIGHT: Secure keyword highlighting - correct: green border/background, incorrect: red border/background.
        13. DUAL INPUT METHODS: Click-to-select & Drag-drop from Word Bank.
        14. AUTO-WIDTH INPUTS: Inputs resize dynamically based on content length.
        15. CASE-INSENSITIVE MATCHING: All comparisons use .toLowerCase().trim().
        16. WORD BANK MANAGEMENT: Auto-hide used items with .used class (display: none).
        
        LAYOUT SPECIFICATIONS:
        17. AUTOMATIC WORD BANK GENERATION: For vocabulary fill-in exercises, automatically extract unique answers and display in sticky container.
        18. MATCHING COLUMNS LAYOUT: For definition matching exercises, use grid layout with 1fr 2fr columns, 30px gap.
        19. VOCABULARY ITEMS: Min-width: 150px for consistent alignment.
        20. QUESTION ROWS: 18px bottom margin, 2.2 line-height, subtle bottom border.
        21. GRAMMAR REFERENCE SECTION: Dedicated section at top for modal verbs explanation.
        22. IPA DISPLAY BOX: Hidden box below vocabulary items for IPA pronunciation display.
        
        CONTROL SPECIFICATIONS:
        23. LOCAL CONTROLS: Individual Task 'Show All' and 'Reset' buttons per exercise card.
        24. GLOBAL CONTROL: Fixed 'CHECK ALL ANSWERS' button bottom-right with 50px border-radius.
        25. KEYBOARD SUPPORT: Enter key to check all answers, Arrow keys for navigation.
        
        SPECIALIZED COMPONENTS:
        26. WORD BANK ITEMS: 6px 12px padding, 5px border-radius, #eef2f7 background, cursor: grab.
        27. INPUT FIELDS: Border-bottom only design (2px solid #bdc3c7), #fafafa background, 4px top border-radius.
        28. LETTER INPUTS: 45px width, uppercase, bold, for matching exercises.
        29. HINT BOXES: #fef9e7 background, 4px left border with warning color, 10px padding, 0.85em font.
        30. IPA BOXES: #f8f9fa background, 4px left border with IPA color, 10px padding, 0.9em font.
        31. CONTROL BUTTONS: 8px 20px padding, 6px border-radius, bold text, smooth transitions.
        32. SPEAKER BUTTON: 28x28px, purple background, üîä icon for IPA pronunciation.
        
        PERFORMANCE & ACCESSIBILITY:
        33. SMOOTH TRANSITIONS: 0.2s transition for interactive elements.
        34. CLEAR VISUAL FEEDBACK: Color changes, shadows, and borders for all interactions.
        35. Z-INDEX MANAGEMENT: Sticky bank (100), Check button (1000) for proper layering.
        36. IPA SINGLE ACTIVE SYSTEM: Only one IPA pronunciation box visible at a time.
        
        ======================================================================== */
        :root {
            --primary: #2980b9; 
            --primary-dark: #1c5982; 
            --success: #27ae60;
            --error: #e74c3c; 
            --warning: #f1c40f; 
            --ipa: #8e44ad; /* NEW: IPA color */
            --bg: #f4f7f9;
            --text: #2c3e50; 
            --card: #ffffff;
        }
        body { 
            font-family: 'Times New Roman', serif; 
            font-size: 13pt; 
            background-color: var(--bg); 
            color: var(--text); 
            margin: 0; 
            padding: 20px 20px 100px 20px; 
            line-height: 1.6; 
        }
        .container { 
            max-width: 1000px; 
            margin: 0 auto; 
        }
        
        /* Grammar Reference Section */
        .grammar-reference {
            background-color: #f8f9fa;
            border-left: 4px solid var(--primary);
            padding: 15px;
            margin-bottom: 30px;
            border-radius: 0 8px 8px 0;
            font-size: 0.9em;
        }
        .grammar-reference h3 {
            margin-top: 0;
            color: var(--primary-dark);
            font-size: 1.1em;
            border-bottom: 1px solid #e9ecef;
            padding-bottom: 8px;
        }
        .grammar-reference table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            font-size: 0.9em;
        }
        .grammar-reference th {
            background-color: #e3f2fd;
            padding: 10px;
            text-align: left;
            border: 1px solid #ddd;
        }
        .grammar-reference td {
            padding: 10px;
            border: 1px solid #ddd;
        }
        .grammar-reference ul {
            padding-left: 20px;
            margin: 10px 0;
        }
        .grammar-reference li {
            margin-bottom: 8px;
        }
        .reference-note {
            font-style: italic;
            color: #7f8c8d;
            font-size: 0.85em;
            margin-top: 10px;
            text-align: center;
            border-top: 1px solid #eee;
            padding-top: 10px;
        }
        
        /* Word Bank Styling */
        .sticky-bank { 
            position: sticky; 
            top: 15px; 
            z-index: 100;
            background-color: #fff; 
            padding: 15px; 
            border-radius: 10px; 
            margin-bottom: 25px; 
            border: 2px solid var(--primary); 
            display: flex; 
            flex-wrap: wrap; 
            gap: 10px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
        }
        .word-item { 
            background: #eef2f7; 
            border: 1px solid var(--primary); 
            color: var(--primary-dark); 
            padding: 6px 12px; 
            border-radius: 5px; 
            cursor: grab; 
            user-select: none; 
            transition: 0.2s; 
            font-size: 0.9em; 
            font-weight: 500;
        }
        .word-item.used { 
            display: none; 
        }
        .word-item:hover { 
            background: var(--primary); 
            color: white; 
        }

        /* Exercise Card */
        .exercise-card { 
            background: var(--card); 
            border-radius: 12px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); 
            padding: 25px; 
            margin-bottom: 30px; 
        }
        .exercise-title { 
            font-weight: bold; 
            font-size: 1.25em; 
            margin-bottom: 18px; 
            color: var(--primary-dark); 
            border-bottom: 2px solid #eee; 
            padding-bottom: 8px; 
        }
        
        /* Matching Grid Layout */
        .matching-grid { 
            display: grid; 
            grid-template-columns: 1fr 2fr; 
            gap: 30px; 
            margin-top: 10px; 
        }
        .vocab-item { 
            margin-bottom: 12px; 
            display: flex; 
            align-items: center; 
            gap: 10px; 
        }
        .vocab-text { 
            min-width: 150px; 
            font-weight: 500; 
        }
        .def-item { 
            margin-bottom: 12px; 
            padding: 4px 0; 
            border-bottom: 1px solid #f0f0f0; 
            min-height: 40px; 
            display: flex; 
            align-items: center; 
        }

        /* Question Rows */
        .question-row { 
            margin-bottom: 18px; 
            line-height: 2.2; 
            border-bottom: 1px solid #f9f9f9; 
            padding-bottom: 10px; 
            position: relative; 
        }
        
        /* Input Fields */
        input[type="text"] { 
            border: none; 
            border-bottom: 2px solid #bdc3c7; 
            background: #fafafa; 
            padding: 2px 8px; 
            font-size: 1em; 
            transition: 0.2s; 
            outline: none;
            min-width: 60px; 
            border-radius: 4px 4px 0 0; 
            text-align: center; 
            font-family: 'Times New Roman';
        }
        input.letter-input { 
            width: 45px; 
            min-width: 45px; 
            text-transform: uppercase; 
            font-weight: bold; 
            color: var(--primary-dark); 
        }
        input.correct { 
            border-bottom-color: var(--success) !important; 
            background-color: #e8f8f5 !important; 
            color: #1e8449 !important; 
        }
        input.incorrect-marked { 
            border-bottom-color: var(--error) !important; 
            background-color: #fdedec !important; 
        }

        /* Control Buttons */
        .row-btns { 
            display: inline-flex; 
            gap: 5px; 
            vertical-align: middle; 
            margin-left: 10px; 
        }
        .btn-small { 
            background: #eee; 
            border: 1px solid #ccc; 
            border-radius: 4px; 
            width: 28px; 
            height: 28px; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 14px; 
            transition: 0.2s;
        }
        .btn-small:hover {
            background: #ddd;
        }
        .btn-small.active {
            background: #3498db;
            color: white;
            border-color: #2980b9;
        }
        .speaker-btn {
            background: var(--ipa);
            color: white;
            border: none;
        }
        .speaker-btn:hover {
            background: #733d95;
        }
        .speaker-btn.active {
            background: #5e3377;
        }
        .info-btn { 
            background: #95a5a6; 
            color: white; 
            border: none; 
            border-radius: 50%; 
            width: 20px; 
            height: 20px; 
            font-size: 11px; 
            cursor: pointer; 
            display: inline-flex; 
            align-items: center; 
            justify-content: center; 
            transition: 0.2s;
        }
        .info-btn:hover {
            background: #7f8c8d;
        }
        .info-btn.active {
            background: #5d6d6e;
        }
        .hint-box { 
            display: none; 
            margin-top: 8px; 
            padding: 10px; 
            background-color: #fef9e7; 
            border-left: 4px solid var(--warning); 
            color: #7d6608; 
            border-radius: 4px; 
            font-size: 0.85em; 
        }
        .ipa-box {
            display: none;
            margin-top: 8px;
            padding: 10px;
            background-color: #f8f9fa;
            border-left: 4px solid var(--ipa);
            color: var(--text);
            border-radius: 4px;
            font-size: 0.9em;
            font-family: 'Times New Roman', serif;
        }
        .ipa-label {
            font-weight: bold;
            color: var(--ipa);
            margin-right: 5px;
        }
        .ipa-text {
            font-family: 'Times New Roman', serif;
            font-style: italic;
        }

        /* Section Controls */
        .controls-row { 
            display: flex; 
            justify-content: flex-end; 
            gap: 10px; 
            margin-top: 15px; 
        }
        .btn { 
            padding: 8px 20px; 
            border-radius: 6px; 
            cursor: pointer; 
            border: none; 
            font-weight: bold; 
            transition: 0.3s; 
        }
        .btn-reset { 
            background: #95a5a6; 
            color: white; 
        }
        .btn-show-all { 
            background: var(--primary); 
            color: white; 
        }
        
        /* Global Check Button */
        .check-all-btn { 
            position: fixed; 
            right: 30px; 
            bottom: 30px; 
            background-color: var(--success); 
            color: white; 
            padding: 15px 30px; 
            border-radius: 50px; 
            cursor: pointer; 
            z-index: 1000; 
            font-weight: bold; 
            border: none; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.2); 
        }
        
        /* Task 5 specific styling */
        .task5-input {
            min-width: 300px;
            max-width: 600px;
            margin-left: 10px;
        }
        
        .instruction-note {
            font-style: italic;
            color: #7f8c8d;
            margin-bottom: 15px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }
    </style>
</head>
<body>

<div class="container">
    <h1 style="text-align: center; color: var(--primary-dark); margin-bottom: 30px;">ACCESS 4 - MODULE 7A</h1>
    
    <!-- Grammar Reference Section -->
    <div class="exercise-card">
        <div class="exercise-title">Grammar Reference: Modal Verbs</div>
        <div class="grammar-reference">
            <h3>Must vs. Have to vs. Mustn't vs. Don't have to</h3>
            
            <table>
                <tr>
                    <th>Modal Verb</th>
                    <th>Meaning/Use</th>
                    <th>Example</th>
                    <th>Key Point</th>
                </tr>
                <tr>
                    <td><strong>must</strong></td>
                    <td>Strong obligation from the speaker's perspective</td>
                    <td>I <strong>must</strong> finish this today. (I feel it's necessary)</td>
                    <td>Personal feeling/internal obligation</td>
                </tr>
                <tr>
                    <td><strong>have to</strong></td>
                    <td>External obligation (rules, laws, requirements)</td>
                    <td>You <strong>have to</strong> wear a uniform. (It's the rule)</td>
                    <td>External rules/compulsory</td>
                </tr>
                <tr>
                    <td><strong>mustn't</strong></td>
                    <td>Prohibition (something is forbidden)</td>
                    <td>You <strong>mustn't</strong> smoke here. (It's prohibited)</td>
                    <td>Negative prohibition</td>
                </tr>
                <tr>
                    <td><strong>don't have to</strong></td>
                    <td>No obligation (optional)</td>
                    <td>You <strong>don't have to</strong> come. (It's not necessary)</td>
                    <td>Lack of necessity</td>
                </tr>
            </table>
            
            <h3>Important Rules:</h3>
            <ul>
                <li><strong>Must</strong> expresses the speaker's feelings or opinions.</li>
                <li><strong>Have to</strong> expresses external rules or obligations.</li>
                <li><strong>Mustn't</strong> = prohibition (it is forbidden).</li>
                <li><strong>Don't have to</strong> = no obligation (it is optional).</li>
                <li>In spoken English, "have to" is often used instead of "must".</li>
                <li>"Must" has no past form - use "had to" for past obligation.</li>
            </ul>
            
            <p class="reference-note">Grammar reference based on Cambridge English Grammar in Use</p>
        </div>
    </div>

    <!-- Task 1: Vocabulary Matching -->
    <div class="exercise-card" id="card-t1">
        <div class="exercise-title">Task 1: Vocabulary Matching ‚Äì Match the word to its definition</div>
        <div class="matching-grid">
            <div id="vocab-t1"></div>
            <div id="def-t1"></div>
        </div>
        <div class="controls-row">
            <button class="btn btn-show-all" onclick="showAnswers('t1')">Show All</button>
            <button class="btn btn-reset" onclick="resetSection('t1')">Reset</button>
        </div>
    </div>

    <!-- Task 2: Fill in gaps with vocabulary from task 1 -->
    <div class="exercise-card" id="card-t2">
        <div class="exercise-title">Task 2: Filling in the gaps with vocabulary from task 1</div>
        <div class="sticky-bank" id="bank-t2"></div>
        <div id="questions-t2"></div>
        <div class="controls-row">
            <button class="btn btn-show-all" onclick="showAnswers('t2')">Show All</button>
            <button class="btn btn-reset" onclick="resetSection('t2')">Reset</button>
        </div>
    </div>

    <!-- Task 3: Vocabulary Matching -->
    <div class="exercise-card" id="card-t3">
        <div class="exercise-title">Task 3: Vocabulary Matching ‚Äì Match the word to its definition</div>
        <div class="matching-grid">
            <div id="vocab-t3"></div>
            <div id="def-t3"></div>
        </div>
        <div class="controls-row">
            <button class="btn btn-show-all" onclick="showAnswers('t3')">Show All</button>
            <button class="btn btn-reset" onclick="resetSection('t3')">Reset</button>
        </div>
    </div>

    <!-- Task 4: Fill in gaps with vocabulary from task 3 -->
    <div class="exercise-card" id="card-t4">
        <div class="exercise-title">Task 4: Filling in the gaps with vocabulary from task 3</div>
        <div class="sticky-bank" id="bank-t4"></div>
        <div id="questions-t4"></div>
        <div class="controls-row">
            <button class="btn btn-show-all" onclick="showAnswers('t4')">Show All</button>
            <button class="btn btn-reset" onclick="resetSection('t4')">Reset</button>
        </div>
    </div>

    <!-- Task 5: Grammar - Choose correct verb -->
    <div class="exercise-card" id="card-t5">
        <div class="exercise-title">Task 5: Read the advice for an actor on a film set. Choose the correct verb in brackets and rewrite each sentence.</div>
        <div class="instruction-note">For example: "You should arrive on time." ‚Üí I <strong>must</strong> arrive on time.</div>
        <div id="questions-t5"></div>
        <div class="controls-row">
            <button class="btn btn-show-all" onclick="showAnswers('t5')">Show All</button>
            <button class="btn btn-reset" onclick="resetSection('t5')">Reset</button>
        </div>
    </div>

    <!-- Task 6: Complete advert with words in list -->
    <div class="exercise-card" id="card-t6">
        <div class="exercise-title">Task 6: Complete the advert with the words in the list</div>
        <div class="sticky-bank" id="bank-t6"></div>
        <div id="questions-t6"></div>
        <div class="controls-row">
            <button class="btn btn-show-all" onclick="showAnswers('t6')">Show All</button>
            <button class="btn btn-reset" onclick="resetSection('t6')">Reset</button>
        </div>
    </div>
</div>

<button class="check-all-btn" onclick="checkAll()">CHECK ALL ANSWERS (ENTER)</button>

<script>
/* --- UPDATED DATA WITH IPA --- */
// TASK 1 DATA - UPDATED TO MATCH IMAGE EXACTLY (v·ªã tr√≠ nh∆∞ trong h√¨nh)
const t1_data = [
    { 
        v: "1. futuristic settings", 
        letter: "A", 
        def: "A. very different from something else", 
        hint: "Imagined future places with advanced technology.",
        ipa: "/fjuÀêÀàt É är…™st…™k Ààs…õt…™≈ãz/" 
    },
    { 
        v: "2. exceptional", 
        letter: "B", 
        def: "B. simple but important", 
        hint: "Much better than usual; outstanding.",
        ipa: "/…™kÀàs…õp É…ôn…ôl/" 
    },
    { 
        v: "3. sensitively", 
        letter: "C", 
        def: "C. imagined places or situations in the future, often with advanced technology", 
        hint: "Showing care for people's feelings.",
        ipa: "/Ààs…õns…™t…™vli/" 
    },
    { 
        v: "4. rights", 
        letter: "D", 
        def: "D. much better than usual", 
        hint: "The freedoms that people are allowed to have.",
        ipa: "/ra…™ts/" 
    },
    { 
        v: "5. basic", 
        letter: "E", 
        def: "E. the ability to think and decide freely", 
        hint: "Simple but important; fundamental.",
        ipa: "/Ààbe…™s…™k/" 
    },
    { 
        v: "6. a far cry", 
        letter: "F", 
        def: "F. in a way that shows care for people's feelings", 
        hint: "Very different from something else.",
        ipa: "/…ô f…ëÀêr kra…™/" 
    },
    { 
        v: "7. independent thought", 
        letter: "G", 
        def: "G. the freedoms that people are allowed to have", 
        hint: "Thinking for yourself without being controlled.",
        ipa: "/Àå…™nd…™Ààp…õnd…ônt Œ∏…îÀêt/" 
    }
];

const t2_data = [
    { q: "1. Unlike other robots, Andrew slowly develops [INPUT] and begins to make his own decisions.", ans: "independent thought", hint: "He develops the ability to think for himself." },
    { q: "2. The story takes place in [INPUT] where robots live with human families.", ans: "futuristic settings", hint: "The setting is in an imagined future world." },
    { q: "3. Cleaning floors and preparing meals are [INPUT] tasks for household robots.", ans: "basic", hint: "These are simple, fundamental tasks." },
    { q: "4. The film raises the question of whether robots should have [INPUT] like humans.", ans: "rights", hint: "Should robots have the same freedoms as humans?" },
    { q: "5. Andrew's abilities are [INPUT] compared to those of other robots.", ans: "exceptional", hint: "His abilities are much better than other robots." },
    { q: "6. As Andrew shows emotions, the family learns to treat him [INPUT].", ans: "sensitively", hint: "They learn to be careful with his feelings." },
    { q: "7. Although Andrew looks human, he is still [INPUT] from being a real person.", ans: "a far cry", hint: "He is very different from an actual human." }
];

// TASK 3 DATA - UPDATED TO MATCH IMAGE EXACTLY (v·ªã tr√≠ nh∆∞ trong h√¨nh)
const t3_data = [
    { 
        v: "1. nevertheless", 
        letter: "A", 
        def: "A. control or power over others", 
        hint: "Despite what was said; however.",
        ipa: "/Àån…õv…ô√∞…ôÀàl…õs/" 
    },
    { 
        v: "2. consciousness", 
        letter: "B", 
        def: "B. to do what you are told or follow rules", 
        hint: "The state of being aware and able to think.",
        ipa: "/Ààk…ín É…ôsn…ôs/" 
    },
    { 
        v: "3. reasoning", 
        letter: "C", 
        def: "C. despite what has just been said", 
        hint: "The process of thinking logically.",
        ipa: "/ÀàriÀêz…ôn…™≈ã/" 
    },
    { 
        v: "4. fictional", 
        letter: "D", 
        def: "D. the ability to think logically", 
        hint: "Invented, not real; from imagination.",
        ipa: "/Ààf…™k É…ôn…ôl/" 
    },
    { 
        v: "5. domination", 
        letter: "E", 
        def: "E. invented and not real", 
        hint: "Control or power over others.",
        ipa: "/Àåd…ím…™Ààne…™ É…ôn/" 
    },
    { 
        v: "6. inaction", 
        letter: "F", 
        def: "F. the state of being aware and able to think", 
        hint: "Failure to act when action is needed.",
        ipa: "/…™nÀà√¶k É…ôn/" 
    },
    { 
        v: "7. obey", 
        letter: "G", 
        def: "G. failure to act when action is needed", 
        hint: "To follow rules or commands.",
        ipa: "/…ôÀàbe…™/" 
    }
];

const t4_data = [
    { q: "1. Andrew is programmed to [INPUT] every command given by humans.", ans: "obey", hint: "Robots are designed to follow human commands." },
    { q: "2. The novel criticises human [INPUT] when unfair laws are accepted without protest.", ans: "inaction", hint: "The book criticizes people for not acting against unfairness." },
    { q: "3. Andrew develops [INPUT] and becomes aware of his own existence.", ans: "consciousness", hint: "He becomes self-aware like a human." },
    { q: "4. Some people fear the [INPUT] of humans by intelligent machines.", ans: "domination", hint: "There's a fear that machines might control humans." },
    { q: "5. The story is [INPUT], but it explores real moral questions.", ans: "fictional", hint: "Although the story is made up, it deals with real issues." },
    { q: "6. Andrew is a robot; [INPUT], he wants to be recognised as human.", ans: "nevertheless", hint: "Even though he's a robot, he has human-like desires." },
    { q: "7. His advanced [INPUT] allows him to make logical decisions.", ans: "reasoning", hint: "His ability to think logically is very developed." }
];

// TASK 5 - UPDATED WITH BETTER HINTS
const t5_data = [
    { 
        sit: "1. It's very important to bring some food and water with you.", 
        prompt: "‚Üí I (must / have to)", 
        ans: "must bring some food and water with me", 
        hint: "Use 'must' for strong personal advice or feeling of necessity from the speaker's perspective." 
    },
    { 
        sit: "2. You are not allowed to use your mobile phone on the set.", 
        prompt: "‚Üí I (mustn't / don't have to)", 
        ans: "mustn't use my mobile phone on the set", 
        hint: "Use 'mustn't' for prohibition - when something is forbidden or not allowed by rules." 
    },
    { 
        sit: "3. Don't look at the camera when you're acting.", 
        prompt: "‚Üí I (mustn't / don't have to)", 
        ans: "mustn't look at the camera when I'm acting", 
        hint: "This is a rule that must be followed - 'mustn't' expresses strong prohibition." 
    },
    { 
        sit: "4. It's important to learn the script.", 
        prompt: "‚Üí I (must / mustn't)", 
        ans: "must learn the script", 
        hint: "Use 'must' for strong internal necessity - learning the script is essential for an actor." 
    },
    { 
        sit: "5. If you are sixteen or under, it's compulsory to bring a parent with you.", 
        prompt: "‚Üí I (must / have to)", 
        ans: "have to bring a parent with me", 
        hint: "Use 'have to' for external rules or compulsory requirements from an authority." 
    }
];

const t6_data = {
    words: ["must", "must", "have to", "don't have to", "mustn't"],
    text: `"Right. I 1 [INPUT] eat something. Boil the water, open the packet, read the instructions... 
           Oh no, I 2 [INPUT] prepare a lot of vegetables!" 
           Does this sound like you in the kitchen? 
           If it does, you need <b>READYLUNCH!</b> Open the packet. 
           Don't worry ‚Äî you 3 [INPUT] prepare any vegetables! Just add hot water, sit down and enjoy! 
           But remember, you 4 [INPUT] tell your friends about this or they'll all want one! 
           Go on. You really 5 [INPUT] try it!"`,
    ans: ["must", "have to", "don't have to", "mustn't", "must"],
    hints: [
        "Internal desire or strong personal feeling (must).",
        "External necessity or obligation (have to).",
        "Lack of necessity - it's optional (don't have to).",
        "Prohibition - you shouldn't do this (mustn't).",
        "Strong recommendation or encouragement (must)."
    ]
};

/* --- GLOBAL STATE FOR IPA --- */
let currentActiveIPA = null;

/* --- ENGINE FUNCTIONS --- */

/**
 * Renders matching exercise with two-column layout and IPA feature
 * @param {string} id - Exercise identifier (e.g., 't1', 't3')
 * @param {Array} data - Array of vocabulary items with definitions
 */
function renderMatching(id, data) {
    const v = document.getElementById(`vocab-${id}`); 
    const d = document.getElementById(`def-${id}`);
    
    v.innerHTML = '';
    d.innerHTML = '';
    
    // Display definitions in original order (A, B, C, D, E, F, G) from image
    const definitionsInOrder = [
        { letter: "A", def: "A. control or power over others" },
        { letter: "B", def: "B. to do what you are told or follow rules" },
        { letter: "C", def: "C. despite what has just been said" },
        { letter: "D", def: "D. the ability to think logically" },
        { letter: "E", def: "E. invented and not real" },
        { letter: "F", def: "F. the state of being aware and able to think" },
        { letter: "G", def: "G. failure to act when action is needed" }
    ];
    
    if (id === 't1') {
        // Task 1 definitions in order from image
        definitionsInOrder[0] = { letter: "A", def: "A. very different from something else" };
        definitionsInOrder[1] = { letter: "B", def: "B. simple but important" };
        definitionsInOrder[2] = { letter: "C", def: "C. imagined places or situations in the future, often with advanced technology" };
        definitionsInOrder[3] = { letter: "D", def: "D. much better than usual" };
        definitionsInOrder[4] = { letter: "E", def: "E. the ability to think and decide freely" };
        definitionsInOrder[5] = { letter: "F", def: "F. in a way that shows care for people's feelings" };
        definitionsInOrder[6] = { letter: "G", def: "G. the freedoms that people are allowed to have" };
    }
    
    definitionsInOrder.forEach(item => {
        const defText = item.def.replace(`${item.letter}. `, '');
        d.innerHTML += `<div class="def-item"><strong>${item.letter}.</strong> ${defText}</div>`;
    });
    
    // Render vocabulary items with IPA (in original order 1-7)
    data.forEach((item, i) => {
        const qid = `${id}-q${i}`;
        v.innerHTML += `
            <div class="vocab-item">
                <span class="vocab-text">${item.v}</span>
                <input type="text" class="letter-input" id="${qid}" data-type="input" data-ans="${item.letter}" maxlength="1">
                <div class="row-btns">
                    <button class="btn-small" onclick="showSingleAns('${qid}')">üëÅÔ∏è</button>
                    <button class="btn-small speaker-btn" onclick="toggleIPA('${qid}')">üîä</button>
                    <button class="info-btn" onclick="toggleHint('${qid}')">i</button>
                </div>
                <div class="hint-box" id="${qid}-hint">üí° ${item.hint}</div>
                <div class="ipa-box" id="${qid}-ipa">
                    <span class="ipa-label">Pronunciation:</span>
                    <span class="ipa-text">${item.ipa || 'Not available'}</span>
                </div>
            </div>`;
    });
}

/**
 * Renders gap-fill exercise with automatic Word Bank generation
 * @param {string} id - Exercise identifier (e.g., 't2', 't4')
 * @param {Array} data - Array of questions with answers
 * @param {string} bankId - ID of the Word Bank container
 */
function renderGapFill(id, data, bankId) {
    const container = document.getElementById(`questions-${id}`);
    const bank = document.getElementById(bankId);
    
    container.innerHTML = '';
    bank.innerHTML = '';
    
    // Generate Word Bank from unique answers
    const words = [...new Set(data.map(item => item.ans))].sort();
    words.forEach(w => {
        bank.innerHTML += `<div class="word-item" draggable="true" ondragstart="drag(event)" onclick="clickSelect(this)">${w}</div>`;
    });
    
    // Render questions with input fields
    data.forEach((it, i) => {
        const qid = `${id}-q${i}`;
        let html = it.q.replace('[INPUT]', `<input type="text" id="${qid}" data-type="input" data-ans="${it.ans}" oninput="adjustWidth(this)" ondrop="drop(event)" ondragover="allowDrop(event)">`);
        container.innerHTML += `
            <div class="question-row">
                ${html}
                <div class="row-btns">
                    <button class="btn-small" onclick="showSingleAns('${qid}')">üëÅÔ∏è</button>
                    <button class="info-btn" onclick="toggleHint('${qid}')">i</button>
                </div>
                <div class="hint-box" id="${qid}-hint">üí° ${it.hint}</div>
            </div>`;
    });
}

/**
 * Renders grammar exercise (Task 5) with improved formatting
 */
function renderGrammar() {
    const container = document.getElementById('questions-t5');
    container.innerHTML = '';
    
    t5_data.forEach((it, i) => {
        const qid = `t5-q${i}`;
        container.innerHTML += `
            <div class="question-row">
                <div><strong>${it.sit}</strong></div>
                <div style="margin-top: 8px;">
                    <strong>${it.prompt}</strong> 
                    <input type="text" class="task5-input" id="${qid}" data-type="input" data-ans="${it.ans}" oninput="adjustWidth(this)">
                    <div class="row-btns">
                        <button class="btn-small" onclick="showSingleAns('${qid}')">üëÅÔ∏è</button>
                        <button class="info-btn" onclick="toggleHint('${qid}')">i</button>
                    </div>
                </div>
                <div class="hint-box" id="${qid}-hint">üí° ${it.hint}</div>
            </div>`;
    });
}

/**
 * Renders advertisement exercise (Task 6) with Word Bank
 */
function renderAdvert() {
    const container = document.getElementById('questions-t6');
    const bank = document.getElementById('bank-t6');
    
    container.innerHTML = '';
    bank.innerHTML = '';
    
    // Generate Word Bank with duplicates for 'must'
    t6_data.words.forEach((w, i) => { 
        const count = t6_data.words.filter(word => word === w).length;
        const displayText = count > 1 ? `${w} (√ó${count})` : w;
        bank.innerHTML += `<div class="word-item" draggable="true" ondragstart="drag(event)" onclick="clickSelect(this)">${displayText}</div>`; 
    });
    
    // Render text with input fields
    let html = t6_data.text;
    t6_data.ans.forEach((ans, i) => {
        const qid = `t6-q${i}`;
        const inputField = `<input type="text" id="${qid}" data-type="input" data-ans="${ans}" oninput="adjustWidth(this)" ondrop="drop(event)" ondragover="allowDrop(event)">`;
        html = html.replace('[INPUT]', 
            `${inputField}
             <div class="row-btns">
                 <button class="btn-small" onclick="showSingleAns('${qid}')">üëÅÔ∏è</button>
                 <button class="info-btn" onclick="toggleHint('${qid}')">i</button>
             </div>
             <div class="hint-box" id="${qid}-hint">üí° ${t6_data.hints[i]}</div>`);
    });
    container.innerHTML = html;
}

/**
 * Adjusts input width based on content
 * @param {HTMLElement} el - Input element
 */
function adjustWidth(el) { 
    if(!el.classList.contains('letter-input')) {
        const baseWidth = el.classList.contains('task5-input') ? 300 : 120;
        const newWidth = Math.max(el.value.length * 8 + 20, baseWidth);
        el.style.width = Math.min(newWidth, 600) + "px";
    }
}

/**
 * Toggles hint box visibility
 * @param {string} id - Question ID
 */
function toggleHint(id) { 
    const h = document.getElementById(id + '-hint'); 
    const infoBtn = document.querySelector(`button[onclick="toggleHint('${id}')"]`);
    
    if (h) {
        if (h.style.display === 'block') {
            h.style.display = 'none';
            if (infoBtn) infoBtn.classList.remove('active');
        } else {
            h.style.display = 'block';
            if (infoBtn) infoBtn.classList.add('active');
        }
    }
}

/**
 * Toggles IPA pronunciation box
 * @param {string} id - Question ID
 */
function toggleIPA(id) { 
    const ipaBox = document.getElementById(id + '-ipa'); 
    const speakerBtn = document.querySelector(`button[onclick="toggleIPA('${id}')"]`);
    
    // If clicking the same IPA box, hide it
    if (currentActiveIPA === ipaBox) {
        ipaBox.style.display = 'none';
        currentActiveIPA = null;
        if (speakerBtn) speakerBtn.classList.remove('active');
        return;
    }
    
    // Hide any currently active IPA box
    if (currentActiveIPA) {
        currentActiveIPA.style.display = 'none';
        const prevSpeakerBtn = document.querySelector(`button[onclick*="${currentActiveIPA.id.replace('-ipa', '')}"]`);
        if (prevSpeakerBtn) prevSpeakerBtn.classList.remove('active');
    }
    
    // Show the clicked IPA box
    if (ipaBox) {
        ipaBox.style.display = 'block';
        currentActiveIPA = ipaBox;
        if (speakerBtn) speakerBtn.classList.add('active');
    }
}

/**
 * Shows single answer for a question
 * @param {string} id - Question ID
 */
function showSingleAns(id) { 
    const el = document.getElementById(id); 
    if (el) {
        el.value = el.dataset.ans; 
        el.classList.add('correct'); 
        el.classList.remove('incorrect-marked'); 
        adjustWidth(el); 
        updateWordBank();
    }
}

/**
 * Shows all answers for a section
 * @param {string} prefix - Section prefix (e.g., 't1', 't2')
 */
function showAnswers(prefix) { 
    document.querySelectorAll(`input[id^="${prefix}"]`).forEach(el => showSingleAns(el.id)); 
}

/**
 * Resets a section to initial state
 * @param {string} prefix - Section prefix (e.g., 't1', 't2')
 */
function resetSection(prefix) { 
    // Reset input fields
    document.querySelectorAll(`[id^="${prefix}"]`).forEach(i => { 
        if(i.tagName === 'INPUT') { 
            i.value = ""; 
            i.classList.remove('correct', 'incorrect-marked'); 
            adjustWidth(i); 
        } 
        const hBox = document.getElementById(i.id + '-hint'); 
        if(hBox) hBox.style.display = 'none'; 
        
        const ipaBox = document.getElementById(i.id + '-ipa');
        if(ipaBox) ipaBox.style.display = 'none';
    }); 
    
    // Reset IPA state if it belongs to this section
    if (currentActiveIPA && currentActiveIPA.id.includes(prefix)) {
        const speakerBtn = document.querySelector(`button[onclick*="${currentActiveIPA.id.replace('-ipa', '')}"]`);
        if (speakerBtn) speakerBtn.classList.remove('active');
        currentActiveIPA = null;
    }
    
    // Reset button states
    document.querySelectorAll(`[id$="-info"]`).forEach(btn => {
        if (btn.id.includes(prefix)) {
            btn.classList.remove('active');
        }
    });
    
    updateWordBank(); 
}

/**
 * Checks all answers across all exercises with improved validation for Task 5
 */
function checkAll() { 
    document.querySelectorAll('[data-type="input"]').forEach(el => { 
        const ans = el.dataset.ans ? el.dataset.ans.toLowerCase().trim() : ''; 
        const val = el.value.toLowerCase().trim(); 
        el.classList.remove('correct', 'incorrect-marked'); 
        
        if(!val) return;
        
        // Special handling for Task 5 (rewrite sentences)
        if (el.id.startsWith('t5-')) {
            // Remove "I " from beginning if user included it
            const cleanVal = val.replace(/^i\s+/, '');
            const cleanAns = ans.replace(/^i\s+/, '');
            
            if (cleanVal === cleanAns) {
                el.classList.add('correct'); 
            } else {
                el.classList.add('incorrect-marked'); 
            }
        } 
        // Standard validation for other tasks
        else if (val === ans) {
            el.classList.add('correct'); 
        } else {
            el.classList.add('incorrect-marked'); 
        }
    }); 
}

/* --- DRAG & DROP FUNCTIONALITY --- */
let selectedWordEl = null;

/**
 * Allows drop event
 * @param {Event} ev - Drag event
 */
function allowDrop(ev) { 
    ev.preventDefault(); 
}

/**
 * Handles drag start event
 * @param {Event} ev - Drag event
 */
function drag(ev) { 
    ev.dataTransfer.setData("text", ev.target.innerText.replace(' (√ó2)', '')); 
    selectedWordEl = ev.target; 
}

/**
 * Handles drop event
 * @param {Event} ev - Drop event
 */
function drop(ev) { 
    ev.preventDefault(); 
    const data = ev.dataTransfer.getData("text"); 
    ev.target.value = data; 
    adjustWidth(ev.target); 
    updateWordBank(); 
}

/**
 * Handles click selection from Word Bank
 * @param {HTMLElement} el - Word Bank item
 */
function clickSelect(el) { 
    if(selectedWordEl) selectedWordEl.style.background = "#eef2f7"; 
    selectedWordEl = el; 
    el.style.background = "#ffeaa7"; 
}

/**
 * Updates Word Bank display (hides used words)
 */
function updateWordBank() { 
    const inputs = Array.from(document.querySelectorAll('input[data-type="input"]'))
        .map(i => i.value.toLowerCase().trim()); 
    
    document.querySelectorAll('.word-item').forEach(item => { 
        const word = item.innerText.toLowerCase().replace(' (√ó2)', '').trim(); 
        const usedCount = inputs.filter(v => v === word).length; 
        const totalCount = item.innerText.includes('√ó2') ? 2 : 1; 
        
        if(usedCount >= totalCount) {
            item.classList.add('used'); 
        } else {
            item.classList.remove('used'); 
        }
    }); 
}

/* --- INITIALIZATION --- */
window.onload = () => {
    // Render all exercises
    renderMatching('t1', t1_data);
    renderGapFill('t2', t2_data, 'bank-t2');
    renderMatching('t3', t3_data);
    renderGapFill('t4', t4_data, 'bank-t4');
    renderGrammar();
    renderAdvert();
    
    // Add click listener for Word Bank selection
    document.addEventListener('click', (e) => { 
        if(e.target.tagName === 'INPUT' && selectedWordEl) { 
            const word = selectedWordEl.innerText.replace(' (√ó2)', '');
            e.target.value = word; 
            adjustWidth(e.target); 
            selectedWordEl.style.background = "#eef2f7"; 
            selectedWordEl = null; 
            updateWordBank(); 
        } 
    });
};

/* --- KEYBOARD SUPPORT --- */
document.addEventListener('keydown', e => { 
    if(e.key === 'Enter') checkAll(); 
});
</script>
</body>
</html>