<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Access 4 - Review Final (Module 8-10)</title>
    <style>
        :root {
            --primary: #2980b9; 
            --primary-dark: #1c5982; 
            --success: #27ae60;
            --error: #e74c3c; 
            --warning: #f1c40f; 
            --bg: #f4f7f9;
            --text: #2c3e50; 
            --card: #ffffff;
            --selection: #3498db;
            --selection-bg: #ebf5fb;
            --grammar-bg: #f0f7ff;
            --vocab-bg: #f9f7ff;
            --highlight-light: #fff2cc;
        }
        
        body { 
            font-family: 'Times New Roman', serif; 
            font-size: 13pt; 
            background-color: var(--bg); 
            color: var(--text); 
            margin: 0; 
            padding: 20px 20px 150px 20px;
            line-height: 1.6; 
        }
        
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
        }
        
        .main-title {
            text-align: center;
            color: var(--primary-dark);
            margin-bottom: 30px;
            font-size: 2em;
            padding-bottom: 15px;
            border-bottom: 3px solid var(--primary);
        }
        
        .shuffle-note {
            text-align: center;
            background: var(--warning);
            color: #000;
            padding: 8px;
            border-radius: 20px;
            font-size: 0.9em;
            margin-bottom: 20px;
            font-weight: bold;
        }
        
        .reference-section {
            background-color: var(--grammar-bg);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
            border-left: 6px solid var(--primary);
        }
        
        .reference-title {
            font-weight: bold;
            font-size: 1.4em;
            margin-bottom: 20px;
            color: var(--primary-dark);
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
        }
        
        .expand-toggle {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 12px;
            cursor: pointer;
            font-size: 0.8em;
        }
        
        .grammar-group {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid #e1e8ed;
            transition: all 0.3s ease;
            overflow: hidden;
        }
        
        .grammar-group.collapsed {
            max-height: 60px;
            overflow: hidden;
        }
        
        .grammar-group.expanded {
            max-height: 1000px;
        }
        
        .grammar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            cursor: pointer;
        }
        
        .grammar-subtitle {
            font-weight: bold;
            font-size: 1.2em;
            color: var(--primary);
            margin: 0;
        }
        
        .group-toggle {
            background: none;
            border: none;
            font-size: 1.2em;
            cursor: pointer;
            color: var(--primary);
        }
        
        .grammar-details {
            padding-left: 20px;
            border-left: 2px solid #e1e8ed;
            margin: 10px 0;
            transition: all 0.3s ease;
        }
        
        .grammar-group.collapsed .grammar-details {
            opacity: 0;
            height: 0;
            overflow: hidden;
            margin: 0;
            padding: 0;
        }
        
        .grammar-group.expanded .grammar-details {
            opacity: 1;
            height: auto;
        }
        
        .detail-item {
            margin-bottom: 8px;
            padding: 5px 0;
        }
        
        .detail-title {
            font-weight: bold;
            color: var(--primary-dark);
        }
        
        .reference-note {
            font-size: 0.85em;
            color: #7f8c8d;
            margin-top: 8px;
            font-style: italic;
        }
        
        .vocab-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            background-color: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        .vocab-table th {
            background-color: var(--primary);
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: bold;
        }
        
        .vocab-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #eee;
        }
        
        .vocab-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        .phonetic {
            font-family: 'Arial', sans-serif;
            color: #666;
            font-size: 0.9em;
        }
        
        .meaning {
            color: #2c3e50;
        }
        
        .vietnamese-meaning {
            color: #e67e22;
            font-style: italic;
        }
        
        .topic-title {
            background-color: var(--vocab-bg);
            padding: 12px 15px;
            border-radius: 8px;
            margin: 20px 0 15px 0;
            font-weight: bold;
            color: var(--primary-dark);
            border-left: 4px solid #9b59b6;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }
        
        .topic-content {
            transition: all 0.3s ease;
            overflow: hidden;
        }
        
        .topic-content.collapsed {
            max-height: 0;
            opacity: 0;
            overflow: hidden;
        }
        
        .topic-content.expanded {
            max-height: 1000px;
            opacity: 1;
        }
        
        .sticky-bank { 
            position: sticky; 
            top: 15px; 
            z-index: 100;
            background-color: #fff; 
            padding: 15px; 
            border-radius: 10px; 
            margin-bottom: 25px; 
            border: 2px solid var(--primary); 
            display: flex; 
            flex-wrap: wrap; 
            gap: 10px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
        }
        
        .word-item { 
            background: #eef2f7; 
            border: 1px solid var(--primary); 
            color: var(--primary-dark); 
            padding: 6px 12px; 
            border-radius: 5px; 
            cursor: grab; 
            user-select: none; 
            transition: 0.2s; 
            font-size: 0.9em; 
            font-weight: 500;
        }
        
        .word-item.used { 
            display: none !important;
        }
        
        .word-item:hover:not(.used) { 
            background: var(--primary); 
            color: white; 
        }

        .exercise-card { 
            background: var(--card); 
            border-radius: 12px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); 
            padding: 25px; 
            margin-bottom: 30px; 
        }
        
        .exercise-title { 
            font-weight: bold; 
            font-size: 1.25em; 
            margin-bottom: 18px; 
            color: var(--primary-dark); 
            border-bottom: 2px solid #eee; 
            padding-bottom: 8px; 
        }
        
        .matching-grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 30px; 
            margin-top: 10px; 
        }
        
        .vocab-item { 
            margin-bottom: 12px; 
            display: flex; 
            align-items: center; 
            gap: 10px; 
        }
        
        .vocab-text { 
            min-width: 150px; 
            font-weight: 500; 
        }
        
        .question-row { 
            margin-bottom: 18px; 
            line-height: 2.2; 
            border-bottom: 1px solid #f9f9f9; 
            padding-bottom: 10px; 
            position: relative; 
        }
        
        input[type="text"] { 
            border: none; 
            border-bottom: 2px solid #bdc3c7; 
            background: #fafafa; 
            padding: 2px 8px; 
            font-size: 1em; 
            transition: 0.2s; 
            outline: none;
            min-width: 60px; 
            border-radius: 4px 4px 0 0; 
            text-align: center; 
            font-family: 'Times New Roman';
            box-sizing: border-box;
        }
        
        input.letter-input { 
            width: 45px; 
            min-width: 45px; 
            max-width: 80px;
            text-transform: uppercase; 
            font-weight: bold; 
            color: var(--primary-dark); 
        }
        
        input.word-input { 
            min-width: 120px; 
            max-width: 400px;
            text-align: left; 
        }
        
        input.correct { 
            border-bottom-color: var(--success) !important; 
            background-color: #e8f8f5 !important; 
            color: #1e8449 !important; 
        }
        
        input.incorrect-marked { 
            border-bottom-color: var(--error) !important; 
            background-color: #fdedec !important; 
        }

        .row-btns { 
            display: inline-flex; 
            gap: 5px; 
            vertical-align: middle; 
            margin-left: 10px; 
        }
        
        .btn-small { 
            background: #eee; 
            border: 1px solid #ccc; 
            border-radius: 4px; 
            width: 28px; 
            height: 28px; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 14px; 
            transition: 0.2s;
        }
        
        .btn-small:hover {
            background: #ddd;
        }
        
        .btn-small.active {
            background: #3498db;
            color: white;
            border-color: #2980b9;
        }
        
        .info-btn { 
            background: #95a5a6; 
            color: white; 
            border: none; 
            border-radius: 50%; 
            width: 20px; 
            height: 20px; 
            font-size: 11px; 
            cursor: pointer; 
            display: inline-flex; 
            align-items: center; 
            justify-content: center; 
            transition: 0.2s;
        }
        
        .info-btn:hover {
            background: #7f8c8d;
        }
        
        .info-btn.active {
            background: #5d6d6e;
        }
        
        .hint-box { 
            display: none; 
            margin-top: 8px; 
            padding: 10px; 
            background-color: #fef9e7; 
            border-left: 4px solid var(--warning); 
            color: #7d6608; 
            border-radius: 4px; 
            font-size: 0.85em; 
        }
        
        .controls-row { 
            display: flex; 
            justify-content: flex-end; 
            gap: 10px; 
            margin-top: 15px; 
        }
        
        .btn { 
            padding: 8px 20px; 
            border-radius: 6px; 
            cursor: pointer; 
            border: none; 
            font-weight: bold; 
            transition: 0.3s; 
        }
        
        .btn-reset { 
            background: #95a5a6; 
            color: white; 
        }
        
        .btn-show-all { 
            background: var(--primary); 
            color: white; 
        }
        
        .check-all-btn { 
            position: fixed; 
            right: 45px;
            bottom: 30px; 
            background-color: var(--success); 
            color: white; 
            padding: 15px 30px; 
            border-radius: 50px; 
            cursor: pointer; 
            z-index: 10000;
            font-weight: bold; 
            border: none; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.2); 
        }
        
        .instructions {
            color: #7f8c8d;
            font-size: 0.95em;
            margin-bottom: 15px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }
        
        .option-container {
            display: inline-flex;
            gap: 10px;
            margin-left: 10px;
            margin-right: 10px;
            flex-wrap: wrap;
        }
        
        .option-btn {
            background: #eef2f7;
            border: 2px solid #bdc3c7;
            border-radius: 6px;
            padding: 6px 15px;
            cursor: pointer;
            font-weight: 500;
            transition: 0.2s;
            min-width: 80px;
            text-align: center;
            font-size: 0.9em;
        }
        
        .option-btn:hover {
            background: #dfe6f0;
            border-color: #95a5a6;
        }
        
        .option-btn.selected {
            background: #3498db;
            color: white;
            border-color: #2980b9;
        }
        
        .option-btn.correct-option {
            background: #27ae60;
            color: white;
            border-color: #219653;
        }
        
        .option-btn.incorrect-option {
            background: #e74c3c;
            color: white;
            border-color: #c0392b;
        }
        
        .bold-option {
            font-weight: bold;
            color: var(--primary-dark);
        }
        
        .reading-container {
            display: flex;
            margin: 20px 0;
            position: relative;
            min-height: 500px;
            height: 600px;
        }
        
        .text-panel, .questions-panel {
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            border: 1px solid #e9ecef;
            overflow-y: auto;
            position: relative;
            height: 100%;
            flex: 1;
        }
        
        .text-panel {
            margin-right: 0;
            border-top-right-radius: 0;
            border-bottom-right-radius: 0;
        }
        
        .questions-panel {
            margin-left: 0;
            border-top-left-radius: 0;
            border-bottom-left-radius: 0;
        }
        
        .text-panel h3, .questions-panel h3 {
            margin-top: 0;
            color: var(--primary-dark);
            text-align: center;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        
        .reading-text {
            line-height: 1.8;
            text-align: justify;
            user-select: text;
        }
        
        .reading-text p {
            margin-bottom: 15px;
        }
        
        .highlighted-text {
            background-color: var(--highlight-light) !important;
            padding: 0 2px;
            border-radius: 2px;
            color: inherit !important;
            display: inline;
        }
        
        .hint-highlight {
            background-color: var(--highlight-light) !important;
            transition: background-color 0.2s;
        }
        
        .context-menu {
            position: absolute;
            background: white;
            border: 1px solid #ccc;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            padding: 6px 0;
            z-index: 20000;
            display: none;
        }
        
        .context-menu div {
            padding: 8px 24px;
            cursor: pointer;
            font-size: 13px;
        }
        
        .context-menu div:hover {
            background-color: #f0f0f0;
        }
        
        .mcq-question {
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .mcq-question p {
            margin-bottom: 12px;
            font-weight: 500;
            font-size: 1.05em;
        }
        
        .mcq-options-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .mcq-option {
            margin-bottom: 8px;
            padding: 8px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            background-color: #f9f9f9;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
        }
        
        .mcq-option:hover {
            background-color: #f0f0f0;
            border-color: #bdc3c7;
        }
        
        .mcq-option.selected {
            background-color: #e3f2fd;
            border-color: #3498db;
        }
        
        .mcq-option.correct {
            background-color: #d4edda;
            border-color: #27ae60;
            color: #155724;
        }
        
        .mcq-option.incorrect {
            background-color: #f8d7da;
            border-color: #e74c3c;
            color: #721c24;
        }
        
        .mcq-option input {
            margin-right: 10px;
        }
        
        .option-letter {
            display: inline-block;
            width: 24px;
            height: 24px;
            line-height: 24px;
            text-align: center;
            background-color: #3498db;
            color: white;
            border-radius: 50%;
            margin-right: 10px;
            font-weight: bold;
        }
        
        .resizer {
            position: relative;
            width: 10px;
            background-color: #ddd;
            cursor: col-resize;
            z-index: 10;
            flex-shrink: 0;
            margin: 0;
        }
        
        .resizer:hover {
            background-color: #3498db;
        }
        
        .resizer::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 2px;
            height: 40px;
            background-color: #95a5a6;
            border-radius: 1px;
        }
        
        .definitions-column {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            height: 500px;
            overflow-y: auto;
        }
        
        .definition-item {
            margin-bottom: 12px;
            padding: 8px;
            border-bottom: 1px solid #eee;
            background-color: white;
            border-radius: 4px;
            min-height: 40px;
        }
        
        .definition-letter {
            font-weight: bold;
            color: var(--primary);
            margin-right: 10px;
            min-width: 20px;
            display: inline-block;
        }
        
        .definition-text {
            display: inline;
        }
        
        .reading-controls-panel {
            margin-top: 30px;
            padding: 20px;
            background-color: #f0f7ff;
            border-radius: 8px;
            border: 1px solid #d4e3f0;
            display: flex;
            justify-content: flex-end;
            gap: 15px;
        }
        
        @media (max-width: 768px) {
            .check-all-btn {
                right: 15px;
                bottom: 20px;
                padding: 12px 20px;
                font-size: 0.9em;
            }
            
            body {
                padding: 15px 15px 120px 15px;
            }
            
            .mcq-options-container {
                grid-template-columns: 1fr;
            }
            
            .reading-container {
                flex-direction: column;
                height: 800px;
            }
            
            .text-panel, .questions-panel {
                width: 100% !important;
                height: 50% !important;
                margin: 0;
                border-radius: 10px;
                margin-bottom: 10px;
            }
            
            .resizer {
                display: none;
            }
            
            .vocab-table {
                display: block;
                overflow-x: auto;
            }
            
            .matching-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .reading-controls-panel {
                flex-direction: column;
                align-items: stretch;
            }
        }
    </style>
</head>
<body>

<div class="container">
    <h1 class="main-title">Access 4 - Review Final (Module 8-10)</h1>
    
    
    <!-- Reference Section (bỏ hết icon) -->
    <div class="reference-section">
        <div class="reference-title" onclick="toggleReferenceSection()">
            Grammar & Vocabulary Reference
            <button class="expand-toggle" id="reference-toggle">+</button>
        </div>
        
        <div id="reference-content" style="display: none;">
            <!-- Grammar: Passive Voice -->
            <div class="grammar-group collapsed" id="grammar-passive">
                <div class="grammar-header" onclick="toggleGrammar('passive')">
                    <h3 class="grammar-subtitle">Passive Voice (Câu bị động)</h3>
                    <button class="group-toggle">+</button>
                </div>
                <div class="grammar-details">
                    <div class="detail-item">
                        <div class="detail-title">Cấu trúc:</div>
                        <div>be + past participle (V3/ed)</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-title">Các thì cơ bản:</div>
                        <div>- Present simple: am/is/are + V3/ed</div>
                        <div>- Past simple: was/were + V3/ed</div>
                        <div>- Present perfect: have/has been + V3/ed</div>
                        <div>- Modal verbs: must/can/should + be + V3/ed</div>
                    </div>
                </div>
                <div class="reference-note">Nguồn: Cambridge Dictionary</div>
            </div>
            
            <!-- Grammar: Reported Speech -->
            <div class="grammar-group collapsed" id="grammar-reported">
                <div class="grammar-header" onclick="toggleGrammar('reported')">
                    <h3 class="grammar-subtitle">Reported Speech (Câu tường thuật)</h3>
                    <button class="group-toggle">+</button>
                </div>
                <div class="grammar-details">
                    <div class="detail-item">
                        <div class="detail-title">Quy tắc lùi thì:</div>
                        <div>- Present simple → Past simple</div>
                        <div>- Present continuous → Past continuous</div>
                        <div>- Present perfect → Past perfect</div>
                        <div>- Past simple → Past perfect</div>
                        <div>- will → would, can → could, may → might</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-title">Thay đổi từ chỉ thời gian/nơi chốn:</div>
                        <div>now → then, today → that day, here → there, this → that</div>
                    </div>
                </div>
                <div class="reference-note">Nguồn: Oxford English Grammar</div>
            </div>
            
            <!-- Grammar: Introductory Verbs -->
            <div class="grammar-group collapsed" id="grammar-intro">
                <div class="grammar-header" onclick="toggleGrammar('intro')">
                    <h3 class="grammar-subtitle">Introductory Verbs (Động từ giới thiệu)</h3>
                    <button class="group-toggle">+</button>
                </div>
                <div class="grammar-details">
                    <div class="detail-item">
                        <div class="detail-title">Verb + to-infinitive:</div>
                        <div>agree, demand, offer, promise, refuse, threaten</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-title">Verb + object + to-infinitive:</div>
                        <div>advise, allow, ask, beg, encourage, remind</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-title">Verb + -ing:</div>
                        <div>admit, apologise for, insist on, suggest</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-title">Verb + that-clause:</div>
                        <div>admit, complain, explain, say, suggest</div>
                    </div>
                </div>
                <div class="reference-note">Nguồn: Advanced Grammar in Use - Cambridge</div>
            </div>
            
            <!-- Grammar: Relative Pronouns -->
            <div class="grammar-group collapsed" id="grammar-relative">
                <div class="grammar-header" onclick="toggleGrammar('relative')">
                    <h3 class="grammar-subtitle">Relative Pronouns (Đại từ quan hệ)</h3>
                    <button class="group-toggle">+</button>
                </div>
                <div class="grammar-details">
                    <div class="detail-item">
                        <div class="detail-title">who:</div>
                        <div>Chỉ người</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-title">which:</div>
                        <div>Chỉ vật</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-title">whose:</div>
                        <div>Chỉ sở hữu</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-title">where:</div>
                        <div>Chỉ nơi chốn</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-title">when:</div>
                        <div>Chỉ thời gian</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-title">why:</div>
                        <div>Chỉ lý do</div>
                    </div>
                </div>
                <div class="reference-note">Nguồn: Cambridge Dictionary</div>
            </div>
            
            <!-- Vocabulary: Art (Task 1) -->
            <div class="topic-title" onclick="toggleTopic('art')">
                Vocabulary: Art (Task 1)
                <span class="group-toggle">+</span>
            </div>
            <div class="topic-content collapsed" id="topic-art">
                <table class="vocab-table">
                    <thead>
                        <tr>
                            <th>Vocabulary</th>
                            <th>Phonetic</th>
                            <th>Vietnamese Meaning</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td>inspired</td><td class="phonetic">/ɪnˈspaɪərd/</td><td class="vietnamese-meaning">đầy cảm hứng</td></tr>
                        <tr><td>transform</td><td class="phonetic">/trænsˈfɔːrm/</td><td class="vietnamese-meaning">biến đổi, thay đổi</td></tr>
                        <tr><td>character</td><td class="phonetic">/ˈkærəktər/</td><td class="vietnamese-meaning">tính cách, nhân vật</td></tr>
                        <tr><td>adapt</td><td class="phonetic">/əˈdæpt/</td><td class="vietnamese-meaning">chuyển thể, thích nghi</td></tr>
                        <tr><td>figure</td><td class="phonetic">/ˈfɪɡjər/</td><td class="vietnamese-meaning">nhân vật quan trọng</td></tr>
                        <tr><td>combines</td><td class="phonetic">/kəmˈbaɪnz/</td><td class="vietnamese-meaning">kết hợp</td></tr>
                    </tbody>
                </table>
            </div>
            
            <!-- Vocabulary: History (Task 2) -->
            <div class="topic-title" onclick="toggleTopic('history')">
                Vocabulary: History (Task 2)
                <span class="group-toggle">+</span>
            </div>
            <div class="topic-content collapsed" id="topic-history">
                <table class="vocab-table">
                    <thead>
                        <tr>
                            <th>Vocabulary</th>
                            <th>Phonetic</th>
                            <th>Vietnamese Meaning</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td>evolve</td><td class="phonetic">/ɪˈvɒlv/</td><td class="vietnamese-meaning">tiến hóa</td></tr>
                        <tr><td>scatter</td><td class="phonetic">/ˈskætər/</td><td class="vietnamese-meaning">phân tán</td></tr>
                        <tr><td>stunning</td><td class="phonetic">/ˈstʌnɪŋ/</td><td class="vietnamese-meaning">ngoan mục</td></tr>
                        <tr><td>dawn</td><td class="phonetic">/dɔːn/</td><td class="vietnamese-meaning">bình minh</td></tr>
                        <tr><td>conquer</td><td class="phonetic">/ˈkɒŋkər/</td><td class="vietnamese-meaning">chinh phục</td></tr>
                        <tr><td>perceive</td><td class="phonetic">/pərˈsiːv/</td><td class="vietnamese-meaning">nhận thức</td></tr>
                        <tr><td>goal</td><td class="phonetic">/ɡoʊl/</td><td class="vietnamese-meaning">mục tiêu</td></tr>
                        <tr><td>flood</td><td class="phonetic">/flʌd/</td><td class="vietnamese-meaning">lũ lụt</td></tr>
                        <tr><td>drought</td><td class="phonetic">/draʊt/</td><td class="vietnamese-meaning">hạn hán</td></tr>
                        <tr><td>set standards</td><td class="phonetic">/set ˈstændərdz/</td><td class="vietnamese-meaning">đặt tiêu chuẩn</td></tr>
                    </tbody>
                </table>
            </div>
            
            <!-- Vocabulary: Cultural Exchanges (Task 3-4) -->
            <div class="topic-title" onclick="toggleTopic('cultural')">
                Vocabulary: Cultural Exchanges (Task 3-4)
                <span class="group-toggle">+</span>
            </div>
            <div class="topic-content collapsed" id="topic-cultural">
                <table class="vocab-table">
                    <thead>
                        <tr>
                            <th>Vocabulary</th>
                            <th>Phonetic</th>
                            <th>Vietnamese Meaning</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td>occurs</td><td class="phonetic">/əˈkɜːrz/</td><td class="vietnamese-meaning">xảy ra</td></tr>
                        <tr><td>participate</td><td class="phonetic">/pɑːrˈtɪsɪpeɪt/</td><td class="vietnamese-meaning">tham gia</td></tr>
                        <tr><td>surface</td><td class="phonetic">/ˈsɜːrfɪs/</td><td class="vietnamese-meaning">bề mặt</td></tr>
                        <tr><td>outstanding</td><td class="phonetic">/aʊtˈstændɪŋ/</td><td class="vietnamese-meaning">nổi bật</td></tr>
                        <tr><td>vary</td><td class="phonetic">/ˈveri/</td><td class="vietnamese-meaning">thay đổi</td></tr>
                        <tr><td>long-term</td><td class="phonetic">/ˌlɔːŋ ˈtɜːrm/</td><td class="vietnamese-meaning">dài hạn</td></tr>
                        <tr><td>cultural</td><td class="phonetic">/ˈkʌltʃərəl/</td><td class="vietnamese-meaning">văn hóa</td></tr>
                        <tr><td>inhabitants</td><td class="phonetic">/ɪnˈhæbɪtənts/</td><td class="vietnamese-meaning">cư dân</td></tr>
                        <tr><td>absence</td><td class="phonetic">/ˈæbsəns/</td><td class="vietnamese-meaning">sự vắng mặt</td></tr>
                        <tr><td>conserve</td><td class="phonetic">/kənˈsɜːrv/</td><td class="vietnamese-meaning">bảo tồn</td></tr>
                        <tr><td>thrilling</td><td class="phonetic">/ˈθrɪlɪŋ/</td><td class="vietnamese-meaning">hồi hộp</td></tr>
                        <tr><td>spin</td><td class="phonetic">/spɪn/</td><td class="vietnamese-meaning">quay tròn</td></tr>
                        <tr><td>parade</td><td class="phonetic">/pəˈreɪd/</td><td class="vietnamese-meaning">diễu hành</td></tr>
                        <tr><td>wandering</td><td class="phonetic">/ˈwɑːndərɪŋ/</td><td class="vietnamese-meaning">lang thang</td></tr>
                        <tr><td>collision</td><td class="phonetic">/kəˈlɪʒən/</td><td class="vietnamese-meaning">va chạm</td></tr>
                        <tr><td>remain</td><td class="phonetic">/rɪˈmeɪn/</td><td class="vietnamese-meaning">vẫn còn</td></tr>
                        <tr><td>sth is not sb's cup oftea</td><td class="phonetic">//</td><td class="vietnamese-meaning">thứ gì đó không phải là thứ ưa thích của ai đó</td></tr>
                        <tr><td>extinction</td><td class="phonetic">/ɪkˈstɪŋkʃən/</td><td class="vietnamese-meaning">tuyệt chủng</td></tr>
                        <tr><td>tour</td><td class="phonetic">/tʊr/</td><td class="vietnamese-meaning">tham quan</td></tr>
                        <tr><td>lie</td><td class="phonetic">/laɪ/</td><td class="vietnamese-meaning">nằm</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Task 1: Matching – Vocabulary & Definitions -->
    <div class="exercise-card">
        <div class="exercise-title">Task 1: Matching – Vocabulary & Definitions</div>
        
        <div class="instructions">Match each word with its correct definition. Write the letter in the box.</div>
        
        <div class="matching-grid">
            <div id="vocab-t1"></div>
            <div class="definitions-column" id="def-t1"></div>
        </div>
        <div class="controls-row">
            <button class="btn btn-show-all" onclick="showAnswers('t1')">Show All</button>
            <button class="btn btn-reset" onclick="resetSection('t1')">Reset</button>
        </div>
    </div>
    
    <!-- Task 2: Choose the correct answer -->
    <div class="exercise-card">
        <div class="exercise-title">Task 2: Choose the correct answer</div>
        
        <div class="instructions">Select the correct word to complete each sentence.</div>
        
        <div id="questions-t2"></div>
        <div class="controls-row">
            <button class="btn btn-show-all" onclick="showAnswers('t2')">Show All</button>
            <button class="btn btn-reset" onclick="resetSection('t2')">Reset</button>
        </div>
    </div>
    
    <!-- Task 3: Fill in the blanks (Word Bank A) -->
    <div class="exercise-card">
        <div class="exercise-title">Task 3: Fill in the blanks (Word Bank A)</div>
        
        <div class="instructions">Complete the sentences using words from the bank. Two words are extra.</div>
        
        <div class="sticky-bank" id="bank-t3"></div>
        
        <div id="questions-t3"></div>
        <div class="controls-row">
            <button class="btn btn-show-all" onclick="showAnswers('t3')">Show All</button>
            <button class="btn btn-reset" onclick="resetSection('t3')">Reset</button>
        </div>
    </div>
    
    <!-- Task 4: Fill in the blanks (Word Bank B) -->
    <div class="exercise-card">
        <div class="exercise-title">Task 4: Fill in the blanks (Word Bank B)</div>
        
        <div class="instructions">Complete the sentences using words from the bank. Two words are extra.</div>
        
        <div class="sticky-bank" id="bank-t4"></div>
        
        <div id="questions-t4"></div>
        <div class="controls-row">
            <button class="btn btn-show-all" onclick="showAnswers('t4')">Show All</button>
            <button class="btn btn-reset" onclick="resetSection('t4')">Reset</button>
        </div>
    </div>
    
    <!-- Task 5: Passive Voice -->
    <div class="exercise-card">
        <div class="exercise-title">Task 5: Passive Voice – Fill in the correct form</div>
        
        <div class="instructions">Complete the sentences using the correct passive form of the verbs in parentheses.</div>
        
        <div id="questions-t5"></div>
        <div class="controls-row">
            <button class="btn btn-show-all" onclick="showAnswers('t5')">Show All</button>
            <button class="btn btn-reset" onclick="resetSection('t5')">Reset</button>
        </div>
    </div>
    
    <!-- Task 6: Reported Speech -->
    <div class="exercise-card">
        <div class="exercise-title">Task 6: Reported Speech – Rewrite the sentences</div>
        
        <div class="instructions">Complete the reported speech sentences.</div>
        
        <div id="questions-t6"></div>
        <div class="controls-row">
            <button class="btn btn-show-all" onclick="showAnswers('t6')">Show All</button>
            <button class="btn btn-reset" onclick="resetSection('t6')">Reset</button>
        </div>
    </div>
    
    <!-- Task 7: Relative Pronouns -->
    <div class="exercise-card">
        <div class="exercise-title">Task 7: Relative Pronouns – who, which, whose, where, when, why</div>
        
        <div class="instructions">Complete the sentences with the correct relative pronoun.</div>
        
        <div id="questions-t7"></div>
        <div class="controls-row">
            <button class="btn btn-show-all" onclick="showAnswers('t7')">Show All</button>
            <button class="btn btn-reset" onclick="resetSection('t7')">Reset</button>
        </div>
    </div>
    
    <!-- Task 8: Verb Forms (Introductory Verbs) -->
    <div class="exercise-card">
        <div class="exercise-title">Task 8: Verb Forms – Complete with correct form</div>
        
        <div class="instructions">Complete the sentences using the correct form of the verb in brackets.</div>
        
        <div id="questions-t8"></div>
        <div class="controls-row">
            <button class="btn btn-show-all" onclick="showAnswers('t8')">Show All</button>
            <button class="btn btn-reset" onclick="resetSection('t8')">Reset</button>
        </div>
    </div>
    
    <!-- Task 9: Reading Comprehension -->
    <div class="exercise-card">
        <div class="exercise-title">Task 9: Reading Comprehension – A Day in the Life of a Photographer</div>
        
        <div class="instructions">
            Read the text and answer the questions below. You can right-click on the text to highlight important parts.
        </div>
        
        <div class="reading-container" id="reading-t9">
            <div class="text-panel" id="text-panel-t9">
                <h3>A Day in the Life of a Photographer</h3>
                <div class="reading-text" id="reading-text-t9">
                    <p id="p1">As a freelance photographer, I spend most of my time moving between different locations, so I rarely stay in my home studio for long. When I start my day, I check my schedule and pack my equipment carefully because forgetting even a small item can ruin a whole photoshoot. My studio is small but practical, with all my lenses and lights stored in labeled boxes. I like to begin with a cup of strong coffee while reviewing the ideas for the day's projects. Sometimes I put on soft jazz music in the background because it helps me stay focused and relaxed.</p>
                    <p id="p2">I'm currently working on a travel project in Barcelona, which means I have to walk long distances every day. Normally, I travel to new cities three or four times a month, depending on the assignments I get. Back home in London, my lunch is usually quick because I'm often in the middle of editing photos. Around 2 pm, I always take a short break to read something unrelated to photography—usually history or short fiction. It keeps my mind fresh. I don't go out very often during the week because I'm usually exhausted, but on weekends I like trying new cafes or wandering around art galleries to find inspiration.</p>
                    <p id="p3">At the end of the day, I upload all my photos and back them up on two different hard drives. Then I watch a short film or a documentary to unwind. By 10:30 pm, I'm usually in bed. I keep a notebook on my desk, and before I sleep, I often write down ideas for future shoots. Creativity comes at unexpected times, so I need to be prepared to capture it whenever it appears.</p>
                </div>
            </div>
            
            <div class="resizer" id="resizer-t9"></div>
            
            <div class="questions-panel" id="questions-panel-t9">
                <h3>Questions</h3>
                <div id="reading-questions-t9"></div>
            </div>
        </div>
        
        <!-- Panel riêng cho nút Show All và Reset của bài đọc (giống code thứ 2) -->
        <div class="reading-controls-panel">
            <button class="btn btn-show-all" onclick="showAnswers('t9')">Show All Answers</button>
            <button class="btn btn-reset" onclick="resetSection('t9')">Reset All</button>
        </div>
    </div>
</div>

<button class="check-all-btn" onclick="checkAll()">CHECK ALL ANSWERS (ENTER)</button>

<!-- Custom context menu for highlighting -->
<div class="context-menu" id="context-menu">
    <div id="highlight-text">Highlight Text</div>
    <div id="remove-highlight">Remove Highlight</div>
    <div id="clear-highlights">Clear All Highlights</div>
</div>

<script>
    // ==================== TASK 1 DATA ====================
    const t1_data = [
        { v: "inspired", letter: "D", def: "full of creative energy or motivation, often because of someone else's work", hint: "She felt inspired after visiting the art museum." },
        { v: "transform", letter: "A", def: "to change something completely so that it becomes different or improved", hint: "The renovation will transform the old house." },
        { v: "character", letter: "E", def: "the qualities or features that make a place, thing, or performance interesting", hint: "The town has a lot of character." },
        { v: "adapt", letter: "C", def: "to change a book, play, or story so it can be made into a film or another form", hint: "They adapted the novel into a movie." },
        { v: "figure", letter: "B", def: "a person, usually important or well-known, in a particular field such as film, art, or writing", hint: "A key figure in the art world." },
        { v: "combines", letter: "F", def: "to mix or bring different things together", hint: "Her work combines photography and painting." }
    ];

    // ==================== TASK 2 DATA ====================
    const t2_data_original = [
        { q: "Many years ago, some animals lived on land before they <span class='bold-option'>scattered</span> / <span class='bold-option'>evolved</span> and began living in the sea.", ans: "evolved", options: ["scattered", "evolved"], hint: "Developed gradually over time." },
        { q: "The children had never seen a shooting star before, so they thought it was a <span class='bold-option'>stunning</span> / <span class='bold-option'>cruel</span> thing to see.", ans: "stunning", options: ["stunning", "cruel"], hint: "Extremely beautiful." },
        { q: "Everyone in the building was very scared when a fire suddenly broke <span class='bold-option'>up</span> / <span class='bold-option'>out</span>.", ans: "out", options: ["up", "out"], hint: "Phrasal verb: started suddenly." },
        { q: "Since the <span class='bold-option'>direction</span> / <span class='bold-option'>dawn</span> of time, people have always wanted to learn new things.", ans: "dawn", options: ["direction", "dawn"], hint: "The beginning." },
        { q: "Jane wondered if people in the past could <span class='bold-option'>conquer</span> / <span class='bold-option'>perceive</span> the idea of flying to the moon.", ans: "perceive", options: ["conquer", "perceive"], hint: "Understand." },
        { q: "Karen finished her studies, and her main <span class='bold-option'>leap</span> / <span class='bold-option'>goal</span> was to become an astronaut.", ans: "goal", options: ["leap", "goal"], hint: "Objective." },
        { q: "There was a big accident that <span class='bold-option'>blew up</span> / <span class='bold-option'>broke down</span> the back of the science room.", ans: "blew up", options: ["blew up", "broke down"], hint: "Exploded." },
        { q: "The heavy rain caused a <span class='bold-option'>flood</span> / <span class='bold-option'>drought</span> that destroyed many houses.", ans: "flood", options: ["flood", "drought"], hint: "Overflow of water." },
        { q: "People still remember the leader 'Sitting Bull' because he was <span class='bold-option'>performing</span> / <span class='bold-option'>setting</span> high standards for being brave.", ans: "setting", options: ["performing", "setting"], hint: "Establishing." }
    ];

    // ==================== TASK 3 DATA ====================
    const t3_wordBank_original = ["occurs", "participate", "surface", "outstanding", "vary", "long-term", "cultural", "inhabitants", "absence", "conserve", "thrilling"];
    const t3_data_original = [
        { q: "We had a ______ adventure when we took a fast boat trip around the rocky island.", ans: "thrilling", hint: "Exciting." },
        { q: "The teacher explained that a lunar eclipse ______ when the Earth moves between the Sun and the Moon.", ans: "occurs", hint: "Happens." },
        { q: "The local library is very quiet today because of the ______ of students during the summer break.", ans: "absence", hint: "Lack of presence." },
        { q: "If you want to be healthy, you should make a ______ plan to eat more fruit and vegetables every day.", ans: "long-term", hint: "Over a long period." },
        { q: "The small mountain town is very beautiful and only has about two hundred ______.", ans: "inhabitants", hint: "People who live there." },
        { q: "My school wants every student to ______ in the big sports competition next Friday.", ans: "participate", hint: "Take part." },
        { q: "The quality of the food at that new Italian restaurant was ______, so we want to go back again.", ans: "outstanding", hint: "Excellent." },
        { q: "The price of apples in the supermarket can ______ depending on which month you buy them.", ans: "vary", hint: "Change." },
        { q: "Be careful when you walk on the ice, because the ______ is very slippery and you might fall.", ans: "surface", hint: "Top layer." }
    ];

    // ==================== TASK 4 DATA ====================
    const t4_wordBank_original = ["spin", "parade", "wandering", "tastes", "collision", "remain", "tea", "extinction", "tour", "lie"];
    const t4_data_original = [
        { q: "We spent the whole afternoon ______ around the park and looking at the flowers.", ans: "wandering", hint: "Walking aimlessly." },
        { q: "Going to the beach is not my cup of ______; I much prefer hiking in the cold mountains.", ans: "tea", hint: "Idiom: not what I like." },
        { q: "Sadly, many types of wild tigers are now facing ______ because they have no safe place to live.", ans: "extinction", hint: "Dying out." },
        { q: "There was a big ______ between two cars on the main road, but luckily no one was hurt.", ans: "collision", hint: "Crash." },
        { q: "Our family took a guided ______ of the city to learn about the history of the old buildings.", ans: "tour", hint: "Trip with a guide." },
        { q: "The little girl was so excited to see the colorful dancers and music in the street ______.", ans: "parade", hint: "Procession." },
        { q: "Only a few stone walls ______ from the ancient castle that was built a thousand years ago.", ans: "remain", hint: "Are still there." },
        { q: "After a long day of work, I just want to ______ on the sofa and watch a funny movie.", ans: "lie", hint: "Recline." }
    ];

    // ==================== TASK 5 DATA (Passive) ====================
    const t5_data_original = [
        { q: "Tickets to the art exhibition must ______ (buy) in advance.", ans: "be bought", hint: "modal + be + past participle" },
        { q: "The classrooms ______ (clean) every morning.", ans: "are cleaned", hint: "present simple passive" },
        { q: "A new library ______ (build) last year.", ans: "was built", hint: "past simple passive" },
        { q: "The final scores ______ (announce) yesterday.", ans: "were announced", hint: "past simple passive" },
        { q: "Homework ______ (must / submit) before Friday.", ans: "must be submitted", hint: "modal passive" },
        { q: "This programme ______ (watch) by millions of people every year.", ans: "is watched", hint: "present passive" },
        { q: "The old bridge ______ (repair) in 2018.", ans: "was repaired", hint: "past passive" },
        { q: "The damaged machines ______ (should / replace) immediately.", ans: "should be replaced", hint: "modal passive" },
        { q: "The number of stolen bicycles ______ (record) by the police each month.", ans: "is recorded", hint: "present passive" }
    ];

    // ==================== TASK 6 DATA (Reported Speech) ====================
    const t6_data_original = [
        { q: "“I study English every evening,” she said. → She said that ", ans: "she studied English every evening.", hint: "present → past" },
        { q: "“He is doing his homework now,” the teacher said. → The teacher said that ", ans: "he was doing his homework then.", hint: "now → then, present continuous → past continuous" },
        { q: "“We have finished the project,” they told me. → They told me that ", ans: "they had finished the project.", hint: "present perfect → past perfect" },
        { q: "“I didn't understand the last exercise,” the student said. → The student said that ", ans: "he hadn't understood the last exercise.", hint: "past simple → past perfect" },
        { q: "“Mary is travelling to Da Nang this week,” her mother said. → Her mother said that ", ans: "Mary was travelling to Da Nang that week.", hint: "this → that" },
        { q: "“I have visited this museum,” he said. → He said that ", ans: "he had visited that museum.", hint: "this → that" },
        { q: "“We watched a great film last night,” Tom said. → Tom said that ", ans: "they had watched a great film the previous night.", hint: "last night → the previous night" },
        { q: "“The children are not listening,” the coach said. → The coach said that ", ans: "the children were not listening.", hint: "present continuous → past continuous" },
        { q: "“I will join the meeting tomorrow,” she said. → She said that ", ans: "she would join the meeting the next day.", hint: "will → would, tomorrow → the next day" }
    ];

    // ==================== TASK 7 DATA (Relative Pronouns) ====================
    const t7_data_original = [
        { q: "The woman ______ lives next door is a doctor.", ans: "who", hint: "person" },
        { q: "This is the computer ______ I bought last week.", ans: "which", hint: "thing" },
        { q: "The man ______ car was stolen went to the police station.", ans: "whose", hint: "possession" },
        { q: "Do you remember the place ______ we first met?", ans: "where", hint: "place" },
        { q: "That was the day ______ we moved into our new house.", ans: "when", hint: "time" },
        { q: "I don't understand the reason ______ he left early.", ans: "why", hint: "reason" },
        { q: "The restaurant ______ we had dinner was very crowded.", ans: "where", hint: "place" },
        { q: "The teacher ______ teaches us English is very kind.", ans: "who", hint: "person" },
        { q: "The book ______ you lent me was very interesting.", ans: "which", hint: "thing" },
        { q: "She's the girl ______ brother won the competition.", ans: "whose", hint: "possession" }
    ];

    // ==================== TASK 8 DATA (Verb Forms) ====================
    const t8_data_original = [
        { q: "Mrs. Johnson complained that her son ______ (always/leave) his science kits around the house.", ans: "was always leaving", hint: "past continuous for annoying habit" },
        { q: "Tom promised ______ (finish) the group project before Friday.", ans: "to finish", hint: "promise + to-inf" },
        { q: "The teacher reminded the students ______ (bring) their ID cards for the exam.", ans: "to bring", hint: "remind + object + to-inf" },
        { q: "Sarah apologized for ______ (interrupt) the meeting earlier.", ans: "interrupting", hint: "apologize for + -ing" },
        { q: "The manager announced that the store ______ (close) for renovation next month.", ans: "would close", hint: "reported speech: will → would" },
        { q: "The boy begged his parents ______ (let) him stay up late to watch the match.", ans: "to let", hint: "beg + to-inf" },
        { q: "Linda insisted on ______ (pay) for the meal even though everyone offered to share the cost.", ans: "paying", hint: "insist on + -ing" },
        { q: "The doctor advised Mr. Brown ______ (reduce) the amount of sugar he consumed.", ans: "to reduce", hint: "advise + to-inf" },
        { q: "My friend complained that the neighbours ______ (make) too much noise at night.", ans: "were making", hint: "past continuous" },
        { q: "Jake threatened ______ (quit) the team if no one listened to his ideas.", ans: "to quit", hint: "threaten + to-inf" }
    ];

    // ==================== TASK 9 DATA (Reading) ====================
    const t9_data = [
        { question: "In this text, the writer is describing", options: ["A. the equipment he buys every month.", "B. the things he does every day.", "C. the places he travels to for fun.", "D. his favourite kinds of music."], correct: 1, hint: "The whole text describes his daily routine.", para: "p1" },
        { question: "What does the writer say about his job?", options: ["A. It requires a lot of walking.", "B. It allows him to work very short hours.", "C. It is mostly done inside a studio.", "D. It is not very tiring."], correct: 0, hint: "He mentions walking long distances in Barcelona.", para: "p2" },
        { question: "What would a reader learn about the writer from the text?", options: ["A. He always eats lunch outside.", "B. He reads something every afternoon.", "C. He sleeps very late at night.", "D. He never works in other countries."], correct: 1, hint: "He takes a break to read at 2 pm.", para: "p2" },
        { question: "What does the writer say about his daily routine?", options: ["A. He watches films all day.", "B. He always cooks his own dinner.", "C. He backs up his work every night.", "D. He goes out with friends every evening."], correct: 2, hint: "He backs up photos at the end of the day.", para: "p3" },
        { question: "What might the writer say about where he gets his ideas?", options: ["A. “I usually get new ideas unexpectedly.”", "B. “I only feel inspired when I visit a new country.”", "C. “My best ideas come when I am editing photos.”", "D. “I don't need to write down ideas because I remember them easily.”"], correct: 0, hint: "Creativity comes at unexpected times.", para: "p3" }
    ];

    // ==================== SHUFFLE FUNCTIONS ====================
    function shuffleArray(array) {
        const shuffled = [...array];
        for (let i = shuffled.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
        }
        return shuffled;
    }

    // Tạo các biến shuffled
    const t2_data = shuffleArray(t2_data_original);
    const t3_wordBank = shuffleArray(t3_wordBank_original);
    const t3_data = shuffleArray(t3_data_original);
    const t4_wordBank = shuffleArray(t4_wordBank_original);
    const t4_data = shuffleArray(t4_data_original);
    const t5_data = shuffleArray(t5_data_original);
    const t6_data = shuffleArray(t6_data_original);
    const t7_data = shuffleArray(t7_data_original);
    const t8_data = shuffleArray(t8_data_original);

    // ==================== STATE MANAGEMENT ====================
    let answerStates = new Map();
    let wordUsageCount = { t3: {}, t4: {} };
    let optionSelections = new Map();
    let readingSelections = new Map();
    let selectedTextRange = null;
    let contextMenu = null;

    // ==================== HIGHLIGHT FUNCTIONS ====================
    function initializeTextHighlighting() {
        contextMenu = document.getElementById('context-menu');
        const highlightBtn = document.getElementById('highlight-text');
        const removeHighlightBtn = document.getElementById('remove-highlight');
        const clearHighlightsBtn = document.getElementById('clear-highlights');
        
        document.addEventListener('contextmenu', function(e) {
            const selection = window.getSelection();
            if (selection.toString().trim() && 
                (e.target.closest('.reading-text') || e.target.closest('.text-panel'))) {
                selectedTextRange = saveSelection();
                
                contextMenu.style.display = 'block';
                contextMenu.style.left = e.pageX + 'px';
                contextMenu.style.top = e.pageY + 'px';
                
                e.preventDefault();
            } else {
                contextMenu.style.display = 'none';
            }
        });
        
        document.addEventListener('click', function(e) {
            if (contextMenu && !contextMenu.contains(e.target)) {
                contextMenu.style.display = 'none';
            }
        });
        
        if (highlightBtn) {
            highlightBtn.addEventListener('click', function() {
                if (selectedTextRange) {
                    highlightSelection(selectedTextRange);
                    contextMenu.style.display = 'none';
                }
            });
        }
        
        if (removeHighlightBtn) {
            removeHighlightBtn.addEventListener('click', function() {
                if (selectedTextRange) {
                    removeHighlightFromSelection(selectedTextRange);
                    contextMenu.style.display = 'none';
                }
            });
        }
        
        if (clearHighlightsBtn) {
            clearHighlightsBtn.addEventListener('click', function() {
                clearAllHighlights();
                contextMenu.style.display = 'none';
            });
        }
    }

    function saveSelection() {
        const selection = window.getSelection();
        if (selection.rangeCount === 0) return null;
        return selection.getRangeAt(0).cloneRange();
    }

    function highlightSelection(range) {
        if (!range) return;
        
        const span = document.createElement('span');
        span.className = 'highlighted-text';
        
        try {
            range.surroundContents(span);
        } catch(e) {
            const div = document.createElement('div');
            div.innerHTML = range.toString();
            span.innerHTML = div.innerHTML;
            range.deleteContents();
            range.insertNode(span);
        }
        
        const selection = window.getSelection();
        selection.removeAllRanges();
    }

    function removeHighlightFromSelection(range) {
        if (!range) return;
        
        const parent = range.commonAncestorContainer;
        const highlightSpans = parent.parentElement.querySelectorAll('.highlighted-text');
        
        highlightSpans.forEach(span => {
            if (range.intersectsNode(span)) {
                const parent = span.parentNode;
                while (span.firstChild) {
                    parent.insertBefore(span.firstChild, span);
                }
                parent.removeChild(span);
            }
        });
        
        const selection = window.getSelection();
        selection.removeAllRanges();
    }

    function clearAllHighlights() {
        const highlights = document.querySelectorAll('.highlighted-text');
        highlights.forEach(highlight => {
            const parent = highlight.parentNode;
            while (highlight.firstChild) {
                parent.insertBefore(highlight.firstChild, highlight);
            }
            parent.removeChild(highlight);
        });
    }

    function highlightParagraph(paraId) {
        document.querySelectorAll('.hint-highlight').forEach(el => {
            el.classList.remove('hint-highlight');
        });
        
        const para = document.getElementById(paraId);
        if (para) {
            para.classList.add('hint-highlight');
        }
    }

    // ==================== UTILITY FUNCTIONS ====================
    function adjustWidth(el) {
        let baseWidth = el.classList.contains('letter-input') ? 45 : 120;
        let charWidth = el.classList.contains('word-input') ? 9 : 10;
        let newWidth = Math.max(el.value.length * charWidth + 20, baseWidth);
        let maxWidth = el.classList.contains('letter-input') ? 80 : 400;
        el.style.width = Math.min(newWidth, maxWidth) + "px";
    }

    function toggleHint(id) {
        const h = document.getElementById(id + '-hint');
        const infoBtn = document.getElementById(id + '-info');
        
        if (h) {
            if (h.style.display === 'block') {
                h.style.display = 'none';
                if (infoBtn) infoBtn.classList.remove('active');
            } else {
                h.style.display = 'block';
                if (infoBtn) infoBtn.classList.add('active');
            }
        }
    }

    function toggleSingleAns(id) {
        const qid = id.replace('-eye', '');
        
        // Handle Task 9 (reading)
        if (qid.startsWith('t9-q')) {
            const questionIndex = parseInt(qid.split('-q')[1]);
            const questionData = t9_data[questionIndex];
            const correctAnswerIndex = questionData.correct;
            
            const options = document.querySelectorAll(`#${qid}-container .mcq-option`);
            const eyeBtn = document.getElementById(id);
            const stateKey = `${qid}-state`;
            const isCurrentlyShown = answerStates.get(stateKey) || false;
            
            if (isCurrentlyShown) {
                options.forEach((option, index) => {
                    option.classList.remove('correct', 'incorrect');
                    const userSelection = readingSelections.get(qid);
                    if (userSelection !== undefined && index === userSelection) {
                        option.classList.add('selected');
                    }
                });
                
                if (eyeBtn) eyeBtn.classList.remove('active');
                answerStates.set(stateKey, false);
                document.querySelectorAll('.hint-highlight').forEach(el => {
                    el.classList.remove('hint-highlight');
                });
            } else {
                options.forEach((option, index) => {
                    option.classList.remove('selected');
                    if (index === correctAnswerIndex) {
                        option.classList.add('correct');
                    }
                });
                
                if (eyeBtn) eyeBtn.classList.add('active');
                answerStates.set(stateKey, true);
                highlightParagraph(questionData.para);
            }
            return;
        }
        
        // Handle option button questions (t2)
        if (qid.startsWith('t2-q')) {
            const questionIndex = parseInt(qid.split('-q')[1]);
            const questionData = t2_data[questionIndex];
            const correctAnswer = questionData.ans;
            
            const optionButtons = [];
            for (let i = 0; i < questionData.options.length; i++) {
                const btn = document.getElementById(`${qid}-opt${i}`);
                if (btn) optionButtons.push(btn);
            }
            
            const stateKey = `${qid}-state`;
            const isCurrentlyShown = answerStates.get(stateKey) || false;
            
            if (isCurrentlyShown) {
                optionButtons.forEach(btn => {
                    btn.classList.remove('correct-option', 'incorrect-option');
                    const userSelection = optionSelections.get(qid);
                    if (userSelection && btn.textContent === userSelection) {
                        btn.classList.add('selected');
                    }
                });
                
                const eyeBtn = document.getElementById(id);
                if (eyeBtn) eyeBtn.classList.remove('active');
                answerStates.set(stateKey, false);
            } else {
                optionButtons.forEach(btn => {
                    btn.classList.remove('selected', 'correct-option', 'incorrect-option');
                    if (btn.textContent === correctAnswer) {
                        btn.classList.add('correct-option');
                    }
                });
                
                const eyeBtn = document.getElementById(id);
                if (eyeBtn) eyeBtn.classList.add('active');
                answerStates.set(stateKey, true);
            }
            return;
        }
        
        // Handle input questions
        const el = document.getElementById(qid);
        if (!el) return;
        
        const ans = el.dataset.ans;
        const eyeBtn = document.getElementById(id);
        const stateKey = `${qid}-state`;
        const isCurrentlyShown = answerStates.get(stateKey) || false;
        
        if (isCurrentlyShown) {
            el.value = "";
            el.classList.remove('correct', 'incorrect-marked');
            adjustWidth(el);
            if (eyeBtn) eyeBtn.classList.remove('active');
            answerStates.set(stateKey, false);
        } else {
            if (ans) {
                el.value = ans;
                el.classList.add('correct');
                el.classList.remove('incorrect-marked');
                adjustWidth(el);
                if (eyeBtn) eyeBtn.classList.add('active');
                answerStates.set(stateKey, true);
            }
        }
    }

    function selectOption(qid, option) {
        const questionIndex = parseInt(qid.split('-q')[1]);
        const data = t2_data;
        
        const optionButtons = [];
        for (let i = 0; i < data[questionIndex].options.length; i++) {
            const btn = document.getElementById(`${qid}-opt${i}`);
            if (btn) optionButtons.push(btn);
        }
        
        optionButtons.forEach(btn => {
            btn.classList.remove('selected');
        });
        
        const selectedBtn = optionButtons.find(btn => btn.textContent === option);
        if (selectedBtn) {
            selectedBtn.classList.add('selected');
        }
        
        optionSelections.set(qid, option);
    }

    function selectReadingOption(qid, optionIndex) {
        const options = document.querySelectorAll(`#${qid}-container .mcq-option`);
        options.forEach(option => {
            option.classList.remove('selected');
        });
        
        const selectedOption = document.getElementById(`${qid}-option-${optionIndex}`);
        if (selectedOption) {
            selectedOption.classList.add('selected');
        }
        
        readingSelections.set(qid, optionIndex);
    }

    function showAnswers(prefix) {
        if (prefix === 't9') {
            document.querySelectorAll('.hint-highlight').forEach(el => {
                el.classList.remove('hint-highlight');
            });
            
            t9_data.forEach((item, i) => {
                const qid = `${prefix}-q${i}`;
                const correctIndex = item.correct;
                
                const options = document.querySelectorAll(`#${qid}-container .mcq-option`);
                options.forEach((option, index) => {
                    option.classList.remove('correct', 'incorrect', 'selected');
                    if (index === correctIndex) {
                        option.classList.add('correct');
                    }
                });
                
                const eyeBtn = document.getElementById(`${qid}-eye`);
                if (eyeBtn) eyeBtn.classList.add('active');
                answerStates.set(`${qid}-state`, true);
                highlightParagraph(item.para);
            });
            return;
        }
        
        if (prefix === 't2') {
            t2_data.forEach((item, i) => {
                const qid = `${prefix}-q${i}`;
                const correctAnswer = item.ans;
                
                const optionButtons = [];
                for (let j = 0; j < item.options.length; j++) {
                    const btn = document.getElementById(`${qid}-opt${j}`);
                    if (btn) optionButtons.push(btn);
                }
                
                optionButtons.forEach(btn => {
                    btn.classList.remove('selected', 'correct-option', 'incorrect-option');
                    if (btn.textContent === correctAnswer) {
                        btn.classList.add('correct-option');
                    }
                });
                
                const eyeBtn = document.getElementById(`${qid}-eye`);
                if (eyeBtn) eyeBtn.classList.add('active');
                answerStates.set(`${qid}-state`, true);
            });
            return;
        }
        
        if (prefix === 't3' || prefix === 't4') {
            let data = prefix === 't3' ? t3_data : t4_data;
            
            data.forEach((item, i) => {
                const qid = `${prefix}-q${i}`;
                const el = document.getElementById(qid);
                const eyeBtn = document.getElementById(`${qid}-eye`);
                
                if (el && item.ans) {
                    el.value = item.ans;
                    el.classList.add('correct');
                    el.classList.remove('incorrect-marked');
                    adjustWidth(el);
                    if (eyeBtn) eyeBtn.classList.add('active');
                    answerStates.set(`${qid}-state`, true);
                    
                    const normalizedAnswer = normalizeAnswer(item.ans);
                    const wordItems = document.querySelectorAll(`#bank-${prefix} .word-item`);
                    
                    wordItems.forEach(wordItem => {
                        const wordText = wordItem.textContent.trim();
                        const normalizedWord = normalizeAnswer(wordText);
                        
                        if (normalizedWord === normalizedAnswer) {
                            wordItem.classList.add('used');
                            if (wordUsageCount[prefix]) {
                                wordUsageCount[prefix][normalizedWord] = 1;
                            }
                        }
                    });
                }
            });
            return;
        }
        
        // Handle other tasks (t1, t5, t6, t7, t8)
        document.querySelectorAll(`[id^="${prefix}-q"]`).forEach(el => {
            if (el.dataset && el.dataset.type === 'input') {
                const ans = el.dataset.ans;
                const eyeBtn = document.getElementById(el.id + '-eye');
                
                if (ans) {
                    el.value = ans;
                    el.classList.add('correct');
                    el.classList.remove('incorrect-marked');
                    adjustWidth(el);
                    if (eyeBtn) eyeBtn.classList.add('active');
                    answerStates.set(`${el.id}-state`, true);
                }
            }
        });
    }

    function resetSection(prefix) {
        if (prefix === 't9') {
            const options = document.querySelectorAll(`#reading-questions-${prefix} .mcq-option`);
            options.forEach(option => {
                option.classList.remove('selected', 'correct', 'incorrect');
            });
            
            readingSelections.clear();
            
            document.querySelectorAll(`#reading-questions-${prefix} .btn-small[id$="-eye"]`).forEach(eyeBtn => {
                eyeBtn.classList.remove('active');
            });
            
            for (const [key, value] of answerStates.entries()) {
                if (key.includes(`${prefix}-q`)) {
                    answerStates.delete(key);
                }
            }
            
            document.querySelectorAll('.hint-highlight').forEach(el => {
                el.classList.remove('hint-highlight');
            });
            return;
        }
        
        document.querySelectorAll(`[id^="${prefix}"]`).forEach(i => { 
            if(i.tagName === 'INPUT') { 
                i.value = ""; 
                i.classList.remove('correct', 'incorrect-marked'); 
                adjustWidth(i); 
            } 
            
            const hBox = document.getElementById(i.id + '-hint'); 
            if(hBox) hBox.style.display = 'none'; 
        });
        
        document.querySelectorAll(`[id$="-eye"], [id$="-info"]`).forEach(btn => {
            if (btn.id.includes(prefix)) {
                btn.classList.remove('active');
            }
        });
        
        if (prefix === 't2') {
            const allOptionBtns = document.querySelectorAll(`#questions-${prefix} .option-btn`);
            
            allOptionBtns.forEach(btn => {
                btn.classList.remove('selected', 'correct-option', 'incorrect-option');
            });
            
            for (const [key, value] of optionSelections.entries()) {
                if (key.startsWith(`${prefix}-`)) {
                    optionSelections.delete(key);
                }
            }
            
            for (const [key, value] of answerStates.entries()) {
                if (key.includes(`${prefix}-q`)) {
                    answerStates.delete(key);
                }
            }
        }
        
        if (prefix === 't3' || prefix === 't4') {
            const wordItems = document.querySelectorAll(`#bank-${prefix} .word-item`);
            wordItems.forEach(item => {
                item.classList.remove('used');
                item.style.display = 'flex';
            });
            
            if (wordUsageCount[prefix]) {
                Object.keys(wordUsageCount[prefix]).forEach(word => {
                    wordUsageCount[prefix][word] = 0;
                });
            }
        }
        
        for (const [key, value] of answerStates.entries()) {
            if (key.includes(`${prefix}-q`)) {
                answerStates.delete(key);
            }
        }
    }

    function normalizeAnswer(answer) {
        return answer.toLowerCase().trim().replace(/\s+/g, ' ').replace(/[.,;:!?]$/, '');
    }

    function validateMultipleAnswers(userAnswer, correctAnswers) {
        const answers = correctAnswers.split('|').map(ans => normalizeAnswer(ans));
        const normalizedUser = normalizeAnswer(userAnswer);
        return answers.some(ans => ans === normalizedUser);
    }

    function checkAll() {
        document.querySelectorAll('[data-type="input"]').forEach(el => { 
            const correctAnswers = el.dataset.ans;
            const userAnswer = el.value;
            
            el.classList.remove('correct', 'incorrect-marked'); 
            
            if(!userAnswer.trim()) {
                return;
            }
            
            if(validateMultipleAnswers(userAnswer, correctAnswers)) {
                el.classList.add('correct');
            } else {
                el.classList.add('incorrect-marked');
            }
        });
        
        // Check Task 2
        t2_data.forEach((item, i) => {
            const qid = `t2-q${i}`;
            const selectedOption = optionSelections.get(qid);
            const correctAnswer = item.ans;
            
            if (!selectedOption) {
                return;
            }
            
            const optionButtons = [];
            for (let j = 0; j < item.options.length; j++) {
                const btn = document.getElementById(`${qid}-opt${j}`);
                if (btn) optionButtons.push(btn);
            }
            
            optionButtons.forEach(btn => {
                btn.classList.remove('correct-option', 'incorrect-option');
            });
            
            const userSelectedBtn = optionButtons.find(btn => btn.textContent === selectedOption);
            if (userSelectedBtn) {
                if (selectedOption === correctAnswer) {
                    userSelectedBtn.classList.add('correct-option');
                } else {
                    userSelectedBtn.classList.add('incorrect-option');
                }
            }
        });
        
        // Check Task 9
        t9_data.forEach((item, i) => {
            const qid = `t9-q${i}`;
            const userSelection = readingSelections.get(qid);
            const correctIndex = item.correct;
            
            const options = document.querySelectorAll(`#${qid}-container .mcq-option`);
            options.forEach((option, index) => {
                option.classList.remove('correct', 'incorrect', 'selected');
                
                if (userSelection !== undefined) {
                    if (index === userSelection) {
                        if (userSelection === correctIndex) {
                            option.classList.add('correct');
                        } else {
                            option.classList.add('incorrect');
                        }
                    }
                }
            });
        });
    }

    // ==================== WORD BANK FUNCTIONS ====================
    function addWordBankEventListeners(id) {
        const wordItems = document.querySelectorAll(`#bank-${id} .word-item`);
        const inputs = document.querySelectorAll(`#questions-${id} input.word-input`);
        
        wordItems.forEach(item => {
            item.addEventListener('click', function() {
                selectWordFromBank(this.id);
            });
            
            item.addEventListener('dragstart', function(e) {
                dragWord(e);
            });
        });
        
        inputs.forEach(input => {
            input.addEventListener('dragover', function(e) {
                allowDrop(e);
            });
            
            input.addEventListener('drop', function(e) {
                dropWord(e, this.id);
            });
            
            input.addEventListener('input', function() {
                updateWordBank(id);
            });
        });
    }

    function dragWord(event) {
        event.dataTransfer.setData("text/plain", event.target.dataset.word);
        event.dataTransfer.setData("wordId", event.target.id);
    }

    function allowDrop(event) {
        event.preventDefault();
    }

    function dropWord(event, inputId) {
        event.preventDefault();
        const word = event.dataTransfer.getData("text/plain");
        const wordId = event.dataTransfer.getData("wordId");
        
        const input = document.getElementById(inputId);
        if (input) {
            input.value = word;
            adjustWidth(input);
            
            const wordElement = document.getElementById(wordId);
            if (wordElement) {
                wordElement.classList.add('used');
            }
            
            const taskId = inputId.split('-')[0];
            updateWordBankUsage(word, taskId);
        }
    }

    function selectWordFromBank(wordId) {
        const wordItem = document.getElementById(wordId);
        if (!wordItem || wordItem.classList.contains('used')) return;
        
        const word = wordItem.dataset.word;
        const taskId = wordId.split('-')[0];
        
        const inputs = document.querySelectorAll(`#questions-${taskId} input.word-input`);
        let emptyInput = null;
        
        for (const input of inputs) {
            if (!input.value.trim()) {
                emptyInput = input;
                break;
            }
        }
        
        if (emptyInput) {
            emptyInput.value = word;
            adjustWidth(emptyInput);
            
            wordItem.classList.add('used');
            
            updateWordBankUsage(word, taskId);
        } else {
            alert('All gaps are filled. You can click on a gap to replace its content.');
        }
    }

    function updateWordBankUsage(word, taskId) {
        if (!wordUsageCount[taskId]) {
            wordUsageCount[taskId] = {};
        }
        
        if (!wordUsageCount[taskId][word]) {
            wordUsageCount[taskId][word] = 0;
        }
        
        const inputs = document.querySelectorAll(`#questions-${taskId} input.word-input`);
        let count = 0;
        
        inputs.forEach(input => {
            if (normalizeAnswer(input.value) === normalizeAnswer(word)) {
                count++;
            }
        });
        
        wordUsageCount[taskId][word] = count;
        
        updateWordBankDisplay(taskId);
    }

    function updateWordBankDisplay(taskId) {
        const wordItems = document.querySelectorAll(`#bank-${taskId} .word-item`);
        
        wordItems.forEach(item => {
            const word = item.dataset.word;
            const count = wordUsageCount[taskId][word] || 0;
            
            if (count > 0) {
                item.classList.add('used');
            } else {
                item.classList.remove('used');
                item.style.display = 'flex';
            }
        });
    }

    function updateWordBank(taskId) {
        const inputs = document.querySelectorAll(`#questions-${taskId} input.word-input`);
        
        if (wordUsageCount[taskId]) {
            Object.keys(wordUsageCount[taskId]).forEach(word => {
                wordUsageCount[taskId][word] = 0;
            });
        }
        
        inputs.forEach(input => {
            const word = normalizeAnswer(input.value);
            if (word) {
                const wordItems = document.querySelectorAll(`#bank-${taskId} .word-item`);
                wordItems.forEach(item => {
                    const bankWord = normalizeAnswer(item.dataset.word);
                    if (bankWord === word) {
                        if (wordUsageCount[taskId][bankWord] !== undefined) {
                            wordUsageCount[taskId][bankWord]++;
                        }
                    }
                });
            }
        });
        
        updateWordBankDisplay(taskId);
    }

    // ==================== RESIZER ====================
    function initializeResizer() {
        const resizer = document.getElementById('resizer-t9');
        const leftPanel = document.getElementById('text-panel-t9');
        const rightPanel = document.getElementById('questions-panel-t9');
        
        if (!resizer || !leftPanel || !rightPanel) return;
        
        leftPanel.style.width = '50%';
        rightPanel.style.flex = '1';
        
        let isResizing = false;
        let startX = 0;
        let startLeftWidth = 0;
        
        resizer.addEventListener('mousedown', function(e) {
            isResizing = true;
            startX = e.clientX;
            startLeftWidth = leftPanel.offsetWidth;
            
            document.body.style.cursor = 'col-resize';
            document.body.style.userSelect = 'none';
            
            document.addEventListener('mousemove', handleMouseMove);
            document.addEventListener('mouseup', handleMouseUp);
        });
        
        function handleMouseMove(e) {
            if (!isResizing) return;
            
            const dx = e.clientX - startX;
            const newLeftWidth = startLeftWidth + dx;
            
            const containerWidth = leftPanel.parentElement.offsetWidth;
            const minWidth = 200;
            const maxWidth = containerWidth - minWidth - resizer.offsetWidth;
            
            if (newLeftWidth >= minWidth && newLeftWidth <= maxWidth) {
                leftPanel.style.width = newLeftWidth + 'px';
                rightPanel.style.flex = '1';
            }
        }
        
        function handleMouseUp() {
            isResizing = false;
            document.body.style.cursor = '';
            document.body.style.userSelect = '';
            
            document.removeEventListener('mousemove', handleMouseMove);
            document.removeEventListener('mouseup', handleMouseUp);
        }
    }

    // ==================== REFERENCE TOGGLE FUNCTIONS ====================
    function toggleGrammar(grammarId) {
        const element = document.getElementById(`grammar-${grammarId}`);
        const toggleBtn = element.querySelector('.group-toggle');
        
        if (element.classList.contains('expanded')) {
            element.classList.remove('expanded');
            element.classList.add('collapsed');
            toggleBtn.textContent = '+';
        } else {
            element.classList.remove('collapsed');
            element.classList.add('expanded');
            toggleBtn.textContent = '−';
        }
    }

    function toggleTopic(topicId) {
        const element = document.getElementById(`topic-${topicId}`);
        const toggleBtn = element.parentElement.querySelector('.group-toggle');
        
        if (element.classList.contains('expanded')) {
            element.classList.remove('expanded');
            element.classList.add('collapsed');
            toggleBtn.textContent = '+';
        } else {
            element.classList.remove('collapsed');
            element.classList.add('expanded');
            toggleBtn.textContent = '−';
        }
    }

    function toggleReferenceSection() {
        const content = document.getElementById('reference-content');
        const toggleBtn = document.getElementById('reference-toggle');
        
        if (content.style.display === 'none' || content.style.display === '') {
            content.style.display = 'block';
            toggleBtn.textContent = '−';
        } else {
            content.style.display = 'none';
            toggleBtn.textContent = '+';
        }
    }

    // ==================== RENDERING FUNCTIONS ====================
    function renderTask1() {
        const vocabContainer = document.getElementById('vocab-t1');
        const defContainer = document.getElementById('def-t1');
        
        vocabContainer.innerHTML = '';
        defContainer.innerHTML = '';
        
        const definitions = {};
        t1_data.forEach(item => {
            definitions[item.letter] = item.def;
        });
        
        const sortedLetters = Object.keys(definitions).sort();
        sortedLetters.forEach(letter => {
            defContainer.innerHTML += `
                <div class="definition-item">
                    <span class="definition-letter">${letter}.</span>
                    <span class="definition-text">${definitions[letter]}</span>
                </div>`;
        });
        
        t1_data.forEach((item, i) => {
            const qid = `t1-q${i}`;
            
            vocabContainer.innerHTML += `
                <div class="vocab-item">
                    <span class="vocab-text">${item.v}</span>
                    <input type="text" class="letter-input" id="${qid}" data-type="input" data-ans="${item.letter}" maxlength="1" oninput="adjustWidth(this)">
                    <div class="row-btns">
                        <button class="btn-small" id="${qid}-eye" onclick="toggleSingleAns('${qid}-eye')">👁️</button>
                        <button class="info-btn" id="${qid}-info" onclick="toggleHint('${qid}')">i</button>
                    </div>
                    <div class="hint-box" id="${qid}-hint">💡 ${item.hint}</div>
                </div>`;
        });
    }

    function renderTask2() {
        const container = document.getElementById('questions-t2');
        container.innerHTML = '';
        
        t2_data.forEach((item, i) => {
            const qid = `t2-q${i}`;
            
            let optionsHtml = '';
            item.options.forEach((option, optIndex) => {
                optionsHtml += `<button class="option-btn" onclick="selectOption('${qid}', '${option}')" id="${qid}-opt${optIndex}">${option}</button>`;
            });
            
            container.innerHTML += `
                <div class="question-row">
                    <strong>${i+1}</strong> <span class="sentence-text">
                        ${item.q}
                        <div class="option-container">
                            ${optionsHtml}
                        </div>
                    </span>
                    <div class="row-btns">
                        <button class="btn-small" id="${qid}-eye" onclick="toggleSingleAns('${qid}-eye')">👁️</button>
                        <button class="info-btn" id="${qid}-info" onclick="toggleHint('${qid}')">i</button>
                    </div>
                    <div class="hint-box" id="${qid}-hint">💡 ${item.hint}</div>
                </div>`;
        });
    }

    function renderTask3() {
        const bankContainer = document.getElementById('bank-t3');
        const questionContainer = document.getElementById('questions-t3');
        
        bankContainer.innerHTML = '';
        wordUsageCount['t3'] = {};
        
        t3_wordBank.forEach((word, i) => {
            const wordId = `t3-word-${i}`;
            bankContainer.innerHTML += `
                <div class="word-item" id="${wordId}" data-word="${word.toLowerCase()}" draggable="true" ondragstart="dragWord(event)" onclick="selectWordFromBank('${wordId}')">
                    ${word}
                </div>`;
            wordUsageCount['t3'][word.toLowerCase()] = 0;
        });
        
        questionContainer.innerHTML = '';
        
        t3_data.forEach((item, i) => {
            const qid = `t3-q${i}`;
            questionContainer.innerHTML += `
                <div class="question-row">
                    <strong>${i+1}</strong> ${item.q}
                    <input type="text" class="word-input" id="${qid}" data-type="input" data-ans="${item.ans}" oninput="adjustWidth(this); updateWordBank('t3')" ondrop="dropWord(event, '${qid}')" ondragover="allowDrop(event)" onclick="this.select()">
                    <div class="row-btns">
                        <button class="btn-small" id="${qid}-eye" onclick="toggleSingleAns('${qid}-eye')">👁️</button>
                        <button class="info-btn" id="${qid}-info" onclick="toggleHint('${qid}')">i</button>
                    </div>
                    <div class="hint-box" id="${qid}-hint">💡 ${item.hint}</div>
                </div>`;
        });
        
        addWordBankEventListeners('t3');
    }

    function renderTask4() {
        const bankContainer = document.getElementById('bank-t4');
        const questionContainer = document.getElementById('questions-t4');
        
        bankContainer.innerHTML = '';
        wordUsageCount['t4'] = {};
        
        t4_wordBank.forEach((word, i) => {
            const wordId = `t4-word-${i}`;
            bankContainer.innerHTML += `
                <div class="word-item" id="${wordId}" data-word="${word.toLowerCase()}" draggable="true" ondragstart="dragWord(event)" onclick="selectWordFromBank('${wordId}')">
                    ${word}
                </div>`;
            wordUsageCount['t4'][word.toLowerCase()] = 0;
        });
        
        questionContainer.innerHTML = '';
        
        t4_data.forEach((item, i) => {
            const qid = `t4-q${i}`;
            questionContainer.innerHTML += `
                <div class="question-row">
                    <strong>${i+1}</strong> ${item.q}
                    <input type="text" class="word-input" id="${qid}" data-type="input" data-ans="${item.ans}" oninput="adjustWidth(this); updateWordBank('t4')" ondrop="dropWord(event, '${qid}')" ondragover="allowDrop(event)" onclick="this.select()">
                    <div class="row-btns">
                        <button class="btn-small" id="${qid}-eye" onclick="toggleSingleAns('${qid}-eye')">👁️</button>
                        <button class="info-btn" id="${qid}-info" onclick="toggleHint('${qid}')">i</button>
                    </div>
                    <div class="hint-box" id="${qid}-hint">💡 ${item.hint}</div>
                </div>`;
        });
        
        addWordBankEventListeners('t4');
    }

    function renderTask5() {
        const container = document.getElementById('questions-t5');
        container.innerHTML = '';
        
        t5_data.forEach((item, i) => {
            const qid = `t5-q${i}`;
            container.innerHTML += `
                <div class="question-row">
                    <strong>${i+1}</strong> ${item.q}
                    <input type="text" class="word-input" id="${qid}" data-type="input" data-ans="${item.ans}" oninput="adjustWidth(this)">
                    <div class="row-btns">
                        <button class="btn-small" id="${qid}-eye" onclick="toggleSingleAns('${qid}-eye')">👁️</button>
                        <button class="info-btn" id="${qid}-info" onclick="toggleHint('${qid}')">i</button>
                    </div>
                    <div class="hint-box" id="${qid}-hint">💡 ${item.hint}</div>
                </div>`;
        });
    }

    function renderTask6() {
        const container = document.getElementById('questions-t6');
        container.innerHTML = '';
        
        t6_data.forEach((item, i) => {
            const qid = `t6-q${i}`;
            container.innerHTML += `
                <div class="question-row">
                    <strong>${i+1}</strong> ${item.q}
                    <input type="text" class="word-input" id="${qid}" data-type="input" data-ans="${item.ans}" oninput="adjustWidth(this)">
                    <div class="row-btns">
                        <button class="btn-small" id="${qid}-eye" onclick="toggleSingleAns('${qid}-eye')">👁️</button>
                        <button class="info-btn" id="${qid}-info" onclick="toggleHint('${qid}')">i</button>
                    </div>
                    <div class="hint-box" id="${qid}-hint">💡 ${item.hint}</div>
                </div>`;
        });
    }

    function renderTask7() {
        const container = document.getElementById('questions-t7');
        container.innerHTML = '';
        
        t7_data.forEach((item, i) => {
            const qid = `t7-q${i}`;
            container.innerHTML += `
                <div class="question-row">
                    <strong>${i+1}</strong> ${item.q}
                    <input type="text" class="word-input" id="${qid}" data-type="input" data-ans="${item.ans}" oninput="adjustWidth(this)">
                    <div class="row-btns">
                        <button class="btn-small" id="${qid}-eye" onclick="toggleSingleAns('${qid}-eye')">👁️</button>
                        <button class="info-btn" id="${qid}-info" onclick="toggleHint('${qid}')">i</button>
                    </div>
                    <div class="hint-box" id="${qid}-hint">💡 ${item.hint}</div>
                </div>`;
        });
    }

    function renderTask8() {
        const container = document.getElementById('questions-t8');
        container.innerHTML = '';
        
        t8_data.forEach((item, i) => {
            const qid = `t8-q${i}`;
            container.innerHTML += `
                <div class="question-row">
                    <strong>${i+1}</strong> ${item.q}
                    <input type="text" class="word-input" id="${qid}" data-type="input" data-ans="${item.ans}" oninput="adjustWidth(this)">
                    <div class="row-btns">
                        <button class="btn-small" id="${qid}-eye" onclick="toggleSingleAns('${qid}-eye')">👁️</button>
                        <button class="info-btn" id="${qid}-info" onclick="toggleHint('${qid}')">i</button>
                    </div>
                    <div class="hint-box" id="${qid}-hint">💡 ${item.hint}</div>
                </div>`;
        });
    }

    function renderTask9() {
        const questionsContainer = document.getElementById('reading-questions-t9');
        questionsContainer.innerHTML = '';
        
        t9_data.forEach((item, i) => {
            const qid = `t9-q${i}`;
            const optionLetters = ['A', 'B', 'C', 'D'];
            
            let optionsHtml = '<div class="mcq-options-container">';
            item.options.forEach((option, optIndex) => {
                const letter = optionLetters[optIndex];
                optionsHtml += `
                    <div class="mcq-option" id="${qid}-option-${optIndex}" onclick="selectReadingOption('${qid}', ${optIndex})">
                        <span class="option-letter">${letter}</span>
                        <span class="option-text">${option}</span>
                    </div>`;
            });
            optionsHtml += '</div>';
            
            questionsContainer.innerHTML += `
                <div class="mcq-question" id="${qid}-container">
                    <p><strong>${i+1}</strong> ${item.question}</p>
                    ${optionsHtml}
                    <div class="row-btns" style="margin-top: 10px;">
                        <button class="btn-small" id="${qid}-eye" onclick="toggleSingleAns('${qid}-eye')">👁️</button>
                        <button class="info-btn" id="${qid}-info" onclick="toggleHint('${qid}')">i</button>
                    </div>
                    <div class="hint-box" id="${qid}-hint">💡 ${item.hint}</div>
                </div>`;
        });
    }

    // ==================== WINDOW ONLOAD ====================
    window.onload = () => {
        renderTask1();
        renderTask2();
        renderTask3();
        renderTask4();
        renderTask5();
        renderTask6();
        renderTask7();
        renderTask8();
        renderTask9();
        initializeResizer();
        initializeTextHighlighting();
        
        // Collapse reference content by default
        const referenceContent = document.getElementById('reference-content');
        const referenceToggle = document.getElementById('reference-toggle');
        if (referenceContent) {
            referenceContent.style.display = 'none';
            referenceToggle.textContent = '+';
        }
        
        // Make functions global
        window.toggleGrammar = toggleGrammar;
        window.toggleTopic = toggleTopic;
        window.toggleReferenceSection = toggleReferenceSection;
        window.toggleSingleAns = toggleSingleAns;
        window.toggleHint = toggleHint;
        window.selectOption = selectOption;
        window.selectReadingOption = selectReadingOption;
        window.showAnswers = showAnswers;
        window.resetSection = resetSection;
        window.checkAll = checkAll;
        window.dragWord = dragWord;
        window.allowDrop = allowDrop;
        window.dropWord = dropWord;
        window.selectWordFromBank = selectWordFromBank;
        window.adjustWidth = adjustWidth;
        window.updateWordBank = updateWordBank;
    };

    // Enter key to check all answers
    document.addEventListener('keydown', e => { 
        if(e.key === 'Enter') {
            checkAll(); 
        }
    });
</script>
</body>
</html>