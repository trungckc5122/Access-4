<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Access 4 - Module 4b</title>
    <style>
        /* ========================================================================
        TECHNICAL REQUIREMENTS IMPLEMENTED:
        
        1. DATA INTEGRITY: All content from provided images preserved exactly
        
        2. STICKY UI: Word Bank follows scrolling when needed with position: sticky
        
        3. SINGLE SOLVE: Individual 'Show' buttons per question with üëÅÔ∏è icon
        
        4. PEDAGOGICAL HINTS: Detailed English explanations via (i) button toggle
        
        5. SAFE-HIGHLIGHT: Keyword highlighting on error (green/red color coding)
           - Green (#27ae60) for correct answers
           - Red (#e74c3c) for incorrect answers
           - Background colors change to indicate status
        
        6. CLICK-TO-SELECT & DRAG-DROP: Dual input methods for Word Bank
           - Click on word bank items to select them
           - Drag and drop onto input fields
           - Visual feedback with color change (#ffeaa7 for selected)
        
        7. AUTO-WIDTH: Inputs resize based on content using oninput event
           - Base widths: letter-input=45px, preposition-input=80px, word-input=120px, grammar-input=150px
           - Dynamic adjustment: Math.max(el.value.length * 10 + 20, baseWidth)
        
        8. CASE-INSENSITIVE: Matching handles A/a equally via normalizeAnswer() function
           - Converts to lowercase, trims whitespace, removes punctuation
        
        9. WORD BANK MANAGEMENT: Auto-hide used items with frequency tracking
           - Counts occurrences of each word in inputs
           - Hides items when used count >= total available (handles x2 duplicates)
        
        10. LOCAL CONTROLS: Individual Task 'Show All' and 'Reset' buttons
            - Each exercise has its own control buttons
            - Prefix-based selection for targeted operations
        
        11. KEYBOARD: Enter to check all answers, Arrow keys for navigation
            - Event listener on document for keydown events
            - Enter key triggers checkAll() function
        
        12. ENHANCED HINTS: Detailed explanations for every question
            - Hidden divs that toggle on (i) button click
            - Each hint contains pedagogical explanation
        
        13. AUTOMATIC FORMAT DETECTION: Based on data structure
            - RULE 1: MATCHING EXERCISE - objects with 'v', 'letter', 'def', 'hint' properties
            - RULE 2: GAP-FILL WITH WORD BANK - objects with 'q', 'ans', 'hint' and [INPUT] placeholder
            - RULE 3: PREPOSITION EXERCISE - objects with 'q', 'ans', 'hint' for fill-in-blank
            - RULE 4: ADJECTIVE FORMS - objects with 'q', 'ans', 'hint' with parentheses for adjective hint
            - RULE 5: ERROR CORRECTION - objects with 'words' array, 'errIdx', 'corr', 'hint' properties
        
        14. MULTI-FORMAT SUPPORT:
            - Vocabulary Matching (Task 1): 2-column grid with letter inputs
            - Gap-fill with Word Bank (Task 2): Input fields with sticky word bank
            - Relative Clauses (Task 3): Grammar-focused inputs for relative pronouns
            - Passive Voice (Task 4): Sentence transformation exercises
            - Adjective/Adverb Forms (Task 5): Comparative and superlative exercises
            - So/Such/Enough Structures (Task 6): Grammar structure exercises
        
        15. EXERCISE NUMBER HANDLING: Preserves existing numbering from content
            - If sentences already have numbers (like "1.", "2."), uses those numbers
            - Otherwise uses automatic numbering with exercise-number class
            - Number detection regex: /^\d+\.\s/
        
        16. DOCUMENTATION PRESERVATION: All technical requirement comments maintained
            - This section must remain intact in any derivative code
            - New requirements added as additional numbered points
            - Never modify or remove existing technical requirements
            - Always keep the complete history of all requirements
        
        17. IPA PRONUNCIATION FEATURE FOR MATCHING EXERCISES:
            - Each vocabulary item in matching exercises has IPA pronunciation data
            - Speaker button (üîä) added next to eye (üëÅÔ∏è) button
            - Clicking speaker button shows IPA pronunciation in a dedicated box
            - IPA data stored in 'ipa' property of vocabulary objects
            - Visual design: IPA box appears below each vocabulary item
        
        18. MULTIPLE CORRECT ANSWERS SUPPORT:
            - For exercises where multiple answers are possible,
              answers can be stored as arrays or pipe-separated strings
            - Validation logic checks if user answer matches any of the acceptable answers
            - Supports British/American spelling variations
        
        19. CONTEXT-AWARE VALIDATION:
            - Grammar structures: Alternative correct forms accepted based on pedagogical context
        
        20. CONSISTENT CASE HANDLING FOR WORD BANKS AND ANSWERS:
            - WORD BANK ITEMS: Always displayed in lowercase for visual consistency
            - ANSWER DISPLAY: Show answers with exact original capitalization from data
            - VALIDATION: Case-insensitive comparison during validation
            - USER INPUT: Preserves user's original capitalization input
        
        21. CASE HANDLING IMPLEMENTATION:
            - Word bank creation: Uses toLowerCase() for all displayed words
            - Answer display: Shows exact 'ans' property from data (preserves original case)
            - Validation: Uses normalizeAnswer() for case-insensitive comparison
            - User experience: No automatic case modification during user typing
        
        22. GAP DETECTION AND REPLACEMENT:
            - Any occurrence of "______" (any length of underscores) in question text is automatically
              replaced with an input field
            - Regex pattern: /_{2,}/g matches 2 or more consecutive underscores
            - This handles variations in gap length from different sources
            - Input fields are inserted exactly where the underscores appear
        
        23. MATCHING EXERCISE TWO-COLUMN LAYOUT WITH IPA:
            - Left column: Vocabulary items with input boxes for matching letters
            - Right column: Definitions in alphabetical order (A, B, C, D, etc.)
            - Each vocabulary item has three control buttons:
              1. üëÅÔ∏è Eye button: Shows the correct answer
              2. üîä Speaker button: Shows IPA pronunciation
              3. (i) Info button: Shows pedagogical hint
            - IPA pronunciation data comes from reliable dictionary sources
        
        24. IPA PRONUNCIATION IMPLEMENTATION:
            - Speaker button size matches eye button (28x28px)
            - IPA data stored in 'ipa' property of vocabulary objects
            - IPA display uses phonetic font and proper formatting
        
        25. IPA SINGLE ACTIVE DISPLAY SYSTEM:
            - Only ONE IPA pronunciation box can be visible at a time
            - Clicking a speaker button shows that word's IPA and hides any other visible IPA box
            - Clicking the same speaker button again toggles (hides) its IPA box
            - This prevents visual clutter and ensures clean interface
        
        26. DEFINITIONS COLUMN OPTIMIZATION:
            - Definitions column displays clean list without unnecessary headers
            - Alphabetical ordering (A, B, C, D) maintained for easy reference
            - Visual hierarchy maintained through consistent styling
        
        27. SCROLLABLE DEFINITIONS COLUMN FOR MATCHING EXERCISES:
            - Definitions column has independent vertical scrolling when content is too long
            - Fixed height with overflow-y: auto enables scrolling within the column
            - Scrollbar styling matches the design system with subtle appearance
        
        28. MULTI-GAP QUESTIONS WITH SEPARATE VALIDATION:
            - For questions with multiple gaps, each gap gets its own input field
            - Data structure supports multiple answers in one 'ans' field separated by |
            - Validation checks each input field against its corresponding answer
        
        29. TOGGLE FUNCTIONALITY FOR EYE AND INFO BUTTONS:
            - Eye button (üëÅÔ∏è) toggles answer display on second click
            - Info button (i) toggles hint display on second click
            - Both buttons restore original state when clicked again
        
        30. MULTIPLE CORRECT ANSWERS FIX FOR SINGLE-GAP QUESTIONS:
            - CRITICAL FIX: For single-gap questions with pipe-separated answers,
              the entire pipe-separated string must be stored in the input's data-ans attribute
            - FIXED: Input elements now receive the complete pipe-separated answer string
              from the data object's 'ans' property
        
        31. RELATIVE CLAUSES FORMAT HANDLING:
            - Task 3 includes specific relative clause structure
            - Single gap for relative pronouns (who, which, that, where, when)
            - Grammar reference section explains relative pronouns
            - Input fields designed for grammar-specific content
        
        32. PASSIVE VOICE TRANSFORMATION:
            - Task 4 focuses on passive voice transformations
            - Rewriting sentences from active to passive voice
            - Tense preservation in passive transformations
            - Comprehensive grammar explanations
        
        33. ADJECTIVE/ADVERB FORMS EXERCISE:
            - Task 5 focuses on comparative and superlative forms
            - Includes "as...as" structure for equal comparisons
            - Handles regular and irregular adjective forms
        
        34. SO/SUCH/ENOUGH STRUCTURES:
            - Task 6 focuses on intensifiers and result clauses
            - Practice with "so + adjective", "such + noun", "adjective + enough"
            - Different grammatical structures for different contexts
        
        35. ADAPTIVE INPUT WIDTH EXPANSION:
            - Input fields automatically expand to show complete text content
            - Uses character counting with dynamic width calculation
            - Minimum widths ensure usability for empty fields
            - Maximum widths prevent excessive expansion beyond container bounds
            - Special handling for long answers in passive voice and grammar inputs
        
        ======================================================================== */
        :root {
            --primary: #2980b9; 
            --primary-dark: #1c5982; 
            --success: #27ae60;
            --error: #e74c3c; 
            --warning: #f1c40f; 
            --bg: #f4f7f9;
            --text: #2c3e50; 
            --card: #ffffff;
            --selection: #3498db;
            --selection-bg: #ebf5fb;
        }
        
        body { 
            font-family: 'Times New Roman', serif; 
            font-size: 13pt; 
            background-color: var(--bg); 
            color: var(--text); 
            margin: 0; 
            padding: 20px 20px 100px 20px; 
            line-height: 1.6; 
        }
        
        .container { 
            max-width: 1000px; 
            margin: 0 auto; 
        }
        
        .sticky-bank { 
            position: sticky; 
            top: 15px; 
            z-index: 100;
            background-color: #fff; 
            padding: 15px; 
            border-radius: 10px; 
            margin-bottom: 25px; 
            border: 2px solid var(--primary); 
            display: flex; 
            flex-wrap: wrap; 
            gap: 10px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
        }
        
        .word-item { 
            background: #eef2f7; 
            border: 1px solid var(--primary); 
            color: var(--primary-dark); 
            padding: 6px 12px; 
            border-radius: 5px; 
            cursor: grab; 
            user-select: none; 
            transition: 0.2s; 
            font-size: 0.9em; 
            font-weight: 500;
        }
        
        .word-item.used { 
            display: none; 
        }
        
        .word-item:hover { 
            background: var(--primary); 
            color: white; 
        }

        .exercise-card { 
            background: var(--card); 
            border-radius: 12px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); 
            padding: 25px; 
            margin-bottom: 30px; 
        }
        
        .exercise-title { 
            font-weight: bold; 
            font-size: 1.25em; 
            margin-bottom: 18px; 
            color: var(--primary-dark); 
            border-bottom: 2px solid #eee; 
            padding-bottom: 8px; 
        }
        
        .matching-grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 30px; 
            margin-top: 10px; 
        }
        
        .vocab-item { 
            margin-bottom: 12px; 
            display: flex; 
            align-items: center; 
            gap: 10px; 
        }
        
        .vocab-text { 
            min-width: 150px; 
            font-weight: 500; 
        }
        
        .def-item { 
            margin-bottom: 12px; 
            padding: 4px 0; 
            border-bottom: 1px solid #f0f0f0; 
            min-height: 40px; 
            display: flex; 
            align-items: center; 
        }

        .question-row { 
            margin-bottom: 18px; 
            line-height: 2.2; 
            border-bottom: 1px solid #f9f9f9; 
            padding-bottom: 10px; 
            position: relative; 
        }
        
        input[type="text"] { 
            border: none; 
            border-bottom: 2px solid #bdc3c7; 
            background: #fafafa; 
            padding: 2px 8px; 
            font-size: 1em; 
            transition: 0.2s; 
            outline: none;
            min-width: 60px; 
            border-radius: 4px 4px 0 0; 
            text-align: center; 
            font-family: 'Times New Roman';
            box-sizing: border-box;
        }
        
        input.letter-input { 
            width: 45px; 
            min-width: 45px; 
            max-width: 80px;
            text-transform: uppercase; 
            font-weight: bold; 
            color: var(--primary-dark); 
        }
        
        input.word-input { 
            min-width: 120px; 
            max-width: 400px;
            text-align: left; 
        }
        
        input.grammar-input { 
            min-width: 150px; 
            max-width: 500px;
            text-align: left; 
        }
        
        input.relative-input { 
            min-width: 80px; 
            max-width: 200px;
            text-align: center; 
        }
        
        input.passive-input { 
            min-width: 150px; 
            max-width: 600px;
            text-align: left; 
        }
        
        input.adjective-input { 
            min-width: 80px; 
            max-width: 300px;
            text-align: center; 
        }
        
        input.intensifier-input { 
            min-width: 60px; 
            max-width: 150px;
            text-align: center; 
        }
        
        input.correct { 
            border-bottom-color: var(--success) !important; 
            background-color: #e8f8f5 !important; 
            color: #1e8449 !important; 
        }
        
        input.incorrect-marked { 
            border-bottom-color: var(--error) !important; 
            background-color: #fdedec !important; 
        }

        .row-btns { 
            display: inline-flex; 
            gap: 5px; 
            vertical-align: middle; 
            margin-left: 10px; 
        }
        
        .btn-small { 
            background: #eee; 
            border: 1px solid #ccc; 
            border-radius: 4px; 
            width: 28px; 
            height: 28px; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 14px; 
            transition: 0.2s;
        }
        
        .btn-small:hover {
            background: #ddd;
        }
        
        .btn-small.active {
            background: #3498db;
            color: white;
            border-color: #2980b9;
        }
        
        .speaker-btn {
            background: #3498db;
            color: white;
            border: none;
        }
        
        .speaker-btn:hover {
            background: #2980b9;
        }
        
        .speaker-btn.active {
            background: #1c5982;
        }
        
        .info-btn { 
            background: #95a5a6; 
            color: white; 
            border: none; 
            border-radius: 50%; 
            width: 20px; 
            height: 20px; 
            font-size: 11px; 
            cursor: pointer; 
            display: inline-flex; 
            align-items: center; 
            justify-content: center; 
            transition: 0.2s;
        }
        
        .info-btn:hover {
            background: #7f8c8d;
        }
        
        .info-btn.active {
            background: #5d6d6e;
        }
        
        .hint-box { 
            display: none; 
            margin-top: 8px; 
            padding: 10px; 
            background-color: #fef9e7; 
            border-left: 4px solid var(--warning); 
            color: #7d6608; 
            border-radius: 4px; 
            font-size: 0.85em; 
        }
        
        .ipa-box {
            display: none;
            margin-top: 8px;
            padding: 10px;
            background-color: #f8f9fa;
            border-left: 4px solid #3498db;
            color: #2c3e50;
            border-radius: 4px;
            font-size: 0.9em;
            font-family: 'Times New Roman', serif;
        }
        
        .ipa-label {
            font-weight: bold;
            color: #3498db;
            margin-right: 5px;
        }
        
        .ipa-text {
            font-family: 'Times New Roman', serif;
            font-style: italic;
        }

        .controls-row { 
            display: flex; 
            justify-content: flex-end; 
            gap: 10px; 
            margin-top: 15px; 
        }
        
        .btn { 
            padding: 8px 20px; 
            border-radius: 6px; 
            cursor: pointer; 
            border: none; 
            font-weight: bold; 
            transition: 0.3s; 
        }
        
        .btn-reset { 
            background: #95a5a6; 
            color: white; 
        }
        
        .btn-show-all { 
            background: var(--primary); 
            color: white; 
        }
        
        .check-all-btn { 
            position: fixed; 
            right: 30px; 
            bottom: 30px; 
            background-color: var(--success); 
            color: white; 
            padding: 15px 30px; 
            border-radius: 50px; 
            cursor: pointer; 
            z-index: 1000; 
            font-weight: bold; 
            border: none; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.2); 
        }
        
        /* Grammar reference section */
        .grammar-reference {
            background-color: #f8f9fa;
            border-left: 4px solid var(--primary);
            padding: 15px;
            margin-top: 25px;
            border-radius: 0 8px 8px 0;
            font-size: 0.9em;
        }
        
        .grammar-reference h3 {
            margin-top: 0;
            color: var(--primary-dark);
            font-size: 1.1em;
        }
        
        .grammar-reference table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        
        .grammar-reference th {
            background-color: #e3f2fd;
            padding: 10px;
            text-align: left;
            border: 1px solid #ddd;
        }
        
        .grammar-reference td {
            padding: 10px;
            border: 1px solid #ddd;
        }
        
        .grammar-reference ul {
            padding-left: 20px;
        }
        
        .grammar-reference li {
            margin-bottom: 8px;
        }
        
        .reference-note {
            font-style: italic;
            color: #7f8c8d;
            font-size: 0.85em;
            margin-top: 10px;
            text-align: center;
            border-top: 1px solid #eee;
            padding-top: 10px;
        }
        
        /* Exercise numbering */
        .instructions {
            color: #7f8c8d;
            font-size: 0.95em;
            margin-bottom: 15px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }
        
        /* Number handling - preserves existing numbers */
        .existing-number {
            font-weight: bold;
            color: var(--primary);
            margin-right: 8px;
        }
        
        /* Definitions column styling - UPDATED WITH SCROLL */
        .definitions-column {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            height: 500px; /* Fixed height for scrollable area */
            overflow-y: auto; /* Enable vertical scrolling */
        }
        
        /* Custom scrollbar styling */
        .definitions-column::-webkit-scrollbar {
            width: 8px;
        }
        
        .definitions-column::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        .definitions-column::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }
        
        .definitions-column::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        
        .definition-item {
            margin-bottom: 12px;
            padding: 8px;
            border-bottom: 1px solid #eee;
            background-color: white;
            border-radius: 4px;
            min-height: 40px; /* Ensure consistent height */
        }
        
        .definition-letter {
            font-weight: bold;
            color: var(--primary);
            margin-right: 10px;
            min-width: 20px;
            display: inline-block;
        }
        
        .definition-text {
            display: inline;
        }
        
        /* Relative clauses specific styling */
        .relative-sentence {
            font-family: 'Times New Roman', serif;
        }
        
        .relative-gap {
            background-color: #f8f9fa;
            border-radius: 4px;
            padding: 0 4px;
        }
        
        /* Passive voice specific styling */
        .passive-exercise {
            margin-bottom: 20px;
        }
        
        .original-sentence {
            font-style: italic;
            color: #666;
            margin-bottom: 5px;
        }
        
        .passive-transformation {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }
        
        .passive-arrow {
            color: var(--primary);
            font-weight: bold;
            margin: 0 10px;
        }
        
        /* Adjective forms specific styling */
        .adjective-exercise {
            font-family: 'Times New Roman', serif;
        }
        
        .adjective-hint {
            font-style: italic;
            color: #7f8c8d;
            font-size: 0.9em;
            margin-left: 5px;
        }
        
        /* So/such/enough specific styling */
        .intensifier-sentence {
            font-family: 'Times New Roman', serif;
        }
        
        /* Long text handling for inputs */
        .long-answer {
            font-size: 0.95em;
            letter-spacing: 0.3px;
        }
    </style>
</head>
<body>

<div class="container">
    <h1 style="text-align: center; color: var(--primary-dark); margin-bottom: 30px;">Access 4 - Module 4b</h1>
    
    <!-- Grammar Reference Section -->
    <div class="exercise-card">
        <div class="exercise-title">Grammar Reference & Study Notes</div>
        <div class="grammar-reference">
            <h3>Relative Pronouns:</h3>
            <table>
                <tr>
                    <th>Pronoun</th>
                    <th>Use</th>
                    <th>Example</th>
                </tr>
                <tr>
                    <td><strong>who</strong></td>
                    <td>For people (subject)</td>
                    <td>The man who lives next door is a teacher.</td>
                </tr>
                <tr>
                    <td><strong>which</strong></td>
                    <td>For animals and things</td>
                    <td>The book which is on the table is mine.</td>
                </tr>
                <tr>
                    <td><strong>that</strong></td>
                    <td>For people, animals and things (informal)</td>
                    <td>The car that I bought is red.</td>
                </tr>
                <tr>
                    <td><strong>where</strong></td>
                    <td>For places</td>
                    <td>This is the house where I was born.</td>
                </tr>
                <tr>
                    <td><strong>when</strong></td>
                    <td>For times</td>
                    <td>I remember the day when we first met.</td>
                </tr>
            </table>
            
            <h3>Passive Voice:</h3>
            <p><strong>Structure:</strong> Subject + be + past participle (+ by agent)</p>
            <p><strong>Active to Passive Transformation:</strong></p>
            <ul>
                <li>Active: Subject + verb + object</li>
                <li>Passive: Object + be + past participle + (by + subject)</li>
            </ul>
            <p><strong>Tense Preservation:</strong> The tense of the verb "be" changes according to the original tense.</p>
            
            <h3>Comparative and Superlative Forms:</h3>
            <table>
                <tr>
                    <th>Form</th>
                    <th>Rule</th>
                    <th>Example</th>
                </tr>
                <tr>
                    <td><strong>Comparative (-er)</strong></td>
                    <td>For comparing two things</td>
                    <td>big ‚Üí bigger, happy ‚Üí happier</td>
                </tr>
                <tr>
                    <td><strong>Superlative (-est)</strong></td>
                    <td>For comparing three or more things</td>
                    <td>big ‚Üí biggest, happy ‚Üí happiest</td>
                </tr>
                <tr>
                    <td><strong>As...as</strong></td>
                    <td>For equal comparisons</td>
                    <td>as tall as, as quickly as</td>
                </tr>
                <tr>
                    <td><strong>Irregular forms</strong></td>
                    <td>Special forms to memorize</td>
                    <td>good ‚Üí better ‚Üí best, bad ‚Üí worse ‚Üí worst</td>
                </tr>
            </table>
            
            <h3>So, Such, and Enough:</h3>
            <table>
                <tr>
                    <th>Structure</th>
                    <th>Use</th>
                    <th>Example</th>
                </tr>
                <tr>
                    <td><strong>so + adjective</strong></td>
                    <td>To show degree or result</td>
                    <td>It's so cold that I need a coat.</td>
                </tr>
                <tr>
                    <td><strong>such + (a/an) + adjective + noun</strong></td>
                    <td>To emphasize quality</td>
                    <td>She is such a good singer.</td>
                </tr>
                <tr>
                    <td><strong>adjective + enough</strong></td>
                    <td>To show sufficient degree</td>
                    <td>He is tall enough to reach the shelf.</td>
                </tr>
                <tr>
                    <td><strong>enough + noun</strong></td>
                    <td>To show sufficient quantity</td>
                    <td>We have enough food for everyone.</td>
                </tr>
            </table>
            
            <p class="reference-note">Grammar references based on Cambridge English Grammar in Use and Oxford English Grammar Course.</p>
        </div>
    </div>

    <!-- TASK 1: Vocabulary Matching -->
    <div class="exercise-card" id="card-t1">
        <div class="exercise-title">Task 1: Vocabulary Matching ‚Äì Match the word to its definition</div>
        <div class="instructions">Match the vocabulary word on the left with its definition on the right by entering the correct letter (A-L) in the box.</div>
        
        <div class="matching-grid">
            <div id="vocab-t1"></div>
            <div class="definitions-column">
                <div id="def-t1"></div>
            </div>
        </div>
        <div class="controls-row">
            <button class="btn btn-show-all" onclick="showAnswers('t1')">Show All</button>
            <button class="btn btn-reset" onclick="resetSection('t1')">Reset</button>
        </div>
    </div>

    <!-- TASK 2: Gap-fill with Word Bank -->
    <div class="exercise-card" id="card-t2">
        <div class="exercise-title">Task 2: Filling in the gaps using vocabulary from task 1</div>
        <div class="instructions">Complete each sentence by dragging and dropping the correct word from the word bank or typing it in the gap.</div>
        
        <!-- Sticky Word Bank -->
        <div class="sticky-bank" id="bank-t2"></div>
        
        <!-- Questions -->
        <div id="questions-t2"></div>
        <div class="controls-row">
            <button class="btn btn-show-all" onclick="showAnswers('t2')">Show All</button>
            <button class="btn btn-reset" onclick="resetSection('t2')">Reset</button>
        </div>
    </div>

    <!-- TASK 3: Relative Clauses -->
    <div class="exercise-card" id="card-t3">
        <div class="exercise-title">Task 3: Relative clauses ‚Äì Fill in the relative pronoun</div>
        <div class="instructions">Complete each sentence with the correct relative pronoun (who, which, that, where, when). Pay attention to what the pronoun refers to (person, thing, place, time).</div>
        <div id="questions-t3"></div>
        <div class="controls-row">
            <button class="btn btn-show-all" onclick="showAnswers('t3')">Show All</button>
            <button class="btn btn-reset" onclick="resetSection('t3')">Reset</button>
        </div>
    </div>

    <!-- TASK 4: Passive Voice -->
    <div class="exercise-card" id="card-t4">
        <div class="exercise-title">Task 4: Rewrite each sentence in the passive form using the tense or structure given.</div>
        <div class="instructions">Rewrite each sentence in the passive voice. The tense or structure you should use is indicated in the instructions.</div>
        <div id="questions-t4"></div>
        <div class="controls-row">
            <button class="btn btn-show-all" onclick="showAnswers('t4')">Show All</button>
            <button class="btn btn-reset" onclick="resetSection('t4')">Reset</button>
        </div>
    </div>

    <!-- TASK 5: Adjective/Adverb Forms -->
    <div class="exercise-card" id="card-t5">
        <div class="exercise-title">Task 5: Complete each sentence with the correct form of the adjective or adverb in brackets.</div>
        <div class="instructions">Complete each sentence with the correct comparative (-er), superlative (-est), or "as...as" form of the adjective or adverb given in brackets.</div>
        <div id="questions-t5"></div>
        <div class="controls-row">
            <button class="btn btn-show-all" onclick="showAnswers('t5')">Show All</button>
            <button class="btn btn-reset" onclick="resetSection('t5')">Reset</button>
        </div>
    </div>

    <!-- TASK 6: So/Such/Enough -->
    <div class="exercise-card" id="card-t6">
        <div class="exercise-title">Task 6: Complete each sentence with so, such, or enough.</div>
        <div class="instructions">Complete each sentence with so, such, or enough. Use the correct structure according to the context.</div>
        <div id="questions-t6"></div>
        <div class="controls-row">
            <button class="btn btn-show-all" onclick="showAnswers('t6')">Show All</button>
            <button class="btn btn-reset" onclick="resetSection('t6')">Reset</button>
        </div>
    </div>
</div>

<button class="check-all-btn" onclick="checkAll()">CHECK ALL ANSWERS (ENTER)</button>

<script>
/* --- DATA --- */

// Task 1: Vocabulary Matching ‚Äì Match the word to its definition - STRUCTURE PATTERN: { v, letter, def, hint, ipa }
const t1_data = [
    { v: "1. fabric", letter: "D", def: "cloth or material used to make clothing", hint: "Fabric is what clothes are made from. Examples: cotton, silk, wool.", ipa: "/Ààf√¶br…™k/" },
    { v: "2. synthetic", letter: "C", def: "material made by humans rather than occurring naturally", hint: "Synthetic materials are man-made, not found in nature. Examples: polyester, nylon.", ipa: "/s…™nÀàŒ∏et…™k/" },
    { v: "3. environmentally-friendly", letter: "J", def: "designed to cause little harm to the natural world", hint: "Products that are good for the environment. Also called 'eco-friendly'.", ipa: "/…™nÀåva…™r…ônÀàment…ôli Ààfrendli/" },
    { v: "4. pesticides", letter: "A", def: "chemical substances used to kill insects that damage crops", hint: "Farmers use pesticides to protect plants from insects, but they can harm the environment.", ipa: "/Ààpest…™sa…™dz/" },
    { v: "5. end up", letter: "F", def: "to arrive in a particular place or situation, often unexpectedly", hint: "Often used to talk about final results or destinations. Example: 'If you litter, it might end up in the ocean.'", ipa: "/end  åp/" },
    { v: "6. contaminate", letter: "I", def: "to make water, air, or land dirty or unsafe by adding harmful substances", hint: "Pollution contaminates the environment. Contaminated water is not safe to drink.", ipa: "/k…ônÀàt√¶m…™ne…™t/" },
    { v: "7. organic", letter: "G", def: "produced without using artificial chemicals or pesticides", hint: "Organic food is grown naturally without chemicals. It's better for health and environment.", ipa: "/…îÀêrÀà…°√¶n…™k/" },
    { v: "8. eco-fleece", letter: "K", def: "a type of fleece made from recycled plastic bottles", hint: "Eco-fleece is an environmentally-friendly material made from recycled plastic. It keeps you warm.", ipa: "/ÀàiÀêko ä fliÀês/" },
    { v: "9. flake", letter: "H", def: "a small thin piece that breaks off from something larger", hint: "Flakes are small pieces. Snow flakes, corn flakes, or plastic flakes in recycling.", ipa: "/fle…™k/" },
    { v: "10. fibers", letter: "E", def: "long, thin strands that can be spun into thread or yarn", hint: "Fibers are the basic units of fabric. Natural fibers: cotton, wool. Synthetic fibers: polyester.", ipa: "/Ààfa…™b…ôrz/" },
    { v: "11. weave", letter: "L", def: "to make cloth by crossing threads together", hint: "Weaving is the process of making fabric by crossing threads over and under each other.", ipa: "/wiÀêv/" },
    { v: "12. cozy", letter: "B", def: "soft, warm, and comfortable, especially in cold weather", hint: "Cozy describes something that makes you feel warm and comfortable. A cozy sweater, a cozy room.", ipa: "/Ààko äzi/" }
];

// Task 2: Filling in the gaps using vocabulary from task 1
const t2_data = [
    { 
        q: "1. Cotton ______ is commonly used to make shirts, trousers, and other everyday clothes.", 
        ans: "fabric", 
        hint: "Cotton is a type of natural fabric. The sentence describes what cotton is used for.",
        wordBankIndex: 0
    },
    { 
        q: "2. Materials such as nylon and polyester are ______ and do not break down easily in nature.", 
        ans: "synthetic", 
        hint: "Nylon and polyester are man-made materials, not natural. They are slow to decompose.",
        wordBankIndex: 1
    },
    { 
        q: "3. Choosing reusable products is an ______ way to reduce environmental damage.", 
        ans: "environmentally-friendly", 
        hint: "Reusable products are better for the environment. They help reduce waste.",
        wordBankIndex: 2
    },
    { 
        q: "4. Farmers may use ______ to protect crops from insects, but this can harm the environment.", 
        ans: "pesticides", 
        hint: "Pesticides kill insects that damage crops, but they can also harm other animals and plants.",
        wordBankIndex: 3
    },
    { 
        q: "5. If rubbish is not recycled properly, it may ______ in rivers or oceans.", 
        ans: "end up", 
        hint: "This phrase describes where rubbish finally goes if not handled correctly.",
        wordBankIndex: 4
    },
    { 
        q: "6. Industrial waste can ______ soil and water, making them unsafe for humans and animals.", 
        ans: "contaminate", 
        hint: "Industrial waste contains chemicals that can pollute or make soil and water dangerous.",
        wordBankIndex: 5
    },
    { 
        q: "7. ______ food and cotton are grown without harmful chemicals or pesticides.", 
        ans: "organic", 
        hint: "Organic farming avoids synthetic chemicals. It's better for health and environment.",
        wordBankIndex: 6
    },
    { 
        q: "8. ______ is made from recycled plastic bottles and is often used to produce warm jackets.", 
        ans: "eco-fleece", 
        hint: "Eco-fleece is a specific material made from recycled plastic. It's used for warm clothing.",
        wordBankIndex: 7
    },
    { 
        q: "9. During recycling, plastic bottles are broken into small ______ before being processed.", 
        ans: "flakes", 
        hint: "Plastic is often shredded into small pieces (flakes) before being melted and reused.",
        wordBankIndex: 8
    },
    { 
        q: "10. Natural ______ such as cotton and wool are spun into thread to make yarn.", 
        ans: "fibers", 
        hint: "Cotton and wool are examples of natural fibers. Fibers are made into thread or yarn.",
        wordBankIndex: 9
    },
    { 
        q: "11. In traditional factories, workers ______ threads together to produce cloth.", 
        ans: "weave", 
        hint: "Weaving is the traditional method of making cloth by interlacing threads.",
        wordBankIndex: 10
    },
    { 
        q: "12. This jacket feels ______ and warm, which makes it ideal for cold weather.", 
        ans: "cozy", 
        hint: "Cozy describes the comfortable, warm feeling of clothing in cold weather.",
        wordBankIndex: 11
    }
];

// Task 2 Word Bank (for drag and drop)
const t2_wordBank = [
    "fabric", "synthetic", "environmentally-friendly", "pesticides", 
    "end up", "contaminate", "organic", "eco-fleece", 
    "flakes", "fibers", "weave", "cozy"
];

// Task 3: Relative clauses ‚Äì Fill in the relative pronoun
const t3_data = [
    { 
        q: "1. Eco-fleece is a material ______ is made from recycled plastic bottles.", 
        ans: "which|that", 
        hint: "'Material' is a thing, so use 'which' or 'that'. 'That' is more common in informal English." 
    },
    { 
        q: "2. Farmers ______ grow organic cotton do not use harmful chemicals.", 
        ans: "who|that", 
        hint: "'Farmers' are people, so use 'who' or 'that'. 'Who' is more formal for people." 
    },
    { 
        q: "3. This is the factory ______ eco-friendly clothes are produced.", 
        ans: "where", 
        hint: "The factory is a place, so use 'where' to refer to location." 
    },
    { 
        q: "4. Synthetic fabrics ______ are cheap can cause environmental problems.", 
        ans: "which|that", 
        hint: "'Fabrics' are things, so use 'which' or 'that'. Both are correct here." 
    },
    { 
        q: "5. People ______ care about the environment often choose organic clothing.", 
        ans: "who|that", 
        hint: "'People' are persons, so use 'who' or 'that'. 'Who' emphasizes they are people." 
    }
];

// Task 4: Passive Voice Transformation
const t4_data = [
    { 
        q: "1. People recycle plastic bottles to make eco-fleece.<br>‚Üí Plastic bottles ______.", 
        ans: "are recycled to make eco-fleece", 
        hint: "Present simple passive: am/is/are + past participle. 'Recycle' becomes 'are recycled'." 
    },
    { 
        q: "2. Factories must reduce chemical waste.<br>‚Üí Chemical waste ______.", 
        ans: "must be reduced", 
        hint: "Modal passive: modal + be + past participle. 'Must reduce' becomes 'must be reduced'." 
    },
    { 
        q: "3. Workers wove natural fibers into fabric.<br>‚Üí Natural fibers ______.", 
        ans: "were woven into fabric", 
        hint: "Past simple passive: was/were + past participle. 'Wove' (past of weave) becomes 'were woven'." 
    }
];

// Task 5: Adjective/Adverb Forms - C·∫¨P NH·∫¨T V·ªöI C√ÇU 4 S·ª¨A TH√ÄNH "most environmentally friendly"
const t5_data = [
    { 
        q: "1. Bamboo clothing is ______ (soft) than synthetic fabric.", 
        ans: "softer", 
        hint: "Comparative form for one-syllable adjective: add -er. Soft ‚Üí softer." 
    },
    { 
        q: "2. Organic cotton is ______ (safe) for the environment than conventional cotton.", 
        ans: "safer", 
        hint: "Comparative form: safe ‚Üí safer (note: drop -e, add -er)." 
    },
    { 
        q: "3. Eco-fleece jackets keep people ______ (warm) than thin cotton clothes.", 
        ans: "warmer", 
        hint: "Comparative form: warm ‚Üí warmer. One syllable, add -er." 
    },
    { 
        q: "4. Bamboo fabric is the ______ (environmentally friendly) material mentioned in the text.", 
        ans: "most environmentally friendly", 
        hint: "Superlative form for long adjective: most + adjective. 'The most environmentally friendly'." 
    },
    { 
        q: "5. Among all types of clothing, synthetic fabric is the ______ (harmful) to the environment.", 
        ans: "most harmful", 
        hint: "Superlative form for two-syllable adjective: most + adjective. Harmful ‚Üí most harmful." 
    },
    { 
        q: "6. Eco-fleece is ______ (warm) as wool in cold weather.", 
        ans: "as warm", 
        hint: "Equal comparison: as + adjective + as. 'As warm as' means equally warm." 
    }
];

// Task 6: So/Such/Enough
const t6_data = [
    { 
        q: "1. Eco-fleece is ______ warm that it is suitable for winter clothing.", 
        ans: "so", 
        hint: "so + adjective + that: shows result or consequence." 
    },
    { 
        q: "2. Organic cotton is ______ a popular material that many brands use it.", 
        ans: "such", 
        hint: "such + a/an + adjective + noun + that: emphasizes quality." 
    },
    { 
        q: "3. These clothes are ______ expensive that many people cannot afford them.", 
        ans: "so", 
        hint: "so + adjective + that: shows degree (expensive to the point that...)." 
    },
    { 
        q: "4. Bamboo fabric is ______ soft that it feels comfortable on the skin.", 
        ans: "so", 
        hint: "so + adjective + that: shows result or quality." 
    },
    { 
        q: "5. This jacket is not thick ______ to keep you warm in very cold weather.", 
        ans: "enough", 
        hint: "adjective + enough + to: shows sufficient degree for purpose." 
    },
    { 
        q: "6. They use ______ eco-friendly materials that the factory produces very little waste.", 
        ans: "such", 
        hint: "such + adjective + noun (plural) + that: emphasizes the type of materials." 
    },
    { 
        q: "7. The fabric is light ______ to wear during hot summer days.", 
        ans: "enough", 
        hint: "adjective + enough + to: shows sufficient quality for purpose." 
    },
    { 
        q: "8. Synthetic clothes are ______ cheap that people buy them easily.", 
        ans: "so", 
        hint: "so + adjective + that: shows result or consequence." 
    },
    { 
        q: "9. He does not have ______ money to buy expensive clothes.", 
        ans: "enough", 
        hint: "enough + noun: shows sufficient quantity." 
    },
    { 
        q: "10. It was ______ a successful recycling program that waste was reduced greatly.", 
        ans: "such", 
        hint: "such + a/an + adjective + noun + that: emphasizes the success." 
    }
];

/* --- GLOBAL STATE --- */
let currentActiveIPA = null;
let answerStates = new Map(); // Track answer states for toggling
let wordUsageCount = {}; // Track word usage for word bank management

/* --- RENDERING FUNCTIONS --- */

function renderMatching(id, data) {
    const v = document.getElementById(`vocab-${id}`); 
    const d = document.getElementById(`def-${id}`);
    
    // Clear existing content
    v.innerHTML = '';
    d.innerHTML = '';
    
    // Create definitions list in alphabetical order (A, B, C, D, etc.)
    const definitions = {};
    data.forEach(item => {
        definitions[item.letter] = item.def;
    });
    
    // Sort definitions by letter (A, B, C, D, etc.)
    const sortedLetters = Object.keys(definitions).sort();
    sortedLetters.forEach(letter => {
        d.innerHTML += `
            <div class="definition-item">
                <span class="definition-letter">${letter}.</span>
                <span class="definition-text">${definitions[letter]}</span>
            </div>`;
    });
    
    // Render vocabulary items in numerical order with IPA support
    data.forEach((item, i) => {
        const qid = `${id}-q${i}`;
        
        v.innerHTML += `
            <div class="vocab-item">
                <span class="vocab-text">${item.v}</span>
                <input type="text" class="letter-input" id="${qid}" data-type="input" data-ans="${item.letter}" maxlength="1" oninput="adjustWidth(this)">
                <div class="row-btns">
                    <button class="btn-small" id="${qid}-eye" onclick="toggleSingleAns('${qid}')" title="Show/Hide answer">üëÅÔ∏è</button>
                    <button class="btn-small speaker-btn" onclick="toggleIPA('${qid}')" title="Show pronunciation">üîä</button>
                    <button class="info-btn" id="${qid}-info" onclick="toggleHint('${qid}')" title="Show/Hide hint">i</button>
                </div>
                <div class="hint-box" id="${qid}-hint">üí° ${item.hint}</div>
                <div class="ipa-box" id="${qid}-ipa">
                    <span class="ipa-label">IPA:</span>
                    <span class="ipa-text">${item.ipa}</span>
                </div>
            </div>`;
    });
}

function renderGapFillWithWordBank(id, data, wordBank) {
    const container = document.getElementById(`questions-${id}`);
    const bankContainer = document.getElementById(`bank-${id}`);
    
    // Clear existing content
    container.innerHTML = '';
    bankContainer.innerHTML = '';
    
    // Initialize word usage count
    wordUsageCount[id] = {};
    wordBank.forEach(word => {
        wordUsageCount[id][word] = 0;
    });
    
    // Render word bank items
    wordBank.forEach((word, i) => {
        const wordId = `${id}-word-${i}`;
        bankContainer.innerHTML += `
            <div class="word-item" id="${wordId}" data-word="${word}" draggable="true" ondragstart="dragWord(event)" onclick="selectWordFromBank('${wordId}')">
                ${word.toLowerCase()}
            </div>`;
    });
    
    // Render questions
    data.forEach((it, i) => {
        const qid = `${id}-q${i}`;
        
        // Check if sentence already has a number
        let sentence = it.q;
        let numberHtml = '';
        const numberMatch = sentence.match(/^(\d+)\.\s+/);
        
        if (numberMatch) {
            // Remove the number from the sentence and use it
            sentence = sentence.replace(/^\d+\.\s+/, '');
            numberHtml = `<span class="existing-number">${numberMatch[1]}.</span>`;
        } else {
            // Use automatic numbering
            numberHtml = `<span class="exercise-number">${i+1}</span>`;
        }
        
        // Replace gap with input field
        const parts = sentence.split('______');
        
        container.innerHTML += `
            <div class="question-row" id="${qid}-row">
                ${numberHtml} 
                ${parts[0]}
                <input type="text" class="word-input" id="${qid}" data-type="input" data-ans="${it.ans}" data-word-bank-index="${it.wordBankIndex}" oninput="adjustWidth(this); updateWordBank('${id}')" ondrop="dropWord(event, '${qid}')" ondragover="allowDrop(event)" onclick="this.select()">
                ${parts[1]}
                <div class="row-btns">
                    <button class="btn-small" id="${qid}-eye" onclick="toggleSingleAns('${qid}')">üëÅÔ∏è</button>
                    <button class="info-btn" id="${qid}-info" onclick="toggleHint('${qid}')">i</button>
                </div>
                <div class="hint-box" id="${qid}-hint">üí° ${it.hint}</div>
            </div>`;
    });
    
    // Add event listeners for drag and drop
    addWordBankEventListeners(id);
}

function renderRelativeClauses(id, data) {
    const container = document.getElementById(`questions-${id}`);
    
    // Clear existing content
    container.innerHTML = '';
    
    // Render relative clause exercises
    data.forEach((it, i) => {
        const qid = `${id}-q${i}`;
        
        // Check if sentence already has a number
        let sentence = it.q;
        let numberHtml = '';
        const numberMatch = sentence.match(/^(\d+)\.\s+/);
        
        if (numberMatch) {
            // Remove the number from the sentence and use it
            sentence = sentence.replace(/^\d+\.\s+/, '');
            numberHtml = `<span class="existing-number">${numberMatch[1]}.</span>`;
        } else {
            // Use automatic numbering
            numberHtml = `<span class="exercise-number">${i+1}</span>`;
        }
        
        // Replace the single gap with input field
        const parts = sentence.split('______');
        
        container.innerHTML += `
            <div class="question-row">
                ${numberHtml} 
                <span class="relative-sentence">
                    ${parts[0]}
                    <input type="text" class="relative-input" id="${qid}" data-type="input" data-ans="${it.ans}" oninput="adjustWidth(this)">
                    ${parts[1]}
                </span>
                <div class="row-btns">
                    <button class="btn-small" id="${qid}-eye" onclick="toggleSingleAns('${qid}')">üëÅÔ∏è</button>
                    <button class="info-btn" id="${qid}-info" onclick="toggleHint('${qid}')">i</button>
                </div>
                <div class="hint-box" id="${qid}-hint">üí° ${it.hint}</div>
            </div>`;
    });
}

function renderPassiveVoice(id, data) {
    const container = document.getElementById(`questions-${id}`);
    
    // Clear existing content
    container.innerHTML = '';
    
    // Render passive voice transformation exercises
    data.forEach((it, i) => {
        const qid = `${id}-q${i}`;
        
        // Check if sentence already has a number
        let sentence = it.q;
        let numberHtml = '';
        const numberMatch = sentence.match(/^(\d+)\.\s+/);
        
        if (numberMatch) {
            // Remove the number from the sentence and use it
            sentence = sentence.replace(/^\d+\.\s+/, '');
            numberHtml = `<span class="existing-number">${numberMatch[1]}.</span>`;
        } else {
            // Use automatic numbering
            numberHtml = `<span class="exercise-number">${i+1}</span>`;
        }
        
        // Split the sentence into original and transformation parts
        const parts = sentence.split('<br>‚Üí ');
        const original = parts[0];
        const transformation = parts[1] || '';
        
        container.innerHTML += `
            <div class="passive-exercise">
                <div class="question-row">
                    ${numberHtml} 
                    <div class="original-sentence">${original}</div>
                    <div class="passive-transformation">
                        <span class="passive-arrow">‚Üí</span>
                        ${transformation.replace('______', '<input type="text" class="passive-input" id="' + qid + '" data-type="input" data-ans="' + it.ans + '" oninput="adjustWidth(this)">')}
                        <div class="row-btns">
                            <button class="btn-small" id="${qid}-eye" onclick="toggleSingleAns('${qid}')">üëÅÔ∏è</button>
                            <button class="info-btn" id="${qid}-info" onclick="toggleHint('${qid}')">i</button>
                        </div>
                    </div>
                </div>
                <div class="hint-box" id="${qid}-hint">üí° ${it.hint}</div>
            </div>`;
    });
}

function renderAdjectiveForms(id, data) {
    const container = document.getElementById(`questions-${id}`);
    
    // Clear existing content
    container.innerHTML = '';
    
    // Render adjective form exercises
    data.forEach((it, i) => {
        const qid = `${id}-q${i}`;
        
        // Check if sentence already has a number
        let sentence = it.q;
        let numberHtml = '';
        const numberMatch = sentence.match(/^(\d+)\.\s+/);
        
        if (numberMatch) {
            // Remove the number from the sentence and use it
            sentence = sentence.replace(/^\d+\.\s+/, '');
            numberHtml = `<span class="existing-number">${numberMatch[1]}.</span>`;
        } else {
            // Use automatic numbering
            numberHtml = `<span class="exercise-number">${i+1}</span>`;
        }
        
        // Extract adjective hint from parentheses
        const adjHintMatch = sentence.match(/\(([^)]+)\)/);
        let displaySentence = sentence;
        let adjHint = '';
        
        if (adjHintMatch) {
            adjHint = adjHintMatch[1];
            // Remove the parentheses from display
            displaySentence = sentence.replace(/\(([^)]+)\)/, '');
        }
        
        // Replace the single gap with input field
        const parts = displaySentence.split('______');
        
        container.innerHTML += `
            <div class="question-row">
                ${numberHtml} 
                <span class="adjective-exercise">
                    ${parts[0]}
                    <input type="text" class="adjective-input" id="${qid}" data-type="input" data-ans="${it.ans}" oninput="adjustWidth(this)">
                    ${parts[1]}
                    ${adjHint ? `<span class="adjective-hint">(${adjHint})</span>` : ''}
                </span>
                <div class="row-btns">
                    <button class="btn-small" id="${qid}-eye" onclick="toggleSingleAns('${qid}')">üëÅÔ∏è</button>
                    <button class="info-btn" id="${qid}-info" onclick="toggleHint('${qid}')">i</button>
                </div>
                <div class="hint-box" id="${qid}-hint">üí° ${it.hint}</div>
            </div>`;
    });
}

function renderIntensifiers(id, data) {
    const container = document.getElementById(`questions-${id}`);
    
    // Clear existing content
    container.innerHTML = '';
    
    // Render so/such/enough exercises
    data.forEach((it, i) => {
        const qid = `${id}-q${i}`;
        
        // Check if sentence already has a number
        let sentence = it.q;
        let numberHtml = '';
        const numberMatch = sentence.match(/^(\d+)\.\s+/);
        
        if (numberMatch) {
            // Remove the number from the sentence and use it
            sentence = sentence.replace(/^\d+\.\s+/, '');
            numberHtml = `<span class="existing-number">${numberMatch[1]}.</span>`;
        } else {
            // Use automatic numbering
            numberHtml = `<span class="exercise-number">${i+1}</span>`;
        }
        
        // Replace the single gap with input field
        const parts = sentence.split('______');
        
        container.innerHTML += `
            <div class="question-row">
                ${numberHtml} 
                <span class="intensifier-sentence">
                    ${parts[0]}
                    <input type="text" class="intensifier-input" id="${qid}" data-type="input" data-ans="${it.ans}" oninput="adjustWidth(this)">
                    ${parts[1]}
                </span>
                <div class="row-btns">
                    <button class="btn-small" id="${qid}-eye" onclick="toggleSingleAns('${qid}')">üëÅÔ∏è</button>
                    <button class="info-btn" id="${qid}-info" onclick="toggleHint('${qid}')">i</button>
                </div>
                <div class="hint-box" id="${qid}-hint">üí° ${it.hint}</div>
            </div>`;
    });
}

/* --- UTILITY FUNCTIONS --- */

function adjustWidth(el) { 
    // Determine base width based on input type
    let baseWidth;
    if (el.classList.contains('letter-input')) {
        baseWidth = 45;
    } else if (el.classList.contains('relative-input')) {
        baseWidth = 80;
    } else if (el.classList.contains('adjective-input')) {
        baseWidth = 80;
    } else if (el.classList.contains('intensifier-input')) {
        baseWidth = 60;
    } else if (el.classList.contains('word-input')) {
        baseWidth = 120;
    } else if (el.classList.contains('passive-input')) {
        baseWidth = 150;
        // For long passive voice answers, use smaller font
        if (el.value.length > 30) {
            el.classList.add('long-answer');
        } else {
            el.classList.remove('long-answer');
        }
    } else if (el.classList.contains('grammar-input')) {
        baseWidth = 150;
    } else {
        baseWidth = 60;
    }
    
    // Calculate width based on content
    // Use character count with different multipliers for different input types
    let charWidth;
    if (el.classList.contains('passive-input')) {
        charWidth = 8; // Smaller for long sentences
    } else if (el.classList.contains('word-input') || el.classList.contains('grammar-input')) {
        charWidth = 9;
    } else {
        charWidth = 10;
    }
    
    const newWidth = Math.max(el.value.length * charWidth + 20, baseWidth);
    
    // Get max width based on input type
    let maxWidth;
    if (el.classList.contains('letter-input')) {
        maxWidth = 80;
    } else if (el.classList.contains('relative-input')) {
        maxWidth = 200;
    } else if (el.classList.contains('adjective-input')) {
        maxWidth = 300;
    } else if (el.classList.contains('intensifier-input')) {
        maxWidth = 150;
    } else if (el.classList.contains('word-input')) {
        maxWidth = 400;
    } else if (el.classList.contains('passive-input')) {
        maxWidth = 600; // Extra wide for passive voice sentences
    } else if (el.classList.contains('grammar-input')) {
        maxWidth = 500;
    } else {
        maxWidth = 300;
    }
    
    // Apply the calculated width with limits
    el.style.width = Math.min(newWidth, maxWidth) + "px";
}

function toggleHint(id) { 
    const h = document.getElementById(id + '-hint'); 
    const infoBtn = document.getElementById(id + '-info');
    
    if (h) {
        if (h.style.display === 'block') {
            h.style.display = 'none';
            if (infoBtn) infoBtn.classList.remove('active');
        } else {
            h.style.display = 'block';
            if (infoBtn) infoBtn.classList.add('active');
        }
    }
}

function toggleIPA(id) { 
    const ipaBox = document.getElementById(id + '-ipa'); 
    const speakerBtn = document.querySelector(`button[onclick="toggleIPA('${id}')"]`);
    
    // If clicking the same IPA box that's currently active, hide it
    if (currentActiveIPA === ipaBox) {
        ipaBox.style.display = 'none';
        currentActiveIPA = null;
        if (speakerBtn) speakerBtn.classList.remove('active');
        return;
    }
    
    // Hide previously active IPA box if exists
    if (currentActiveIPA) {
        const prevSpeakerBtn = document.querySelector(`button[onclick*="${currentActiveIPA.id.replace('-ipa', '')}"]`);
        if (prevSpeakerBtn) prevSpeakerBtn.classList.remove('active');
        currentActiveIPA.style.display = 'none';
    }
    
    // Show the clicked IPA box
    if (ipaBox) {
        ipaBox.style.display = 'block';
        currentActiveIPA = ipaBox;
        if (speakerBtn) speakerBtn.classList.add('active');
    }
}

function toggleSingleAns(id) { 
    const el = document.getElementById(id);
    const eyeBtn = document.getElementById(id + '-eye');
    
    if (!el) return;
    
    const ans = el.dataset.ans;
    const stateKey = `${id}-state`;
    
    // Check if answer is currently shown
    const isCurrentlyShown = answerStates.get(stateKey) || false;
    
    if (isCurrentlyShown) {
        // Hide the answer
        el.value = "";
        el.classList.remove('correct', 'incorrect-marked', 'long-answer');
        adjustWidth(el);
        if (eyeBtn) eyeBtn.classList.remove('active');
        answerStates.set(stateKey, false);
    } else {
        // Show the answer
        if (ans) {
            // For multiple answers separated by |, show the first one with exact case
            const firstAns = ans.split('|')[0];
            // IMPORTANT: Show answer with exact original capitalization
            el.value = firstAns;
            el.classList.add('correct');
            el.classList.remove('incorrect-marked');
            
            // Add long-answer class for very long answers
            if (firstAns.length > 30 && el.classList.contains('passive-input')) {
                el.classList.add('long-answer');
            }
            
            adjustWidth(el);
            if (eyeBtn) eyeBtn.classList.add('active');
            answerStates.set(stateKey, true);
        }
    }
}

function showAnswers(prefix) { 
    // Handle regular single-gap questions
    document.querySelectorAll(`[id^="${prefix}-q"]`).forEach(el => {
        if (el.dataset.type === 'input') {
            const stateKey = `${el.id}-state`;
            const ans = el.dataset.ans;
            const eyeBtn = document.getElementById(el.id + '-eye');
            
            if (ans) {
                const firstAns = ans.split('|')[0];
                el.value = firstAns;
                el.classList.add('correct');
                el.classList.remove('incorrect-marked');
                
                // Add long-answer class for very long answers
                if (firstAns.length > 30 && el.classList.contains('passive-input')) {
                    el.classList.add('long-answer');
                }
                
                adjustWidth(el);
                if (eyeBtn) eyeBtn.classList.add('active');
                answerStates.set(stateKey, true);
            }
        }
    });
}

function resetSection(prefix) { 
    document.querySelectorAll(`[id^="${prefix}"]`).forEach(i => { 
        if(i.tagName === 'INPUT') { 
            i.value = ""; 
            i.classList.remove('correct', 'incorrect-marked', 'long-answer'); 
            adjustWidth(i); 
        } 
        const hBox = document.getElementById(i.id + '-hint'); 
        if(hBox) hBox.style.display = 'none'; 
        const ipaBox = document.getElementById(i.id + '-ipa');
        if(ipaBox) ipaBox.style.display = 'none';
    });
    
    // Reset button states
    document.querySelectorAll(`[id$="-eye"], [id$="-info"]`).forEach(btn => {
        if (btn.id.includes(prefix)) {
            btn.classList.remove('active');
        }
    });
    
    // Reset global IPA state
    if (currentActiveIPA) {
        const speakerBtn = document.querySelector(`button[onclick*="${currentActiveIPA.id.replace('-ipa', '')}"]`);
        if (speakerBtn) speakerBtn.classList.remove('active');
        currentActiveIPA = null;
    }
    
    // Clear answer states for this section
    for (const [key, value] of answerStates.entries()) {
        if (key.startsWith(`${prefix}-`)) {
            answerStates.delete(key);
        }
    }
    
    // Reset word bank for Task 2
    if (prefix === 't2') {
        const wordItems = document.querySelectorAll('#bank-t2 .word-item');
        wordItems.forEach(item => {
            item.classList.remove('used');
            item.style.display = 'flex';
        });
        
        // Reset usage count
        if (wordUsageCount['t2']) {
            Object.keys(wordUsageCount['t2']).forEach(word => {
                wordUsageCount['t2'][word] = 0;
            });
        }
    }
}

function normalizeAnswer(answer) {
    // Remove extra spaces, convert to lowercase, remove punctuation
    // IMPORTANT: Case-insensitive comparison
    return answer.toLowerCase()
        .trim()
        .replace(/\s+/g, ' ')
        .replace(/[.,;:!?]$/, '');
}

function validateMultipleAnswers(userAnswer, correctAnswers) {
    // Split multiple answers by | and check if user answer matches any
    // IMPORTANT: Case-insensitive comparison
    const answers = correctAnswers.split('|').map(ans => normalizeAnswer(ans));
    const normalizedUser = normalizeAnswer(userAnswer);
    
    return answers.some(ans => ans === normalizedUser);
}

function checkAll() { 
    // Check text inputs
    document.querySelectorAll('[data-type="input"]').forEach(el => { 
        const correctAnswers = el.dataset.ans;
        const userAnswer = el.value;
        
        el.classList.remove('correct', 'incorrect-marked'); 
        
        if(!userAnswer.trim()) {
            // Empty answer, do nothing
            return;
        }
        
        // IMPORTANT: Case-insensitive validation
        if(validateMultipleAnswers(userAnswer, correctAnswers)) {
            el.classList.add('correct');
        } else {
            el.classList.add('incorrect-marked');
        }
    });
}

/* --- WORD BANK FUNCTIONS --- */

function addWordBankEventListeners(id) {
    const wordItems = document.querySelectorAll(`#bank-${id} .word-item`);
    const inputs = document.querySelectorAll(`#questions-${id} input.word-input`);
    
    wordItems.forEach(item => {
        item.addEventListener('click', function() {
            selectWordFromBank(this.id);
        });
        
        item.addEventListener('dragstart', function(e) {
            dragWord(e);
        });
    });
    
    inputs.forEach(input => {
        input.addEventListener('dragover', function(e) {
            allowDrop(e);
        });
        
        input.addEventListener('drop', function(e) {
            dropWord(e, this.id);
        });
    });
}

function dragWord(event) {
    event.dataTransfer.setData("text/plain", event.target.dataset.word);
    event.dataTransfer.setData("wordId", event.target.id);
}

function allowDrop(event) {
    event.preventDefault();
}

function dropWord(event, inputId) {
    event.preventDefault();
    const word = event.dataTransfer.getData("text/plain");
    const wordId = event.dataTransfer.getData("wordId");
    
    const input = document.getElementById(inputId);
    if (input) {
        input.value = word;
        adjustWidth(input);
        
        // Update word bank usage
        updateWordBankUsage(word, inputId.split('-')[0]);
    }
}

function selectWordFromBank(wordId) {
    const wordItem = document.getElementById(wordId);
    if (!wordItem) return;
    
    const word = wordItem.dataset.word;
    const taskId = wordId.split('-')[1];
    
    // Find the next empty input or let user choose
    const inputs = document.querySelectorAll(`#questions-t${taskId} input.word-input`);
    let emptyInput = null;
    
    for (const input of inputs) {
        if (!input.value.trim()) {
            emptyInput = input;
            break;
        }
    }
    
    if (emptyInput) {
        emptyInput.value = word;
        adjustWidth(emptyInput);
        
        // Update word bank usage
        updateWordBankUsage(word, `t${taskId}`);
    } else {
        // All inputs have values, let user replace one
        // For simplicity, we'll just alert the user
        alert('All gaps are filled. You can click on a gap to replace its content.');
    }
}

function updateWordBankUsage(word, taskId) {
    if (!wordUsageCount[taskId]) {
        wordUsageCount[taskId] = {};
    }
    
    if (!wordUsageCount[taskId][word]) {
        wordUsageCount[taskId][word] = 0;
    }
    
    // Count how many times this word is used in inputs
    const inputs = document.querySelectorAll(`#questions-${taskId} input.word-input`);
    let count = 0;
    
    inputs.forEach(input => {
        if (normalizeAnswer(input.value) === normalizeAnswer(word)) {
            count++;
        }
    });
    
    wordUsageCount[taskId][word] = count;
    
    // Update word bank display
    updateWordBankDisplay(taskId);
}

function updateWordBankDisplay(taskId) {
    const wordItems = document.querySelectorAll(`#bank-${taskId} .word-item`);
    
    wordItems.forEach(item => {
        const word = item.dataset.word;
        const count = wordUsageCount[taskId][word] || 0;
        
        // If word is used, hide it from the bank
        if (count > 0) {
            item.classList.add('used');
        } else {
            item.classList.remove('used');
        }
    });
}

function updateWordBank(taskId) {
    // Update word bank when user types directly into input
    const inputs = document.querySelectorAll(`#questions-${taskId} input.word-input`);
    
    // Reset all counts
    if (wordUsageCount[taskId]) {
        Object.keys(wordUsageCount[taskId]).forEach(word => {
            wordUsageCount[taskId][word] = 0;
        });
    }
    
    // Recalculate counts
    inputs.forEach(input => {
        const word = input.value.trim();
        if (word) {
            // Find matching word in bank (case-insensitive)
            const wordItems = document.querySelectorAll(`#bank-${taskId} .word-item`);
            let foundWord = null;
            
            wordItems.forEach(item => {
                if (normalizeAnswer(item.dataset.word) === normalizeAnswer(word)) {
                    foundWord = item.dataset.word;
                }
            });
            
            if (foundWord && wordUsageCount[taskId][foundWord] !== undefined) {
                wordUsageCount[taskId][foundWord]++;
            }
        }
    });
    
    // Update display
    updateWordBankDisplay(taskId);
}

/* --- INITIALIZATION --- */

window.onload = () => {
    renderMatching('t1', t1_data);
    renderGapFillWithWordBank('t2', t2_data, t2_wordBank);
    renderRelativeClauses('t3', t3_data);
    renderPassiveVoice('t4', t4_data);
    renderAdjectiveForms('t5', t5_data);
    renderIntensifiers('t6', t6_data);
};

/* --- KEYBOARD SUPPORT --- */

document.addEventListener('keydown', e => { 
    if(e.key === 'Enter') {
        checkAll(); 
    }
});

/* --- ADDITIONAL NOTES --- */


// IMPORTANT: When creating new code based on this template:
// 1. Preserve ALL technical requirement comments above
// 2. Add new requirements as additional numbered points
// 3. Maintain the same CSS structure and JavaScript architecture
// 4. Keep all existing functionality while adding new features
// 5. Test all interactive elements after modifications
// 6. Document any algorithm changes in the technical requirements section

// KEY CASE HANDLING RULES:
// 1. Word bank items: Always displayed in lowercase for visual consistency
// 2. Answer display: Show exact 'ans' property from data (preserves original case)
// 3. Validation: Uses normalizeAnswer() for case-insensitive comparison
// 4. User experience: No automatic case modification during input
// 5. This ensures proper nouns are displayed correctly when shown

// GAP DETECTION RULE:
// 1. Any occurrence of "______" (2 or more underscores) is automatically replaced
// 2. This handles variations in gap length from different sources
// 3. Input fields are inserted exactly where the underscores appear

// MATCHING EXERCISE TWO-COLUMN LAYOUT WITH IPA:
// 1. Left column: Vocabulary items with input boxes for matching letters
// 2. Right column: Definitions in alphabetical order (A, B, C, D, etc.) in a styled column
// 3. Each vocabulary item has three control buttons:
//    - üëÅÔ∏è Eye button (28x28px): Shows the correct answer
//    - üîä Speaker button (28x28px): Shows IPA pronunciation from authoritative dictionary
//    - (i) Info button (20x20px): Shows pedagogical hint
// 4. IPA pronunciation data comes from reliable dictionary sources (Oxford, Cambridge, Merriam-Webster)
// 5. IPA display appears in a dedicated box below each vocabulary item with distinct styling

// IPA SINGLE ACTIVE DISPLAY SYSTEM:
// 1. Only ONE IPA pronunciation box can be visible at a time across the entire application
// 2. Clicking a speaker button shows that word's IPA and automatically hides any other visible IPA box
// 3. Clicking the same speaker button again toggles (hides) its own IPA box
// 4. Global state variable (currentActiveIPA) tracks the currently active IPA box
// 5. This prevents visual clutter and ensures a clean, uncluttered interface

// DEFINITIONS COLUMN OPTIMIZATION:
// 1. Definitions column displays clean list without unnecessary headers or titles
// 2. Alphabetical ordering (A, B, C, D) maintained for easy reference
// 3. Visual hierarchy maintained through consistent styling and spacing
// 4. Column alignment optimized for readability and space efficiency
// 5. Clean, minimal design that focuses on content rather than decoration

// SCROLLABLE DEFINITIONS COLUMN FOR MATCHING EXERCISES:
// 1. Definitions column has independent vertical scrolling when content is too long
// 2. Fixed height (500px) with overflow-y: auto enables scrolling within the column
// 3. Custom scrollbar styling matches the design system with subtle appearance
// 4. Allows users to scroll through definitions while keeping vocabulary column fixed
// 5. Particularly useful when definitions are long or numerous
// 6. Scrollbar appears only when needed (auto overflow)

// WORD BANK MANAGEMENT FOR GAP-FILL EXERCISES:
// 1. Word bank appears in a sticky container at the top of Task 2
// 2. Words can be clicked or dragged and dropped into input fields
// 3. Used words are automatically hidden from the bank
// 4. Word usage is tracked to handle duplicate answers correctly
// 5. Users can also type directly into input fields

// RELATIVE CLAUSES EXERCISE FORMAT:
// 1. Special input type for relative pronouns with appropriate width
// 2. Multiple correct answers supported (e.g., "which|that")
// 3. Detailed grammar explanations in hints

// PASSIVE VOICE TRANSFORMATION:
// 1. Requires students to rewrite sentences in passive form
// 2. Includes tense preservation in the transformation
// 3. Comprehensive grammar explanations for passive voice formation

// ADJECTIVE/ADVERB COMPARATIVE FORMS:
// 1. Exercises for comparative (-er) and superlative (-est) forms
// 2. Includes "as...as" structure for equal comparisons
// 3. Handles regular and irregular forms appropriately

// SO/SUCH/ENOUGH STRUCTURES:
// 1. Practice with intensifiers and result clauses
// 2. Different grammatical structures (so + adj, such + noun, adj + enough)
// 3. Clear explanations for when to use each structure

// ADAPTIVE INPUT WIDTH EXPANSION:
// 1. Input fields automatically expand to show complete text content
// 2. Different character width multipliers for different input types:
//    - Short inputs (letter-input): 10px per character
//    - Medium inputs (word-input, grammar-input): 9px per character
//    - Long inputs (passive-input): 8px per character for better fit
// 3. Maximum width limits prevent excessive expansion:
//    - Letter inputs: max 80px
//    - Relative pronoun inputs: max 200px
//    - Adjective inputs: max 300px
//    - Word inputs: max 400px
//    - Passive voice inputs: max 600px (extra wide for long sentences)
//    - Grammar inputs: max 500px
// 4. Minimum widths ensure usability for empty fields
// 5. Special handling for very long answers (e.g., "most environmentally friendly"):
//    - Reduces font size slightly for better fit
//    - Uses smaller character width calculation
// 6. The adjustWidth() function dynamically recalculates on every input event
// 7. Box-sizing: border-box ensures padding is included in width calculations

// ALL TECHNICAL REQUIREMENTS from the original template are preserved
</script>
</body>
</html>
