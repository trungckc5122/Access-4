<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Access 4 - Module 4c</title>
    <style>
        :root {
            --primary: #2980b9;
            --primary-dark: #1c5982;
            --success: #27ae60;
            --error: #e74c3c;
            --warning: #f1c40f;
            --bg: #f4f7f9;
            --text: #2c3e50;
            --card: #ffffff;
            --selection: #3498db;
            --selection-bg: #ebf5fb;
        }

        body {
            font-family: 'Times New Roman', serif;
            font-size: 13pt;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px 20px 100px 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
        }

        .exercise-card {
            background: var(--card);
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            padding: 25px;
            margin-bottom: 30px;
        }

        .exercise-title {
            font-weight: bold;
            font-size: 1.25em;
            margin-bottom: 18px;
            color: var(--primary-dark);
            border-bottom: 2px solid #eee;
            padding-bottom: 8px;
        }

        .question-row {
            margin-bottom: 18px;
            line-height: 1.8;
            border-bottom: 1px solid #f9f9f9;
            padding-bottom: 10px;
            position: relative;
        }

        input[type="text"], textarea {
            border: none;
            border-bottom: 2px solid #bdc3c7;
            background: #fafafa;
            padding: 8px 12px;
            font-size: 1em;
            transition: 0.2s;
            outline: none;
            min-width: 200px;
            border-radius: 4px 4px 0 0;
            font-family: 'Times New Roman';
            box-sizing: border-box;
            margin: 5px 0;
        }
        
        textarea {
            width: 100%;
            min-height: 100px;
            resize: vertical;
        }

        .btn-small {
            background: #eee;
            border: 1px solid #ccc;
            border-radius: 4px;
            width: 28px;
            height: 28px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: 0.2s;
            margin-left: 10px;
        }

        .btn-small:hover {
            background: #ddd;
        }

        .btn-small.active {
            background: #3498db;
            color: white;
            border-color: #2980b9;
        }

        .hint-box {
            display: none;
            margin-top: 8px;
            padding: 10px;
            background-color: #fef9e7;
            border-left: 4px solid var(--warning);
            color: #7d6608;
            border-radius: 4px;
            font-size: 0.9em;
        }

        .controls-row {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 15px;
        }

        .btn {
            padding: 8px 20px;
            border-radius: 6px;
            cursor: pointer;
            border: none;
            font-weight: bold;
            transition: 0.3s;
        }

        .btn-show-all {
            background: var(--primary);
            color: white;
        }

        .btn-reset {
            background: #95a5a6;
            color: white;
        }

        .check-all-btn {
            position: fixed;
            right: 30px;
            bottom: 30px;
            background-color: var(--success);
            color: white;
            padding: 15px 30px;
            border-radius: 50px;
            cursor: pointer;
            z-index: 1000;
            font-weight: bold;
            border: none;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .advice-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }

        .advice-table th,
        .advice-table td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }

        .advice-table th {
            background-color: #e3f2fd;
            color: var(--primary-dark);
        }

        .advice-table td {
            vertical-align: top;
        }

        .result-cell {
            min-height: 60px;
        }

        .hidden-result {
            color: #7f8c8d;
            font-style: italic;
        }

        .result-text {
            color: #2c3e50;
            font-weight: normal;
        }
        
        .check-options {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin: 15px 0;
        }
        
        .check-btn {
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            border: 2px solid #ddd;
            font-weight: bold;
            background: white;
            transition: 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .check-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        
        .check-btn.basic {
            border-color: #3498db;
            color: #3498db;
        }
        
        .check-btn.grammar {
            border-color: #9b59b6;
            color: #9b59b6;
        }
        
        .check-btn.structure {
            border-color: #e67e22;
            color: #e67e22;
        }
        
        .check-btn.vocabulary {
            border-color: #2ecc71;
            color: #2ecc71;
        }
        
        .letter-preview {
            background-color: #f8f9fa;
            padding: 25px;
            border-radius: 8px;
            border-left: 4px solid var(--primary);
            margin: 20px 0;
            font-family: 'Times New Roman', serif;
            line-height: 1.8;
            white-space: pre-wrap;
        }
        
        .word-count {
            text-align: right;
            margin-top: 10px;
            color: #7f8c8d;
            font-size: 0.9em;
        }
        
        .score-display {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            text-align: center;
        }
        
        .score-number {
            font-size: 2.5em;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .score-text {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 25px;
            width: 90%;
            max-width: 700px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
        }
        
        .modal-title {
            font-size: 1.3em;
            color: var(--primary-dark);
            font-weight: bold;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #7f8c8d;
        }
        
        .loading {
            text-align: center;
            padding: 30px;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .issue-item {
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 6px;
            background: #f8f9fa;
            border-left: 4px solid var(--warning);
        }
        
        .issue-item.error {
            border-left-color: var(--error);
            background: #fdedec;
        }
        
        .issue-item.success {
            border-left-color: var(--success);
            background: #e8f8f5;
        }
        
        .writing-tips {
            background-color: #fff8e1;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #ff9800;
            margin: 15px 0;
        }
        
        .writing-tips ul {
            margin: 10px 0;
            padding-left: 20px;
        }
        
        .writing-tips li {
            margin-bottom: 8px;
        }
    </style>
</head>
<body>
<div class="container">
    <h1 style="text-align: center; color: var(--primary-dark); margin-bottom: 30px;">Access 4 - Module 4c: Writing ‚Äì Giving Advice</h1>

    <div class="exercise-card">
        <div class="exercise-title">Situation</div>
        <div style="background-color: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid var(--primary);">
            <p style="margin: 0; font-style: italic;">You read the following problem on a teen advice website:</p>
            <blockquote style="margin: 15px 0 0 20px; padding-left: 10px; border-left: 3px solid #ccc;">
                <p>"I don't like the way I look. I have pimples on my skin and I've gained a lot of weight. What can I do?"</p>
                <p style="text-align: right; color: #7f8c8d;">‚Äì Sarah (16), Detroit</p>
            </blockquote>
        </div>
    </div>

    <div class="exercise-card">
        <div class="exercise-title">1. Brainstorm ideas</div>
        <p><strong>Problems:</strong> pimples on skin, gained weight, low confidence</p>
        
        <table class="advice-table">
            <thead>
                <tr>
                    <th>Advice</th>
                    <th>Result if she follows</th>
                    <th>Hint</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Eat healthy food and drink more water</td>
                    <td class="result-cell" id="result1">
                        <span class="hidden-result">Click üëÅÔ∏è to see the result</span>
                        <span class="result-text" style="display: none;">Your skin can become clearer and you may lose some weight. Water helps remove toxins from your body.</span>
                    </td>
                    <td>
                        <button class="btn-small" onclick="toggleResult('result1')">üëÅÔ∏è</button>
                        <button class="btn-small" onclick="toggleHint('hint1')">i</button>
                        <div class="hint-box" id="hint1">
                            Eating fruits, vegetables, and drinking water helps your skin and body. It gives you vitamins and cleans your system.
                        </div>
                    </td>
                </tr>
                <tr>
                    <td>Exercise regularly</td>
                    <td class="result-cell" id="result2">
                        <span class="hidden-result">Click üëÅÔ∏è to see the result</span>
                        <span class="result-text" style="display: none;">You will feel stronger, lose weight, and have more energy. Exercise also reduces stress.</span>
                    </td>
                    <td>
                        <button class="btn-small" onclick="toggleResult('result2')">üëÅÔ∏è</button>
                        <button class="btn-small" onclick="toggleHint('hint2')">i</button>
                        <div class="hint-box" id="hint2">
                            Start with easy activities like walking or dancing. Regular exercise burns calories and makes you feel better.
                        </div>
                    </td>
                </tr>
                <tr>
                    <td>Get enough sleep</td>
                    <td class="result-cell" id="result3">
                        <span class="hidden-result">Click üëÅÔ∏è to see the result</span>
                        <span class="result-text" style="display: none;">Your skin will improve and your body can control weight better. Sleep helps your body repair itself.</span>
                    </td>
                    <td>
                        <button class="btn-small" onclick="toggleResult('result3')">üëÅÔ∏è</button>
                        <button class="btn-small" onclick="toggleHint('hint3')">i</button>
                        <div class="hint-box" id="hint3">
                            Teenagers need 8-10 hours of sleep each night. Good sleep reduces stress and helps your skin.
                        </div>
                    </td>
                </tr>
                <tr>
                    <td>Avoid comparing herself with others</td>
                    <td class="result-cell" id="result4">
                        <span class="hidden-result">Click üëÅÔ∏è to see the result</span>
                        <span class="result-text" style="display: none;">You will feel happier and more confident. Everyone's body is different and changes at different times.</span>
                    </td>
                    <td>
                        <button class="btn-small" onclick="toggleResult('result4')">üëÅÔ∏è</button>
                        <button class="btn-small" onclick="toggleHint('hint4')">i</button>
                        <div class="hint-box" id="hint4">
                            Social media often shows only perfect pictures. Real people have imperfections too.
                        </div>
                    </td>
                </tr>
            </tbody>
        </table>
        <div class="controls-row">
            <button class="btn btn-show-all" onclick="showAllResults()">Show All Results</button>
            <button class="btn btn-reset" onclick="resetAllResults()">Reset All</button>
        </div>
    </div>

    <div class="exercise-card">
        <div class="exercise-title">3. Required structure</div>
        <div style="background-color: #f8f9fa; padding: 15px; border-radius: 8px;">
            <h3 style="color: var(--primary-dark); margin-top: 0;">Paragraph 1 ‚Äì Opening</h3>
            <p>Greet Sarah and show sympathy.</p>
            <p><em>Useful phrases: I'm sorry to hear that..., I understand how you feel..., It's normal to feel this way at your age...</em></p>
            
            <h3 style="color: var(--primary-dark);">Paragraph 2 ‚Äì Advice + Result</h3>
            <p>Give <strong>2‚Äì3 pieces of advice</strong>, each piece of advice <strong>must include the result if she follows it</strong>, written in the same sentence.</p>
            <p><em>Useful phrases ‚Äì advice: You should..., You shouldn't..., If I were you, I would..., Why don't you...</em></p>
            <p><em>Useful phrases ‚Äì result: This can help you..., As a result, you may..., This will make you feel..., If you do this, you can...</em></p>
            
            <h3 style="color: var(--primary-dark);">Paragraph 3 ‚Äì Closing</h3>
            <p>Encourage Sarah and end the letter politely.</p>
            <p><em>Useful phrases: I hope this advice helps..., Don't worry too much..., Take care..., Best wishes...</em></p>
        </div>
    </div>

    <div class="exercise-card">
        <div class="exercise-title">4. Write & Check Your Letter</div>
        
        <div class="check-options">
            <button class="check-btn basic" onclick="basicCheck()">
                ‚úèÔ∏è Basic Check
            </button>
            <button class="check-btn grammar" onclick="checkGrammar()">
                üîç Grammar Check
            </button>
            <button class="check-btn structure" onclick="checkStructure()">
                üìã Structure Check
            </button>
            <button class="check-btn vocabulary" onclick="checkVocabulary()">
                üìö Vocabulary Check
            </button>
        </div>
        
        <div style="margin-top: 20px;">
            <h4 style="color: var(--primary-dark);">Write your complete letter here:</h4>
            <textarea id="letter-writing" placeholder="Dear Sarah,

[Write your opening paragraph here - show sympathy]

[Write your advice paragraphs here - include 2-3 pieces of advice with results]

[Write your closing paragraph here - encourage Sarah]

Best wishes,
[Your name]" style="width: 100%; min-height: 300px; padding: 15px; border: 2px solid #bdc3c7; border-radius: 8px; font-family: inherit; font-size: 1em; box-sizing: border-box;"></textarea>
            <div class="word-count">
                Word count: <span id="word-count">0</span> words
            </div>
        </div>
        
        <div class="writing-tips">
            <h4 style="margin-top: 0;">üí° Writing Tips:</h4>
            <ul>
                <li>Start with "Dear Sarah," and end with "Best wishes, [Your name]"</li>
                <li>Show sympathy in the opening paragraph</li>
                <li>Each advice must include the expected result</li>
                <li>Use friendly and encouraging language</li>
                <li>Aim for 100-150 words total</li>
            </ul>
        </div>
        
        <div class="controls-row">
            <button class="btn btn-show-all" onclick="showSampleAnswer()">Show Sample Answer</button>
            <button class="btn btn-reset" onclick="resetLetter()">Reset Letter</button>
        </div>
    </div>

    <div class="exercise-card">
        <div class="exercise-title">Sample Answer</div>
        <div style="display: none;" id="sampleAnswer">
            <div class="letter-preview">
Dear Sarah,

I'm sorry to hear that you are unhappy with the way you look, and I understand how difficult this can be for someone your age.

If I were you, I would try to eat healthier food and drink more water, because this can help improve your skin, and as a result, you may feel more confident. You should also exercise regularly, such as walking or playing a sport you enjoy, and this will help you lose weight and feel healthier. In addition, you shouldn't compare yourself with others, because everyone develops differently, so you will feel less stressed and more positive.

I hope this advice helps you feel better soon. Take care.

Best wishes,
Trung
            </div>
        </div>
        <button class="btn" onclick="toggleSampleAnswer()" id="toggleSampleBtn">Show Sample Answer</button>
    </div>
</div>

<!-- Check Results Modal -->
<div class="modal-overlay" id="checkModal">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-title" id="modalTitle">Check Results</div>
            <button class="close-modal" onclick="closeModal()">√ó</button>
        </div>
        <div id="checkResults"></div>
    </div>
</div>

<button class="check-all-btn" onclick="basicCheck()">CHECK YOUR LETTER</button>

<script>
    // Existing functions
    function toggleResult(resultId) {
        const cell = document.getElementById(resultId);
        const hidden = cell.querySelector('.hidden-result');
        const result = cell.querySelector('.result-text');
        const btn = event.target;
        
        if (result.style.display === 'none') {
            result.style.display = 'inline';
            hidden.style.display = 'none';
            btn.classList.add('active');
        } else {
            result.style.display = 'none';
            hidden.style.display = 'inline';
            btn.classList.remove('active');
        }
    }

    function toggleHint(hintId) {
        const hint = document.getElementById(hintId);
        const btn = event.target;
        
        if (hint.style.display === 'block') {
            hint.style.display = 'none';
            btn.classList.remove('active');
        } else {
            hint.style.display = 'block';
            btn.classList.add('active');
        }
    }

    function showAllResults() {
        document.querySelectorAll('.result-text').forEach(result => {
            result.style.display = 'inline';
        });
        document.querySelectorAll('.hidden-result').forEach(hidden => {
            hidden.style.display = 'none';
        });
        document.querySelectorAll('.btn-small').forEach(btn => {
            if (btn.textContent === 'üëÅÔ∏è') {
                btn.classList.add('active');
            }
        });
    }

    function resetAllResults() {
        document.querySelectorAll('.result-text').forEach(result => {
            result.style.display = 'none';
        });
        document.querySelectorAll('.hidden-result').forEach(hidden => {
            hidden.style.display = 'inline';
        });
        document.querySelectorAll('.btn-small').forEach(btn => {
            btn.classList.remove('active');
        });
        document.querySelectorAll('.hint-box').forEach(hint => {
            hint.style.display = 'none';
        });
    }

    function toggleSampleAnswer() {
        const sample = document.getElementById('sampleAnswer');
        const btn = document.getElementById('toggleSampleBtn');
        
        if (sample.style.display === 'none') {
            sample.style.display = 'block';
            btn.textContent = 'Hide Sample Answer';
        } else {
            sample.style.display = 'none';
            btn.textContent = 'Show Sample Answer';
        }
    }

    function showSampleAnswer() {
        const sample = document.getElementById('sampleAnswer');
        const btn = document.getElementById('toggleSampleBtn');
        sample.style.display = 'block';
        btn.textContent = 'Hide Sample Answer';
    }

    function resetLetter() {
        document.getElementById('letter-writing').value = '';
        updateWordCount();
    }

    // New enhanced functions
    function showModal(title) {
        document.getElementById('modalTitle').textContent = title;
        document.getElementById('checkModal').style.display = 'flex';
    }
    
    function closeModal() {
        document.getElementById('checkModal').style.display = 'none';
    }
    
    function updateWordCount() {
        const letter = document.getElementById('letter-writing').value;
        const wordCount = letter.trim().split(/\s+/).filter(word => word.length > 0).length;
        document.getElementById('word-count').textContent = wordCount;
    }
    
    // --- BASIC CHECK ---
    function basicCheck() {
        const letter = document.getElementById('letter-writing').value;
        const wordCount = letter.trim().split(/\s+/).filter(word => word.length > 0).length;
        
        let score = 0;
        let issues = [];
        let successes = [];
        
        // Check word count
        if (wordCount >= 100 && wordCount <= 150) {
            score += 30;
            successes.push(`‚úÖ Word count: ${wordCount} words (Perfect!)`);
        } else if (wordCount >= 80 && wordCount <= 180) {
            score += 20;
            issues.push(`‚ö† Word count: ${wordCount} words (Aim for 100-150)`);
        } else {
            issues.push(`‚ùå Word count: ${wordCount} words (Too short or too long)`);
        }
        
        // Check structure elements
        const letterLower = letter.toLowerCase();
        
        // Check greeting
        if (letterLower.includes('dear sarah') || letterLower.includes('dear sarah,')) {
            score += 15;
            successes.push("‚úÖ Greeting: Includes 'Dear Sarah'");
        } else {
            issues.push("‚ö† Greeting: Start with 'Dear Sarah,'");
        }
        
        // Check closing
        if (letterLower.includes('best wishes') || letterLower.includes('take care') || letterLower.includes('hope this helps')) {
            score += 15;
            successes.push("‚úÖ Closing: Includes polite ending");
        } else {
            issues.push("‚ö† Closing: Add polite ending (Best wishes, Take care)");
        }
        
        // Check sympathy phrases
        const sympathyPhrases = ['sorry to hear', 'understand how you feel', 'difficult', 'hard', 'understand'];
        let sympathyCount = 0;
        sympathyPhrases.forEach(phrase => {
            if (letterLower.includes(phrase)) sympathyCount++;
        });
        
        if (sympathyCount >= 1) {
            score += 20;
            successes.push("‚úÖ Opening: Shows sympathy");
        } else {
            issues.push("‚ö† Opening: Add sympathy (I'm sorry to hear that...)");
        }
        
        // Check advice phrases
        const advicePhrases = ['you should', 'you could', 'if i were you', 'why don\'t you', 'i suggest', 'i recommend'];
        let adviceCount = 0;
        advicePhrases.forEach(phrase => {
            if (letterLower.includes(phrase)) adviceCount++;
        });
        
        if (adviceCount >= 2) {
            score += 20;
            successes.push(`‚úÖ Advice: ${adviceCount} advice phrases found`);
        } else if (adviceCount === 1) {
            score += 10;
            issues.push("‚ö† Advice: Add at least one more piece of advice");
        } else {
            issues.push("‚ùå Advice: No advice phrases found");
        }
        
        // Display results
        showModal('Basic Check Results');
        let html = `
            <div class="score-display">
                <div class="score-number">${score}%</div>
                <div class="score-text">${wordCount} words ‚Ä¢ ${issues.length + successes.length} checks</div>
            </div>
        `;
        
        if (successes.length > 0) {
            html += '<div style="margin: 20px 0;">';
            successes.forEach(success => {
                html += `<div class="issue-item success">${success}</div>`;
            });
            html += '</div>';
        }
        
        if (issues.length > 0) {
            html += '<div style="margin: 20px 0;">';
            issues.forEach(issue => {
                html += `<div class="issue-item">${issue}</div>`;
            });
            html += '</div>';
        }
        
        // Add suggestions
        html += `
            <div class="writing-tips">
                <h4 style="margin-top: 0;">üí° Suggestions for improvement:</h4>
                <ul>
                    ${score >= 80 ? '<li>Great job! Your letter is well-structured.</li>' : ''}
                    ${wordCount < 100 ? '<li>Try to write more details to reach 100 words</li>' : ''}
                    ${wordCount > 150 ? '<li>Your letter is a bit long. Try to be more concise.</li>' : ''}
                    ${adviceCount < 2 ? '<li>Add at least 2 pieces of advice with results</li>' : ''}
                    <li>Make sure each advice includes the expected result</li>
                    <li>Use friendly and encouraging language throughout</li>
                </ul>
            </div>
        `;
        
        document.getElementById('checkResults').innerHTML = html;
    }
    
    // --- GRAMMAR CHECK (LanguageTool) ---
    async function checkGrammar() {
        const letter = document.getElementById('letter-writing').value;
        
        if (!letter.trim()) {
            alert("Please write your letter first.");
            return;
        }
        
        showModal('Grammar Check');
        document.getElementById('checkResults').innerHTML = `
            <div class="loading">
                <div class="spinner"></div>
                <p>Checking grammar with LanguageTool...</p>
                <p style="font-size: 0.9em; color: #7f8c8d;">Checking spelling, grammar, and style</p>
            </div>
        `;
        
        try {
            const response = await fetch('https://api.languagetool.org/v2/check', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `text=${encodeURIComponent(letter)}&language=en-US&enabledOnly=false`
            });
            
            const data = await response.json();
            
            // Calculate score
            const wordCount = letter.trim().split(/\s+/).length;
            const errorCount = data.matches ? data.matches.length : 0;
            const grammarScore = Math.max(0, 100 - (errorCount * 3));
            
            let html = `
                <div class="score-display">
                    <div class="score-number">${grammarScore}%</div>
                    <div class="score-text">
                        ${errorCount} issue${errorCount !== 1 ? 's' : ''} found in ${wordCount} words
                    </div>
                </div>
            `;
            
            if (errorCount === 0) {
                html += `
                    <div style="text-align: center; padding: 30px;">
                        <div style="font-size: 48px; color: var(--success);">‚úÖ</div>
                        <h3 style="color: var(--success);">Perfect Grammar!</h3>
                        <p>No grammar or spelling errors found.</p>
                    </div>
                `;
            } else {
                html += '<div style="margin: 20px 0;"><p><strong>Issues to fix:</strong></p></div>';
                
                // Show issues (max 8)
                const issuesToShow = data.matches.slice(0, 8);
                
                issuesToShow.forEach((match, index) => {
                    const issueClass = match.rule.issueType === 'misspelling' ? 'error' : 'warning';
                    
                    html += `
                        <div class="issue-item ${issueClass}">
                            <div><strong>${index + 1}. ${match.message}</strong></div>
                            ${match.replacements && match.replacements.length > 0 ? 
                                `<div style="margin-top: 5px;">üí° Suggestion: <em>${match.replacements[0].value}</em></div>` : ''}
                        </div>
                    `;
                });
                
                if (errorCount > 8) {
                    html += `<p style="text-align: center; color: #7f8c8d; margin-top: 15px;">
                        ... and ${errorCount - 8} more issues
                    </p>`;
                }
                
                html += `
                    <div class="writing-tips">
                        <h4 style="margin-top: 0;">üí° Grammar Tips:</h4>
                        <ul>
                            <li>Check subject-verb agreement</li>
                            <li>Use correct punctuation (commas, periods)</li>
                            <li>Watch for common spelling mistakes</li>
                            <li>Read your letter aloud to catch errors</li>
                        </ul>
                    </div>
                `;
            }
            
            document.getElementById('checkResults').innerHTML = html;
            
        } catch (error) {
            document.getElementById('checkResults').innerHTML = `
                <div style="text-align: center; padding: 30px;">
                    <p style="color: var(--error);">‚ùå Grammar check failed</p>
                    <p>Error: ${error.message}</p>
                    <p>Please check your internet connection and try again.</p>
                    <button class="btn" onclick="checkGrammar()" style="margin-top: 15px;">Try Again</button>
                </div>
            `;
        }
    }
    
    // --- STRUCTURE CHECK ---
    function checkStructure() {
        const letter = document.getElementById('letter-writing').value;
        const paragraphs = letter.split('\n\n').filter(p => p.trim().length > 0);
        
        showModal('Structure Check');
        
        let html = `
            <div class="score-display">
                <div class="score-number">Structure</div>
                <div class="score-text">${paragraphs.length} paragraph${paragraphs.length !== 1 ? 's' : ''} detected</div>
            </div>
            
            <div style="margin: 20px 0;">
                <p><strong>Paragraph Analysis:</strong></p>
        `;
        
        const expectedStructure = [
            "Opening - Greeting & sympathy",
            "Body - Advice with results",
            "Closing - Encouragement & sign-off"
        ];
        
        expectedStructure.forEach((expected, index) => {
            if (index < paragraphs.length) {
                const para = paragraphs[index];
                const paraLower = para.toLowerCase();
                
                let checks = [];
                
                // Check opening paragraph
                if (index === 0) {
                    if (paraLower.includes('dear')) checks.push("‚úÖ Has greeting");
                    if (paraLower.includes('sorry') || paraLower.includes('understand')) checks.push("‚úÖ Shows sympathy");
                    if (checks.length < 2) checks.push("‚ö† Could add more sympathy");
                }
                
                // Check body paragraphs
                if (index > 0 && index < paragraphs.length - 1) {
                    const adviceWords = ['should', 'could', 'suggest', 'recommend', 'advise'];
                    const resultWords = ['help', 'result', 'feel', 'make', 'improve'];
                    
                    let adviceFound = adviceWords.some(word => paraLower.includes(word));
                    let resultFound = resultWords.some(word => paraLower.includes(word));
                    
                    if (adviceFound) checks.push("‚úÖ Gives advice");
                    if (resultFound) checks.push("‚úÖ Mentions result");
                    if (!adviceFound || !resultFound) checks.push("‚ö† Advice should include result");
                }
                
                // Check closing paragraph
                if (index === paragraphs.length - 1) {
                    if (paraLower.includes('hope') || paraLower.includes('wish') || paraLower.includes('take care')) checks.push("‚úÖ Encouraging closing");
                    if (paraLower.includes('best wishes') || paraLower.includes('sincerely')) checks.push("‚úÖ Proper sign-off");
                    if (checks.length < 2) checks.push("‚ö† Add more encouragement");
                }
                
                html += `
                    <div class="issue-item ${checks.every(c => c.includes('‚úÖ')) ? 'success' : ''}">
                        <div><strong>Paragraph ${index + 1}:</strong> ${expected}</div>
                        <div style="margin-top: 5px; font-size: 0.9em;">
                            ${checks.join(' ‚Ä¢ ')}
                        </div>
                    </div>
                `;
            } else {
                html += `
                    <div class="issue-item error">
                        <div><strong>Missing:</strong> ${expected}</div>
                        <div style="margin-top: 5px; font-size: 0.9em;">
                            ‚ùå This paragraph is missing
                        </div>
                    </div>
                `;
            }
        });
        
        html += `
            </div>
            
            <div class="writing-tips">
                <h4 style="margin-top: 0;">üí° Structure Tips:</h4>
                <ul>
                    <li><strong>Paragraph 1:</strong> Start with greeting and show sympathy</li>
                    <li><strong>Paragraph 2-3:</strong> Give advice + result for each piece of advice</li>
                    <li><strong>Final Paragraph:</strong> Encourage Sarah and sign off politely</li>
                    <li>Separate paragraphs with a blank line</li>
                    <li>Each paragraph should have 2-4 sentences</li>
                </ul>
            </div>
        `;
        
        document.getElementById('checkResults').innerHTML = html;
    }
    
    // --- VOCABULARY CHECK ---
    function checkVocabulary() {
        const letter = document.getElementById('letter-writing').value.toLowerCase();
        
        showModal('Vocabulary Check');
        
        // Categories of vocabulary to check
        const vocabularyCategories = {
            "Sympathy Words": ['sorry', 'understand', 'difficult', 'hard', 'challenging', 'problem'],
            "Advice Phrases": ['should', 'could', 'would', 'suggest', 'recommend', 'advise', 'try'],
            "Result Words": ['help', 'improve', 'better', 'feel', 'make', 'result', 'because', 'so'],
            "Encouragement": ['hope', 'wish', 'confident', 'positive', 'better', 'soon', 'care'],
            "Health Vocabulary": ['healthy', 'food', 'water', 'exercise', 'sleep', 'skin', 'weight', 'energy']
        };
        
        let html = `
            <div class="score-display">
                <div class="score-number">Vocabulary</div>
                <div class="score-text">Checking key vocabulary categories</div>
            </div>
            
            <div style="margin: 20px 0;">
                <p><strong>Vocabulary Usage:</strong></p>
        `;
        
        let totalScore = 0;
        let maxScore = Object.keys(vocabularyCategories).length * 20;
        
        Object.entries(vocabularyCategories).forEach(([category, words]) => {
            let foundWords = [];
            let score = 0;
            
            words.forEach(word => {
                if (letter.includes(word)) {
                    foundWords.push(word);
                    score += 5;
                }
            });
            
            score = Math.min(20, score); // Max 20 per category
            totalScore += score;
            
            const percentage = Math.round((score / 20) * 100);
            
            html += `
                <div class="issue-item ${percentage >= 50 ? 'success' : ''}">
                    <div><strong>${category}:</strong> ${percentage}% (${foundWords.length} words)</div>
                    <div style="margin-top: 5px; font-size: 0.9em;">
                        ${foundWords.length > 0 ? 
                            `Found: ${foundWords.slice(0, 5).join(', ')}${foundWords.length > 5 ? '...' : ''}` : 
                            'No words found from this category'}
                    </div>
                </div>
            `;
        });
        
        const overallPercentage = Math.round((totalScore / maxScore) * 100);
        
        html += `
            </div>
            
            <div class="score-display">
                <div class="score-number">${overallPercentage}%</div>
                <div class="score-text">Overall vocabulary score</div>
            </div>
            
            <div class="writing-tips">
                <h4 style="margin-top: 0;">üí° Vocabulary Suggestions:</h4>
                <ul>
                    ${overallPercentage >= 70 ? '<li>Great vocabulary usage!</li>' : ''}
                    ${overallPercentage < 50 ? '<li>Try to use more vocabulary from each category</li>' : ''}
                    <li><strong>Sympathy:</strong> I'm sorry to hear..., I understand how you feel...</li>
                    <li><strong>Advice:</strong> You should..., If I were you..., Why don't you...</li>
                    <li><strong>Results:</strong> This will help..., As a result..., This can make you feel...</li>
                    <li><strong>Encouragement:</strong> I hope..., Don't worry..., You can do it!</li>
                </ul>
            </div>
        `;
        
        document.getElementById('checkResults').innerHTML = html;
    }
    
    // Event listeners
    document.getElementById('letter-writing').addEventListener('input', updateWordCount);
    
    document.addEventListener('keydown', e => {
        if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
            basicCheck();
        }
    });
    
    // Close modal when clicking outside
    document.getElementById('checkModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeModal();
        }
    });
    
    window.onload = updateWordCount;
</script>
</body>
</html>