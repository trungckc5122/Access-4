<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Access 4 - Review Midterm (Unit 6-7) - FULL VERSION</title>
    <style>
        :root {
            --primary: #2980b9;
            --primary-dark: #1c5982;
            --success: #27ae60;
            --error: #e74c3c;
            --warning: #f1c40f;
            --bg: #f4f7f9;
            --text: #2c3e50;
            --card: #ffffff;
            --selection: #3498db;
            --selection-bg: #ebf5fb;
            --grammar-bg: #f0f7ff;
            --vocab-bg: #f9f7ff;
            --global-bg: #e8f4f8;
            --tech-bg: #f0e8f8;
            --highlight-light: #fff2cc;
        }

        body {
            font-family: 'Times New Roman', serif;
            font-size: 13pt;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px 20px 150px 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .main-title {
            text-align: center;
            color: var(--primary-dark);
            margin-bottom: 30px;
            font-size: 2em;
            padding-bottom: 15px;
            border-bottom: 3px solid var(--primary);
        }

        /* Reference Section Styles */
        .reference-section {
            background-color: var(--grammar-bg);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
            border-left: 6px solid var(--primary);
        }

        .reference-title {
            font-weight: bold;
            font-size: 1.4em;
            margin-bottom: 20px;
            color: var(--primary-dark);
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
        }

        .expand-toggle {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 12px;
            cursor: pointer;
            font-size: 0.8em;
        }

        .grammar-group {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid #e1e8ed;
            transition: all 0.3s ease;
            overflow: hidden;
        }

        .grammar-group.collapsed {
            max-height: 60px;
            overflow: hidden;
        }

        .grammar-group.expanded {
            max-height: 1000px;
        }

        .grammar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            cursor: pointer;
        }

        .grammar-subtitle {
            font-weight: bold;
            font-size: 1.2em;
            color: var(--primary);
            margin: 0;
        }

        .group-toggle {
            background: none;
            border: none;
            font-size: 1.2em;
            cursor: pointer;
            color: var(--primary);
        }

        .grammar-details {
            padding-left: 20px;
            border-left: 2px solid #e1e8ed;
            margin: 10px 0;
            transition: all 0.3s ease;
        }

        .grammar-group.collapsed .grammar-details {
            opacity: 0;
            height: 0;
            overflow: hidden;
            margin: 0;
            padding: 0;
        }

        .grammar-group.expanded .grammar-details {
            opacity: 1;
            height: auto;
        }

        .detail-item {
            margin-bottom: 8px;
            padding: 5px 0;
        }

        .detail-title {
            font-weight: bold;
            color: var(--primary-dark);
        }

        .reference-note {
            font-size: 0.85em;
            color: #7f8c8d;
            margin-top: 8px;
            font-style: italic;
        }

        .vocab-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            background-color: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .vocab-table th {
            background-color: var(--primary);
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: bold;
        }

        .vocab-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #eee;
        }

        .vocab-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        .phonetic {
            font-family: 'Arial', sans-serif;
            color: #666;
            font-size: 0.9em;
        }

        .meaning {
            color: #2c3e50;
        }

        .vietnamese-meaning {
            color: #e67e22;
            font-style: italic;
        }

        .topic-title {
            background-color: var(--vocab-bg);
            padding: 12px 15px;
            border-radius: 8px;
            margin: 20px 0 15px 0;
            font-weight: bold;
            color: var(--primary-dark);
            border-left: 4px solid #9b59b6;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }

        .topic-content {
            transition: all 0.3s ease;
            overflow: hidden;
        }

        .topic-content.collapsed {
            max-height: 0;
            opacity: 0;
            overflow: hidden;
        }

        .topic-content.expanded {
            max-height: 1000px;
            opacity: 1;
        }

        /* Word Bank Styles */
        .sticky-bank {
            position: sticky;
            top: 15px;
            z-index: 100;
            background-color: #fff;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 25px;
            border: 2px solid var(--primary);
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
        }

        .word-item {
            background: #eef2f7;
            border: 1px solid var(--primary);
            color: var(--primary-dark);
            padding: 6px 12px;
            border-radius: 5px;
            cursor: grab;
            user-select: none;
            transition: 0.2s;
            font-size: 0.9em;
            font-weight: 500;
        }

        .word-item.used {
            opacity: 0.3;
            cursor: not-allowed;
            display: flex;
        }

        .word-item:hover:not(.used) {
            background: var(--primary);
            color: white;
        }

        /* Exercise Cards */
        .exercise-card {
            background: var(--card);
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            padding: 25px;
            margin-bottom: 30px;
        }

        .exercise-title {
            font-weight: bold;
            font-size: 1.25em;
            margin-bottom: 18px;
            color: var(--primary-dark);
            border-bottom: 2px solid #eee;
            padding-bottom: 8px;
        }

        .sub-exercise {
            margin-bottom: 30px;
            padding: 15px;
            border-radius: 8px;
        }

        .sub-exercise.global {
            background-color: var(--global-bg);
            border-left: 4px solid #2980b9;
        }

        .sub-exercise.tech {
            background-color: var(--tech-bg);
            border-left: 4px solid #9b59b6;
        }

        .sub-title {
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 15px;
            color: var(--primary-dark);
        }

        .matching-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-top: 10px;
        }

        .vocab-item {
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .vocab-text {
            min-width: 150px;
            font-weight: 500;
        }

        .question-row {
            margin-bottom: 18px;
            line-height: 2.2;
            border-bottom: 1px solid #f9f9f9;
            padding-bottom: 10px;
            position: relative;
        }

        input[type="text"] {
            border: none;
            border-bottom: 2px solid #bdc3c7;
            background: #fafafa;
            padding: 2px 8px;
            font-size: 1em;
            transition: 0.2s;
            outline: none;
            min-width: 60px;
            border-radius: 4px 4px 0 0;
            text-align: center;
            font-family: 'Times New Roman';
            box-sizing: border-box;
        }

        input.letter-input {
            width: 45px;
            min-width: 45px;
            max-width: 80px;
            text-transform: uppercase;
            font-weight: bold;
            color: var(--primary-dark);
        }

        input.word-input {
            min-width: 120px;
            max-width: 400px;
            text-align: left;
        }

        input.correct {
            border-bottom-color: var(--success) !important;
            background-color: #e8f8f5 !important;
            color: #1e8449 !important;
        }

        input.incorrect-marked {
            border-bottom-color: var(--error) !important;
            background-color: #fdedec !important;
        }

        .row-btns {
            display: inline-flex;
            gap: 5px;
            vertical-align: middle;
            margin-left: 10px;
        }

        .btn-small {
            background: #eee;
            border: 1px solid #ccc;
            border-radius: 4px;
            width: 28px;
            height: 28px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: 0.2s;
        }

        .btn-small:hover {
            background: #ddd;
        }

        .btn-small.active {
            background: #3498db;
            color: white;
            border-color: #2980b9;
        }

        .info-btn {
            background: #95a5a6;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 11px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: 0.2s;
        }

        .info-btn:hover {
            background: #7f8c8d;
        }

        .info-btn.active {
            background: #5d6d6e;
        }

        .hint-box {
            display: none;
            margin-top: 8px;
            padding: 10px;
            background-color: #fef9e7;
            border-left: 4px solid var(--warning);
            color: #7d6608;
            border-radius: 4px;
            font-size: 0.85em;
        }

        .controls-row {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 15px;
        }

        .btn {
            padding: 8px 20px;
            border-radius: 6px;
            cursor: pointer;
            border: none;
            font-weight: bold;
            transition: 0.3s;
        }

        .btn-reset {
            background: #95a5a6;
            color: white;
        }

        .btn-show-all {
            background: var(--primary);
            color: white;
        }

        .check-all-btn {
            position: fixed;
            right: 45px;
            bottom: 30px;
            background-color: var(--success);
            color: white;
            padding: 15px 30px;
            border-radius: 50px;
            cursor: pointer;
            z-index: 10000;
            font-weight: bold;
            border: none;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .instructions {
            color: #7f8c8d;
            font-size: 0.95em;
            margin-bottom: 15px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }

        .option-container {
            display: inline-flex;
            gap: 10px;
            margin-left: 10px;
            margin-right: 10px;
            flex-wrap: wrap;
        }

        .option-btn {
            background: #eef2f7;
            border: 2px solid #bdc3c7;
            border-radius: 6px;
            padding: 6px 15px;
            cursor: pointer;
            font-weight: 500;
            transition: 0.2s;
            min-width: 80px;
            text-align: center;
            font-size: 0.9em;
        }

        .option-btn:hover {
            background: #dfe6f0;
            border-color: #95a5a6;
        }

        .option-btn.selected {
            background: #3498db;
            color: white;
            border-color: #2980b9;
        }

        .option-btn.correct-option {
            background: #27ae60;
            color: white;
            border-color: #219653;
        }

        .option-btn.incorrect-option {
            background: #e74c3c;
            color: white;
            border-color: #c0392b;
        }

        .bold-option {
            font-weight: bold;
            color: var(--primary-dark);
        }

        /* Reading Container Styles */
        .reading-container {
            display: flex;
            margin: 20px 0;
            position: relative;
            min-height: 500px;
            height: 600px;
        }

        .text-panel, .questions-panel {
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            border: 1px solid #e9ecef;
            overflow-y: auto;
            position: relative;
            height: 100%;
            flex: 1;
        }

        .text-panel {
            margin-right: 0;
            border-top-right-radius: 0;
            border-bottom-right-radius: 0;
        }

        .questions-panel {
            margin-left: 0;
            border-top-left-radius: 0;
            border-bottom-left-radius: 0;
        }

        .text-panel h3, .questions-panel h3 {
            margin-top: 0;
            color: var(--primary-dark);
            text-align: center;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        .reading-text {
            line-height: 1.8;
            text-align: justify;
            user-select: text;
        }

        .reading-text p {
            margin-bottom: 15px;
        }

        /* True/False Styles */
        .truefalse-container {
            margin-bottom: 20px;
        }

        .truefalse-item {
            margin-bottom: 15px;
            padding: 10px;
            background-color: white;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
        }

        .truefalse-question {
            font-weight: 500;
            margin-bottom: 10px;
        }

        .truefalse-options {
            display: flex;
            gap: 20px;
            margin-left: 20px;
        }

        .truefalse-option {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 4px;
            transition: 0.2s;
        }

        .truefalse-option:hover {
            background-color: #f0f0f0;
        }

        .truefalse-option.selected {
            background-color: #e3f2fd;
            font-weight: bold;
        }

        .truefalse-option.correct {
            background-color: #d4edda;
            color: #155724;
        }

        .truefalse-option.incorrect {
            background-color: #f8d7da;
            color: #721c24;
        }

        .resizer {
            position: relative;
            width: 10px;
            background-color: #ddd;
            cursor: col-resize;
            z-index: 10;
            flex-shrink: 0;
            margin: 0;
        }

        .resizer:hover {
            background-color: #3498db;
        }

        .resizer::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 2px;
            height: 40px;
            background-color: #95a5a6;
            border-radius: 1px;
        }

        .definitions-column {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            height: 500px;
            overflow-y: auto;
        }

        .definition-item {
            margin-bottom: 12px;
            padding: 8px;
            border-bottom: 1px solid #eee;
            background-color: white;
            border-radius: 4px;
            min-height: 40px;
        }

        .definition-letter {
            font-weight: bold;
            color: var(--primary);
            margin-right: 10px;
            min-width: 20px;
            display: inline-block;
        }

        .definition-text {
            display: inline;
        }

        /* Highlight Styles */
        .highlighted-text {
            background-color: var(--highlight-light) !important;
            padding: 0 2px;
            border-radius: 2px;
            color: inherit !important;
            display: inline;
        }

        .hint-highlight {
            background-color: var(--highlight-light) !important;
            transition: background-color 0.2s;
        }

        /* Context Menu */
        .context-menu {
            position: absolute;
            background: white;
            border: 1px solid #ccc;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            padding: 6px 0;
            z-index: 20000;
            display: none;
        }

        .context-menu div {
            padding: 8px 24px;
            cursor: pointer;
            font-size: 13px;
        }

        .context-menu div:hover {
            background-color: #f0f0f0;
        }

        /* Task 8 Button Container */
        .task8-buttons {
            margin-top: 40px !important;
            padding: 20px !important;
            background-color: #f0f7ff !important;
            border-radius: 8px !important;
            border: none !important;
            display: flex !important;
            justify-content: flex-end !important;
            gap: 15px !important;
            clear: both !important;
            position: relative !important;
            z-index: 9999 !important;
            width: 100% !important;
            box-sizing: border-box !important;
        }

        .task8-buttons button {
            padding: 10px 25px !important;
            font-size: 14px !important;
            cursor: pointer !important;
        }

        @media (max-width: 768px) {
            .check-all-btn {
                right: 15px;
                bottom: 20px;
                padding: 12px 20px;
                font-size: 0.9em;
            }

            body {
                padding: 15px 15px 120px 15px;
            }

            .truefalse-options {
                flex-direction: column;
                gap: 10px;
                margin-left: 0;
            }

            .reading-container {
                flex-direction: column;
                height: 800px;
            }

            .text-panel, .questions-panel {
                width: 100% !important;
                height: 50% !important;
                margin: 0;
                border-radius: 10px;
                margin-bottom: 10px;
            }

            .resizer {
                display: none;
            }

            .vocab-table {
                display: block;
                overflow-x: auto;
            }

            .matching-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }
        }
    </style>
</head>
<body>
<div class="container">
    <h1 class="main-title">Access 4 - Review Midterm (Unit 6-7)</h1>

    <!-- Reference Section -->
    <div class="reference-section">
        <div class="reference-title" onclick="toggleReferenceSection()">
            Grammar & Vocabulary Reference
            <button class="expand-toggle" id="reference-toggle">+</button>
        </div>
        <div id="reference-content">
            <!-- Grammar: Future forms -->
            <div class="grammar-group collapsed" id="grammar-future">
                <div class="grammar-header" onclick="toggleGrammar('future')">
                    <h3 class="grammar-subtitle">Future: will, be going to, present progressive (Thì tương lai)</h3>
                    <button class="group-toggle">+</button>
                </div>
                <div class="grammar-details">
                    <div class="detail-item">
                        <div class="detail-title">will (sẽ)</div>
                        <div><strong>Cách dùng:</strong> Quyết định tức thì, lời hứa, lời đề nghị, dự đoán dựa trên ý kiến cá nhân.</div>
                        <div><strong>Ví dụ:</strong> I'll help you with that. (Tôi sẽ giúp bạn.) / It will rain tomorrow. (Ngày mai trời sẽ mưa.)</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-title">be going to (dự định, sắp sửa)</div>
                        <div><strong>Cách dùng:</strong> Kế hoạch, dự định, dự đoán dựa trên bằng chứng ở hiện tại.</div>
                        <div><strong>Ví dụ:</strong> I'm going to study medicine. (Tôi dự định học y.) / Look at those clouds! It's going to rain. (Nhìn mây kìa! Trời sắp mưa.)</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-title">present progressive (hiện tại tiếp diễn)</div>
                        <div><strong>Cách dùng:</strong> Sự sắp xếp đã được lên lịch cố định, thường có thời gian và địa điểm cụ thể.</div>
                        <div><strong>Ví dụ:</strong> I'm meeting friends tonight. (Tôi sẽ gặp bạn tối nay.)</div>
                    </div>
                </div>
                <div class="reference-note">Nguồn: Cambridge Dictionary</div>
            </div>

            <!-- Grammar: Conditionals -->
            <div class="grammar-group collapsed" id="grammar-conditionals">
                <div class="grammar-header" onclick="toggleGrammar('conditionals')">
                    <h3 class="grammar-subtitle">Conditionals (Câu điều kiện)</h3>
                    <button class="group-toggle">+</button>
                </div>
                <div class="grammar-details">
                    <div class="detail-item">
                        <div class="detail-title">Zero conditional (luôn đúng)</div>
                        <div><strong>Cấu trúc:</strong> If/When + hiện tại đơn, hiện tại đơn</div>
                        <div><strong>Ví dụ:</strong> If you heat ice, it melts. (Nếu bạn đun nóng đá, nó sẽ tan chảy.)</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-title">First conditional (có thể xảy ra ở hiện tại/tương lai)</div>
                        <div><strong>Cấu trúc:</strong> If + hiện tại đơn, will + động từ</div>
                        <div><strong>Ví dụ:</strong> If it rains, we will stay home. (Nếu trời mưa, chúng tôi sẽ ở nhà.)</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-title">Second conditional (không có thật ở hiện tại)</div>
                        <div><strong>Cấu trúc:</strong> If + quá khứ đơn, would + động từ</div>
                        <div><strong>Ví dụ:</strong> If I had money, I would travel. (Nếu tôi có tiền, tôi sẽ đi du lịch.)</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-title">Third conditional (không có thật trong quá khứ)</div>
                        <div><strong>Cấu trúc:</strong> If + quá khứ hoàn thành, would have + quá khứ phân từ</div>
                        <div><strong>Ví dụ:</strong> If I had known, I would have told you. (Nếu tôi biết, tôi đã nói với bạn rồi.)</div>
                    </div>
                </div>
                <div class="reference-note">Nguồn: Cambridge Dictionary</div>
            </div>

            <!-- Grammar: Modals -->
            <div class="grammar-group collapsed" id="grammar-modals">
                <div class="grammar-header" onclick="toggleGrammar('modals')">
                    <h3 class="grammar-subtitle">Modals (Động từ khuyết thiếu)</h3>
                    <button class="group-toggle">+</button>
                </div>
                <div class="grammar-details">
                    <div class="detail-item">
                        <div class="detail-title">must not (không được phép)</div>
                        <div><strong>Cách dùng:</strong> Cấm đoán (bị cấm)</div>
                        <div><strong>Ví dụ:</strong> You must not smoke here. (Bạn không được hút thuốc ở đây.)</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-title">don't/doesn't have to (không cần phải)</div>
                        <div><strong>Cách dùng:</strong> Không cần thiết (không bắt buộc)</div>
                        <div><strong>Ví dụ:</strong> You don't have to come early. (Bạn không cần phải đến sớm.)</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-title">can / could / may / might (có thể)</div>
                        <div><strong>Cách dùng:</strong> Khả năng, xin phép, sự cho phép</div>
                        <div><strong>Ví dụ:</strong> It may rain. (Trời có thể mưa.) / Can I go out? (Tôi có thể ra ngoài không?)</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-title">should / ought to (nên)</div>
                        <div><strong>Cách dùng:</strong> Lời khuyên, đề nghị</div>
                        <div><strong>Ví dụ:</strong> You should see a doctor. (Bạn nên đi khám.)</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-title">would (sẽ)</div>
                        <div><strong>Cách dùng:</strong> Thói quen trong quá khứ, yêu cầu lịch sự, tình huống giả định</div>
                        <div><strong>Ví dụ:</strong> He would always help. (Anh ấy luôn sẵn lòng giúp đỡ.)</div>
                    </div>
                </div>
                <div class="reference-note">Nguồn: Cambridge Dictionary</div>
            </div>

            <!-- Vocabulary: Global Issues (Unit 6) -->
            <div class="topic-title" onclick="toggleTopic('global')">
                Vocabulary: Global Issues (Unit 6) - Các vấn đề toàn cầu
                <span class="group-toggle">+</span>
            </div>
            <div class="topic-content collapsed" id="topic-global">
                <table class="vocab-table">
                    <thead>
                        <tr><th>Vocabulary</th><th>Phonetic (Cambridge)</th><th>Definition</th><th>Nghĩa Tiếng Việt</th></tr>
                    </thead>
                    <tbody>
                        <tr><td>fertilizers</td><td class="phonetic">/ˈfɜː.tɪ.laɪ.zəz/</td><td class="meaning">substances added to soil to help plants grow better</td><td class="vietnamese-meaning">phân bón</td></tr>
                        <tr><td>pesticides</td><td class="phonetic">/ˈpes.tɪ.saɪdz/</td><td class="meaning">chemicals used to kill insects that damage crops</td><td class="vietnamese-meaning">thuốc trừ sâu</td></tr>
                        <tr><td>features</td><td class="phonetic">/ˈfiː.tʃəz/</td><td class="meaning">special parts or qualities of something</td><td class="vietnamese-meaning">tính năng, đặc điểm</td></tr>
                        <tr><td>resources</td><td class="phonetic">/rɪˈzɔː.sɪz/</td><td class="meaning">things such as money, land, or energy that can be used</td><td class="vietnamese-meaning">tài nguyên</td></tr>
                        <tr><td>roam</td><td class="phonetic">/rəʊm/</td><td class="meaning">to move around freely without a fixed direction</td><td class="vietnamese-meaning">lang thang, đi lang thang</td></tr>
                        <tr><td>support</td><td class="phonetic">/səˈpɔːt/</td><td class="meaning">help or encouragement given to someone</td><td class="vietnamese-meaning">sự hỗ trợ</td></tr>
                        <tr><td>waste</td><td class="phonetic">/weɪst/</td><td class="meaning">unwanted material that is thrown away</td><td class="vietnamese-meaning">chất thải, rác thải</td></tr>
                        <tr><td>adopt</td><td class="phonetic">/əˈdɒpt/</td><td class="meaning">to choose to use a particular idea, method, or system</td><td class="vietnamese-meaning">áp dụng, thông qua</td></tr>
                        <tr><td>leading</td><td class="phonetic">/ˈliː.dɪŋ/</td><td class="meaning">having the most influence or importance</td><td class="vietnamese-meaning">hàng đầu, chủ đạo</td></tr>
                        <tr><td>topic</td><td class="phonetic">/ˈtɒp.ɪk/</td><td class="meaning">the main subject being discussed</td><td class="vietnamese-meaning">chủ đề</td></tr>
                        <tr><td>estimate</td><td class="phonetic">/ˈes.tɪ.meɪt/</td><td class="meaning">to guess the size, number, or cost of something</td><td class="vietnamese-meaning">ước tính</td></tr>
                        <tr><td>advancing</td><td class="phonetic">/ədˈvɑːn.sɪŋ/</td><td class="meaning">becoming more developed or modern</td><td class="vietnamese-meaning">tiên tiến, đang phát triển</td></tr>
                        <tr><td>fossil fuels</td><td class="phonetic">/ˈfɒs.əl ˌfjuː.əlz/</td><td class="meaning">fuels such as coal, oil, or gas from the earth</td><td class="vietnamese-meaning">nhiên liệu hóa thạch</td></tr>
                        <tr><td>drought</td><td class="phonetic">/draʊt/</td><td class="meaning">a period of time with very little rain</td><td class="vietnamese-meaning">hạn hán</td></tr>
                        <tr><td>overpopulation</td><td class="phonetic">/ˌəʊ.vəˌpɒp.jəˈleɪ.ʃən/</td><td class="meaning">too many people live in one area</td><td class="vietnamese-meaning">bùng nổ dân số</td></tr>
                        <tr><td>famine</td><td class="phonetic">/ˈfæm.ɪn/</td><td class="meaning">serious lack of food affecting many people</td><td class="vietnamese-meaning">nạn đói</td></tr>
                    </tbody>
                </table>
            </div>

            <!-- Vocabulary: Technology (Unit 7) -->
            <div class="topic-title" onclick="toggleTopic('tech')">
                Vocabulary: Technology (Unit 7) - Công nghệ
                <span class="group-toggle">+</span>
            </div>
            <div class="topic-content collapsed" id="topic-tech">
                <table class="vocab-table">
                    <thead>
                        <tr><th>Vocabulary</th><th>Phonetic (Cambridge)</th><th>Definition</th><th>Nghĩa Tiếng Việt</th></tr>
                    </thead>
                    <tbody>
                        <tr><td>chores</td><td class="phonetic">/tʃɔːz/</td><td class="meaning">routine jobs done at home</td><td class="vietnamese-meaning">việc vặt trong nhà</td></tr>
                        <tr><td>copyrighted</td><td class="phonetic">/ˈkɒp.i.raɪ.tɪd/</td><td class="meaning">protected by law from being copied</td><td class="vietnamese-meaning">có bản quyền</td></tr>
                        <tr><td>rights</td><td class="phonetic">/raɪts/</td><td class="meaning">the ability to have or do something legally</td><td class="vietnamese-meaning">quyền lợi</td></tr>
                        <tr><td>properties</td><td class="phonetic">/ˈprɒp.ə.tiz/</td><td class="meaning">a quality in a substance or material</td><td class="vietnamese-meaning">đặc tính</td></tr>
                        <tr><td>emerging</td><td class="phonetic">/ɪˈmɜː.dʒɪŋ/</td><td class="meaning">starting to appear or become important</td><td class="vietnamese-meaning">mới nổi</td></tr>
                        <tr><td>connect</td><td class="phonetic">/kəˈnekt/</td><td class="meaning">to link people or systems together</td><td class="vietnamese-meaning">kết nối</td></tr>
                        <tr><td>hackers</td><td class="phonetic">/ˈhæk.əz/</td><td class="meaning">people who break into computer systems without permission</td><td class="vietnamese-meaning">tin tặc</td></tr>
                        <tr><td>develop</td><td class="phonetic">/dɪˈvel.əp/</td><td class="meaning">to grow or improve over time</td><td class="vietnamese-meaning">phát triển</td></tr>
                        <tr><td>risks</td><td class="phonetic">/rɪsks/</td><td class="meaning">possible dangers or problems</td><td class="vietnamese-meaning">rủi ro</td></tr>
                        <tr><td>illegal</td><td class="phonetic">/ɪˈliː.ɡəl/</td><td class="meaning">not allowed according to the law</td><td class="vietnamese-meaning">bất hợp pháp</td></tr>
                        <tr><td>powerful</td><td class="phonetic">/ˈpaʊə.fəl/</td><td class="meaning">very strong or able to influence others greatly</td><td class="vietnamese-meaning">mạnh mẽ</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Task 1A: Vocabulary Matching – Global Issues (Part 1) -->
    <div class="exercise-card">
        <div class="exercise-title">Task 1A: Vocabulary Matching – Global Issues (Part 1)</div>
        <div class="sub-exercise global">
            <div class="sub-title">Match the word to its meaning</div>
            <div class="matching-grid">
                <div id="vocab-t1a"></div>
                <div class="definitions-column" id="def-t1a"></div>
            </div>
        </div>
        <div class="controls-row">
            <button class="btn btn-show-all" onclick="showAnswers('t1a')">Show All</button>
            <button class="btn btn-reset" onclick="resetSection('t1a')">Reset</button>
        </div>
    </div>

    <!-- Task 2A: Filling in the Gaps – Global Issues (Part 1) -->
    <div class="exercise-card">
        <div class="exercise-title">Task 2A: Filling in the Gaps – Global Issues (Part 1)</div>
        <div class="sub-exercise global">
            <div class="instructions">Complete the sentences using vocabulary from Task 1A.</div>
            <div class="sticky-bank" id="bank-t2a"></div>
            <div id="questions-t2a"></div>
        </div>
        <div class="controls-row">
            <button class="btn btn-show-all" onclick="showAnswers('t2a')">Show All</button>
            <button class="btn btn-reset" onclick="resetSection('t2a')">Reset</button>
        </div>
    </div>

    <!-- Task 1B: Vocabulary Matching – Global Issues (Part 2) -->
    <div class="exercise-card">
        <div class="exercise-title">Task 1B: Vocabulary Matching – Global Issues (Part 2)</div>
        <div class="sub-exercise global">
            <div class="sub-title">Match the word to its meaning</div>
            <div class="matching-grid">
                <div id="vocab-t1b"></div>
                <div class="definitions-column" id="def-t1b"></div>
            </div>
        </div>
        <div class="controls-row">
            <button class="btn btn-show-all" onclick="showAnswers('t1b')">Show All</button>
            <button class="btn btn-reset" onclick="resetSection('t1b')">Reset</button>
        </div>
    </div>

    <!-- Task 2B: Filling in the Gaps – Global Issues (Part 2) -->
    <div class="exercise-card">
        <div class="exercise-title">Task 2B: Filling in the Gaps – Global Issues (Part 2)</div>
        <div class="sub-exercise global">
            <div class="instructions">Complete the sentences using vocabulary from Task 1B.</div>
            <div class="sticky-bank" id="bank-t2b"></div>
            <div id="questions-t2b"></div>
        </div>
        <div class="controls-row">
            <button class="btn btn-show-all" onclick="showAnswers('t2b')">Show All</button>
            <button class="btn btn-reset" onclick="resetSection('t2b')">Reset</button>
        </div>
    </div>

    <!-- Task 1C: Vocabulary Matching – Technology (Unit 7) -->
    <div class="exercise-card">
        <div class="exercise-title">Task 1C: Vocabulary Matching – Technology</div>
        <div class="sub-exercise tech">
            <div class="sub-title">Match the word to its meaning</div>
            <div class="matching-grid">
                <div id="vocab-t1c"></div>
                <div class="definitions-column" id="def-t1c"></div>
            </div>
        </div>
        <div class="controls-row">
            <button class="btn btn-show-all" onclick="showAnswers('t1c')">Show All</button>
            <button class="btn btn-reset" onclick="resetSection('t1c')">Reset</button>
        </div>
    </div>

    <!-- Task 2C: Filling in the Gaps – Technology -->
    <div class="exercise-card">
        <div class="exercise-title">Task 2C: Filling in the Gaps – Technology</div>
        <div class="sub-exercise tech">
            <div class="instructions">Complete the sentences using vocabulary from Task 1C.</div>
            <div class="sticky-bank" id="bank-t2c"></div>
            <div id="questions-t2c"></div>
        </div>
        <div class="controls-row">
            <button class="btn btn-show-all" onclick="showAnswers('t2c')">Show All</button>
            <button class="btn btn-reset" onclick="resetSection('t2c')">Reset</button>
        </div>
    </div>

    <!-- Task 3: Future forms -->
    <div class="exercise-card">
        <div class="exercise-title">Task 3: Future forms – Put the verbs in the correct form</div>
        <div class="instructions">Complete the conversations. Use will, be going to, or present progressive.</div>
        <div id="questions-t3"></div>
        <div class="controls-row">
            <button class="btn btn-show-all" onclick="showAnswers('t3')">Show All</button>
            <button class="btn btn-reset" onclick="resetSection('t3')">Reset</button>
        </div>
    </div>

    <!-- Task 4: Conditionals -->
    <div class="exercise-card">
        <div class="exercise-title">Task 4: Conditionals – Underline the correct verb tense</div>
        <div class="instructions">Select the correct option to complete each conditional sentence.</div>
        <div id="questions-t4"></div>
        <div class="controls-row">
            <button class="btn btn-show-all" onclick="showAnswers('t4')">Show All</button>
            <button class="btn btn-reset" onclick="resetSection('t4')">Reset</button>
        </div>
    </div>

    <!-- Task 5: must not / don't have to -->
    <div class="exercise-card">
        <div class="exercise-title">Task 5: Complete with must not or don’t/doesn’t have to</div>
        <div class="instructions">Complete each sentence with must not or don’t/doesn’t have to.</div>
        <div id="questions-t5"></div>
        <div class="controls-row">
            <button class="btn btn-show-all" onclick="showAnswers('t5')">Show All</button>
            <button class="btn btn-reset" onclick="resetSection('t5')">Reset</button>
        </div>
    </div>

    <!-- Task 6: Modal verbs -->
    <div class="exercise-card">
        <div class="exercise-title">Task 6: Modal verbs – Choose the correct modal</div>
        <div class="instructions">Select the appropriate modal verb.</div>
        <div id="questions-t6"></div>
        <div class="controls-row">
            <button class="btn btn-show-all" onclick="showAnswers('t6')">Show All</button>
            <button class="btn btn-reset" onclick="resetSection('t6')">Reset</button>
        </div>
    </div>

    <!-- Task 7: Dialogue completion - CẬP NHẬT THEO YÊU CẦU -->
    <div class="exercise-card">
        <div class="exercise-title">Task 7: Complete the dialogue – Use the sentences (a-e)</div>
        <div class="instructions">Drag and drop or click to fill the gaps with the correct phrase. One phrase is extra.</div>
        <div class="sticky-bank" id="bank-t7"></div>
        <div id="questions-t7"></div>
        <div class="controls-row">
            <button class="btn btn-show-all" onclick="showAnswers('t7')">Show All</button>
            <button class="btn btn-reset" onclick="resetSection('t7')">Reset</button>
        </div>
    </div>

    <!-- Task 8: Reading Comprehension (NewsMuseum) -->
    <div class="exercise-card" style="overflow: visible !important;">
        <div class="exercise-title">Task 8: Reading Comprehension – NewsMuseum</div>
        <div class="instructions">
            Read the text and decide whether the statements are True (T) or False (F).<br>
        </div>
        
        <div class="reading-container" id="reading-t8" style="overflow: visible !important;">
            <div class="text-panel" id="text-panel-t8">
                <h3>NewsMuseum – A Museum of Media and Communication</h3>
                <div class="reading-text" id="reading-text-t8">
                    <p id="p1">The NewsMuseum is a museum dedicated to the history of news, media, and communication. It is located in the town of Sintra, Portugal, and officially opened in 2016. The museum explores how information has been produced, shared, and received through different forms of media over time.</p>
                    <p id="p2">Before entering the building, visitors can see a statue of the Portuguese writer Eça de Queiroz holding a smartphone. This image symbolises the connection between traditional forms of communication and modern digital media. Inside, the museum is organised into more than 25 themed sections across three floors. These areas present important events from Portugal and the world through the way they were reported in the media.</p>
                    <p id="p3">The exhibitions combine written information with multimedia content, including videos, sound recordings, and interactive displays. In total, the museum contains hundreds of articles and many hours of audiovisual material. Several sections focus on topics such as press freedom, the role of journalists, and how news reporting has changed over time.</p>
                    <p id="p4">The NewsMuseum also has educational spaces, including a small auditorium. Workshops, live demonstrations, and media-related activities are regularly organised, especially for school groups. Through these programmes, the museum aims to improve media literacy and help visitors better understand modern communication.</p>
                    <p id="p5">Most of the exhibits are available in both Portuguese and English. The museum's main goal is not only to present the history of media but also to encourage visitors to think critically about the influence of media in their daily lives.</p>
                    <p style="font-size:0.85em; color:#666;">Wikipedia contributors. (n.d.). NewsMuseum. Wikipedia.</p>
                </div>
            </div>
            <div class="resizer" id="resizer-t8"></div>
            <div class="questions-panel" id="questions-panel-t8">
                <h3>Statements (True / False)</h3>
                <div id="reading-questions-t8"></div>
            </div>
        </div>
        
        <!-- Nút Show All và Reset được đặt riêng, bên ngoài reading-container -->
        <div class="task8-buttons">
            <button class="btn btn-show-all" onclick="showAnswers('t8')">Show All Answers & Highlight</button>
            <button class="btn btn-reset" onclick="resetSection('t8')">Reset All</button>
        </div>
    </div>
</div>

<button class="check-all-btn" onclick="checkAll()">CHECK ALL ANSWERS (ENTER)</button>

<!-- Custom context menu for highlight -->
<div class="context-menu" id="context-menu">
    <div class="context-menu-item" id="highlight-text">Highlight Text</div>
    <div class="context-menu-item" id="remove-highlight">Remove Highlight</div>
    <div class="context-menu-item" id="clear-highlights">Clear All Highlights</div>
</div>

<script>
    // ==================== DATA DEFINITIONS ====================

    // Task 1A: Vocabulary Matching – Global Issues (Part 1)
    const t1a_data = [
        { v: "1. fertilizers", letter: "D", def: "substances added to soil to help plants grow better", hint: "Farmers use these to improve crop yields." },
        { v: "2. pesticides", letter: "G", def: "chemicals used to kill insects that damage crops", hint: "Protect crops from harmful insects." },
        { v: "3. features", letter: "E", def: "special parts or qualities of something", hint: "Apps have useful ones like translators." },
        { v: "4. resources", letter: "F", def: "things such as money, land, or energy that can be used", hint: "Natural ones include water and energy." },
        { v: "5. roam", letter: "A", def: "to move around freely without a fixed direction", hint: "Animals do this in national parks." },
        { v: "6. support", letter: "B", def: "help or encouragement given to someone or something", hint: "Charities provide this to people in need." },
        { v: "7. waste", letter: "C", def: "unwanted material that is thrown away", hint: "Plastic can damage the environment." },
        { v: "8. adopt", letter: "H", def: "to choose to use a particular idea, method, or system", hint: "Governments may do this to new rules." }
    ];

    // Task 1B: Vocabulary Matching – Global Issues (Part 2)
    const t1b_data = [
        { v: "1. leading", letter: "B", def: "having the most influence or importance", hint: "A researcher in her field." },
        { v: "2. topic", letter: "C", def: "the main subject being discussed", hint: "Climate change is today's discussion." },
        { v: "3. estimate", letter: "E", def: "to guess the size, number, or cost of something", hint: "Experts do this for project costs." },
        { v: "4. advancing", letter: "D", def: "becoming more developed or modern", hint: "Technology is always doing this." },
        { v: "5. fossil fuels", letter: "F", def: "fuels such as coal, oil, or gas from the earth", hint: "Coal and oil are examples." },
        { v: "6. drought", letter: "A", def: "a period of time with very little rain", hint: "Can destroy crops and cause shortages." },
        { v: "7. overpopulation", letter: "H", def: "a situation where too many people live in one area", hint: "Causes traffic and housing issues." },
        { v: "8. famine", letter: "G", def: "a serious lack of food affecting many people", hint: "Millions died during this." }
    ];

    // Task 1C: Vocabulary Matching – Technology
    const t1c_data = [
        { v: "1. chores", letter: "C", def: "routine jobs done at home", hint: "Cleaning and washing dishes are examples." },
        { v: "2. copyrighted", letter: "I", def: "protected by law from being copied", hint: "Images cannot be reused without permission." },
        { v: "3. rights", letter: "D", def: "the ability to have or do something legally", hint: "Basic ones as citizens." },
        { v: "4. properties", letter: "G", def: "a quality in a substance or material", hint: "characteristic that means that it can be used in a particular way." },
        { v: "5. emerging", letter: "B", def: "starting to appear or become important", hint: "Online education is an trend." },
        { v: "6. connect", letter: "H", def: "to link people or systems together", hint: "Social media allows users to do this." },
        { v: "7. hackers", letter: "E", def: "people who break into computer systems without permission", hint: "Security protects data from them." },
        { v: "8. develop", letter: "K", def: "to grow or improve over time", hint: "Students encouraged to skills." },
        { v: "9. risks", letter: "J", def: "possible dangers or problems", hint: "Sharing personal info involves serious ones." },
        { v: "10. illegal", letter: "A", def: "not allowed according to the law", hint: "Selling fake products is this." },
        { v: "11. powerful", letter: "F", def: "very strong or able to influence others greatly", hint: "The most lens you can get." }
    ];

    // Task 2A: Fill gaps – Global Issues (Part 1)
    const t2a_data = [
        { q: "Farmers often use ______ to improve soil quality and increase crop yields.", ans: "fertilizers", hint: "Added to soil to help plants grow." },
        { q: "The charity provides food and medical ______ to people in need.", ans: "support", hint: "Help or encouragement." },
        { q: "Too much plastic ______ can seriously damage the environment.", ans: "waste", hint: "Unwanted thrown-away material." },
        { q: "Many wild animals ______ freely in protected national parks.", ans: "roam", hint: "Move without a fixed direction." },
        { q: "This app has useful ______ such as a language translator and map service.", ans: "features", hint: "Special parts or qualities." },
        { q: "The government decided to ______ new rules to reduce pollution.", ans: "adopt", hint: "Choose to use a new system." },
        { q: "Developing countries may lack natural ______ like clean water and energy.", ans: "resources", hint: "Things like money, land, energy." },
        { q: "______ are commonly used to protect crops from harmful insects.", ans: "pesticides", hint: "Chemicals to kill insects." }
    ];

const t2a_wordBank = ["waste", "fertilizers", "features", "adopt", "roam", "resources", "pesticides", "support"];

    // Task 2B: Fill gaps – Global Issues (Part 2)
    const t2b_data = [
        { q: "Climate change is the main ______ of today's discussion.", ans: "topic", hint: "Main subject being discussed." },
        { q: "Scientists are working on ______ technology to reduce pollution.", ans: "advancing", hint: "Becoming more modern." },
        { q: "The company asked an expert to ______ the cost of the new project.", ans: "estimate", hint: "Guess the size or cost." },
        { q: "Coal and oil are still widely used ______ in many countries.", ans: "fossil fuels", hint: "Fuels from the earth." },
        { q: "A long ______ can destroy crops and cause water shortages.", ans: "drought", hint: "Period with very little rain." },
        { q: "The city faces serious problems due to ______, such as traffic and housing issues.", ans: "overpopulation", hint: "Too many people." },
        { q: "Millions of people died during the ______ caused by food shortages.", ans: "famine", hint: "Serious lack of food." },
        { q: "She is a ______ researcher in the field of environmental science.", ans: "leading", hint: "Most important or influential." }
    ];

const t2b_wordBank = ["overpopulation", "fossil fuels", "estimate", "leading", "famine", "topic", "advancing", "drought"];

    // Task 2C: Fill gaps – Technology
    const t2c_data = [
        { q: "Children are often asked to help with simple ______ such as cleaning or washing dishes.", ans: "chores", hint: "Routine home jobs." },
        { q: "This image is ______, so it cannot be reused without permission.", ans: "copyrighted", hint: "Protected by law from copying." },
        { q: "Everyone should be aware of their basic ______ as citizens.", ans: "rights", hint: "Legal abilities." },
        { q: "One of the ______ of copper is that it conducts heat and electricity very well.", ans: "properties", hint: "a quality that copper has." },
        { q: "Online education is an ______ trend in modern society.", ans: "emerging", hint: "Starting to become important." },
        { q: "Social media platforms allow users to ______ with people worldwide.", ans: "connect", hint: "Link together." },
        { q: "Many organisations invest in security to protect data from ______.", ans: "hackers", hint: "People who break into computer systems." },
        { q: "Students are encouraged to ______ problem-solving skills at school.", ans: "develop", hint: "Grow or improve over time." },
        { q: "Sharing personal information online can involve serious ______.", ans: "risks", hint: "Possible dangers or problems." },
        { q: "In many countries, selling fake products is ______.", ans: "illegal", hint: "Not allowed according to the law." },
        { q: "This microscope has the most ______ lens that you can get.", ans: "powerful", hint: "Very strong or effective." }
    ];
const t2c_wordBank = ["develop", "illegal", "chores", "hackers", "copyrighted", "powerful", "emerging", "risks", "rights", "connect", "properties"];
    // Task 3: Future forms
    const t3_data = [
        { q: "A: The printer isn't working again. B: Don't worry. I ______ (fix) it for you.", ans: "will fix", hint: "Instant decision/offer" },
        { q: "A: Look at those dark clouds! B: Yes, it ______ (rain) very soon.", ans: "is going to rain", hint: "Prediction based on evidence" },
        { q: "A: Why are you carrying so many boxes? B: I ______ (move) to a new apartment this weekend.", ans: "am moving", hint: "Fixed arrangement" },
        { q: "A: Have you decided what to do after school? B: Yes, I ______ (study) environmental science at university.", ans: "am going to study", hint: "Plan/intention" },
        { q: "A: The phone is ringing. B: I ______ (answer) it.", ans: "will answer", hint: "Instant decision" },
        { q: "A: What are your plans for tomorrow evening? B: I ______ (attend) a meeting about climate change.", ans: "am attending", hint: "Fixed arrangement" },
        { q: "A: I can't find my wallet anywhere. B: Calm down. I ______ (help) you look for it.", ans: "will help", hint: "Offer" },
        { q: "A: Are you free on Friday afternoon? B: Sorry, I ______ (work) late that day.", ans: "am working", hint: "Fixed arrangement" },
        { q: "A: The exam results will be announced tomorrow. B: Really? I ______ (check) the website as soon as they are online.", ans: "will check", hint: "Future action" },
        { q: "A: Why did you buy so many reusable bags? B: Because I ______ (stop) using plastic ones.", ans: "am going to stop", hint: "Intention" }
    ];

    // Task 4: Conditionals
    const t4_data = [
        { q: "If the city <span class='bold-option'>invests / invested</span> more in public transport, air pollution will decrease.", ans: "invests", options: ["invests", "invested"], hint: "Câu điều kiện loại 1 (có thể xảy ra): mệnh đề If chia ở hiện tại đơn." },
        { q: "Would you have joined the campaign if you <span class='bold-option'>knew / had known</span> about it earlier?", ans: "had known", options: ["knew", "had known"], hint: "Câu điều kiện loại 3 (không có thật trong quá khứ): mệnh đề If chia ở quá khứ hoàn thành." },
        { q: "If people <span class='bold-option'>reuse / reused</span> plastic bags, less waste would end up in the ocean.", ans: "reused", options: ["reuse", "reused"], hint: "Câu điều kiện loại 2 (không có thật ở hiện tại): mệnh đề If chia ở quá khứ đơn." },
        { q: "Would the crops have survived if there <span class='bold-option'>is / had been</span> enough rain last summer?", ans: "had been", options: ["is", "had been"], hint: "Câu điều kiện loại 3 (hành động trong quá khứ)." },
        { q: "If he <span class='bold-option'>had followed / followed</span> the safety rules, the accident wouldn't have happened.", ans: "had followed", options: ["had followed", "followed"], hint: "Câu điều kiện loại 3 (hành động trong quá khứ)." },
        { q: "Will the school organise a clean-up day if more students <span class='bold-option'>sign / signed</span> up?", ans: "sign", options: ["sign", "signed"], hint: "Câu điều kiện loại 1 (có thể xảy ra)." },
        { q: "If I <span class='bold-option'>am / were</span> responsible for this project, I would focus on renewable energy.", ans: "were", options: ["am", "were"], hint: "Câu điều kiện loại 2, dùng 'were' cho tất cả các ngôi." },
        { q: "Would you recycle more if recycling bins <span class='bold-option'>are / were</span> easier to find?", ans: "were", options: ["are", "were"], hint: "Câu điều kiện loại 2 (không có thật ở hiện tại)." },
        { q: "If the government <span class='bold-option'>acts / had acted</span> sooner, will it prevent further damage to the forest?", ans: "acts", options: ["acts", "had acted"], hint: "Câu điều kiện loại 1 (hành động có thể xảy ra ở tương lai)." },
        { q: "If she <span class='bold-option'>uses / had used</span> stronger passwords, hackers wouldn't have accessed her account.", ans: "had used", options: ["uses", "had used"], hint: "Câu điều kiện loại 3 (hành động trong quá khứ)." }
    ];

    // Task 5: must not / don't have to
    const t5_data = [
        { q: "Employees ______ work overtime if they finish their tasks early.", ans: "don't have to", options: ["must not", "don't have to"], hint: "Không bắt buộc (vì họ có thể về sớm)." },
        { q: "You ______ touch the exhibits in the museum.", ans: "must not", options: ["must not", "don't have to"], hint: "Bị cấm (quy định của bảo tàng)." },
        { q: "We ______ bring food to the meeting because refreshments will be provided.", ans: "don't have to", options: ["must not", "don't have to"], hint: "Không cần thiết (vì đã có đồ ăn sẵn)." },
        { q: "Children ______ play near the construction site. It is dangerous.", ans: "must not", options: ["must not", "don't have to"], hint: "Bị cấm vì nguy hiểm." },
        { q: "Students ______ wear a uniform on Fridays; it is optional.", ans: "don't have to", options: ["must not", "don't have to"], hint: "Không bắt buộc (được lựa chọn)." },
        { q: "You ______ park your car here. This area is for emergency vehicles only.", ans: "must not", options: ["must not", "don't have to"], hint: "Bị cấm (khu vực chỉ dành cho xe cấp cứu)." },
        { q: "He ______ attend the training session because he has already completed it.", ans: "doesn't have to", options: ["must not", "doesn't have to"], hint: "Không cần thiết (vì đã hoàn thành rồi)." },
        { q: "Visitors ______ enter the laboratory without permission.", ans: "must not", options: ["must not", "don't have to"], hint: "Bị cấm (không được phép)." },
        { q: "She ______ submit the report today; the deadline is next week.", ans: "doesn't have to", options: ["must not", "doesn't have to"], hint: "Không cần thiết (hạn nộp là tuần sau)." },
        { q: "You ______ use your mobile phone during the exam.", ans: "must not", options: ["must not", "don't have to"], hint: "Bị cấm (nội quy phòng thi)." }
    ];

    // Task 6: Modal verbs
    const t6_data = [
        { q: "This sign says 'No entry'. You <span class='bold-option'>can / must not</span> go inside this room.", ans: "must not", options: ["can", "must not"], hint: "Biển báo 'Cấm vào' thể hiện sự cấm đoán, dùng 'must not'." },
        { q: "I'm not certain, but the teacher <span class='bold-option'>may / must</span> arrive late today.", ans: "may", options: ["may", "must"], hint: "'May' diễn tả một khả năng có thể xảy ra (không chắc chắn)." },
        { q: "When he was a teenager, he <span class='bold-option'>would / might</span> help his parents every weekend.", ans: "would", options: ["would", "might"], hint: "'Would' diễn tả một thói quen trong quá khứ." },
        { q: "The rules are clear. Students <span class='bold-option'>can / ought to</span> wear their uniforms at school.", ans: "ought to", options: ["can", "ought to"], hint: "'Ought to' mang nghĩa 'nên' dựa trên quy định, bổn phận." },
        { q: "This app is easy to use. Anyone <span class='bold-option'>could / must</span> learn it in a few minutes.", ans: "could", options: ["could", "must"], hint: "'Could' diễn tả một khả năng nói chung." },
        { q: "It is raining heavily. You <span class='bold-option'>should / might</span> take an umbrella with you.", ans: "should", options: ["should", "might"], hint: "'Should' dùng để đưa ra lời khuyên." },
        { q: "In the past, people <span class='bold-option'>would / may</span> store information in paper files.", ans: "would", options: ["would", "may"], hint: "'Would' diễn tả một thói quen trong quá khứ." },
        { q: "The doctor says you <span class='bold-option'>must / could</span> take this medicine every day.", ans: "must", options: ["must", "could"], hint: "'Must' diễn tả một mệnh lệnh hoặc sự cần thiết mạnh mẽ từ bác sĩ." },
        { q: "With enough practice, you <span class='bold-option'>can / should</span> improve your pronunciation.", ans: "can", options: ["can", "should"], hint: "'Can' diễn tả một khả năng có thể đạt được." },
        { q: "There is a chance that the meeting <span class='bold-option'>might / would</span> be canceled.", ans: "might", options: ["might", "would"], hint: "'Might' diễn tả một khả năng có thể xảy ra (có thể bị hủy)." }
    ];

    // Task 7: Dialogue completion - CẬP NHẬT THEO YÊU CẦU
    const t7_data = [
        { q: "Debbie: Hi Bill, how are you?<br>Bill: Oh, hi Debbie, I'm fine thanks. I'm glad I ran into you because 1) ______", ans: "b", hint: "Bill was looking for Debbie." },
        { q: "Debbie: 2) ______ Well, here I am.", ans: "c", hint: "Debbie is surprised." },
        { q: "Bill: I need your help with something. 3) ______", ans: "e", hint: "Bill asks if Debbie can help." },
        { q: "Debbie: Well, I will certainly help if I can. What is it?<br>Bill: There is a demonstration next week and I need help putting up banners.<br>Debbie: 4) ______ The demonstration, I mean.", ans: "d", hint: "Debbie asks about the demonstration." },
        { q: "Bill: We are trying to do something about global warming.<br>Debbie: 5) ______ I would be happy to help you.", ans: "a", hint: "Debbie thinks it's important." }
    ];

    const t7_wordBank = [
        { id: "a", text: "a That's a great thing to be a part of." },
        { id: "b", text: "b I've been looking for you." },
        { id: "c", text: "c Really? Is that so?" },
        { id: "d", text: "d What's it for?" },
        { id: "e", text: "e Sure. What's it for?" }
    ];

    // Task 8: Reading comprehension (True/False) với thông tin paragraph để highlight
    const t8_data = [
        { statement: "The NewsMuseum focuses on the history and development of media and communication.", ans: "T", para: "p1", hint: "Paragraph 1: 'dedicated to the history of news, media, and communication'" },
        { statement: "The museum is located in Lisbon, the capital city of Portugal.", ans: "F", para: "p1", hint: "Paragraph 1: 'located in the town of Sintra, Portugal'" },
        { statement: "A statue outside the museum shows a writer using modern technology.", ans: "T", para: "p2", hint: "Paragraph 2: 'statue of the Portuguese writer Eça de Queiroz holding a smartphone'" },
        { statement: "The museum is divided into fewer than twenty exhibition areas.", ans: "F", para: "p2", hint: "Paragraph 2: 'more than 25 themed sections'" },
        { statement: "The themed sections only present important events from Portugal.", ans: "F", para: "p2", hint: "Paragraph 2: 'present important events from Portugal and the world'" },
        { statement: "All the exhibits consist only of written texts.", ans: "F", para: "p3", hint: "Paragraph 3: 'combine written information with multimedia content'" },
        { statement: "Some parts of the museum discuss the freedom of the press.", ans: "T", para: "p3", hint: "Paragraph 3: 'focus on topics such as press freedom'" },
        { statement: "The museum does not organise any activities for students.", ans: "F", para: "p4", hint: "Paragraph 4: 'activities are regularly organised, especially for school groups'" },
        { statement: "Visitors can read and view exhibits in more than one language.", ans: "T", para: "p5", hint: "Paragraph 5: 'available in both Portuguese and English'" },
        { statement: "One aim of the museum is to encourage people to think about the role of media.", ans: "T", para: "p5", hint: "Paragraph 5: 'encourage visitors to think critically about the influence of media'" }
    ];

    // ==================== STATE MANAGEMENT ====================
    let answerStates = new Map();
    let wordUsageCount = {};
    let optionSelections = new Map();
    let readingSelections = new Map();
    let hintVisible = {};
    let selectedTextRange = null;
    let contextMenu = null;

    // ==================== HIGHLIGHT FUNCTIONS ====================
    function initializeTextHighlighting() {
        contextMenu = document.getElementById('context-menu');
        const highlightBtn = document.getElementById('highlight-text');
        const removeHighlightBtn = document.getElementById('remove-highlight');
        const clearHighlightsBtn = document.getElementById('clear-highlights');
        
        // Context menu for text highlighting
        document.addEventListener('contextmenu', function(e) {
            const selection = window.getSelection();
            if (selection.toString().trim() && 
                (e.target.closest('.reading-text') || e.target.closest('.text-panel'))) {
                selectedTextRange = saveSelection();
                
                contextMenu.style.display = 'block';
                contextMenu.style.left = e.pageX + 'px';
                contextMenu.style.top = e.pageY + 'px';
                
                e.preventDefault();
            } else {
                contextMenu.style.display = 'none';
            }
        });
        
        // Hide context menu when clicking elsewhere
        document.addEventListener('click', function(e) {
            if (contextMenu && !contextMenu.contains(e.target)) {
                contextMenu.style.display = 'none';
            }
        });
        
        // Highlight selected text
        if (highlightBtn) {
            highlightBtn.addEventListener('click', function() {
                if (selectedTextRange) {
                    highlightSelection(selectedTextRange);
                    contextMenu.style.display = 'none';
                }
            });
        }
        
        // Remove highlight from selected text
        if (removeHighlightBtn) {
            removeHighlightBtn.addEventListener('click', function() {
                if (selectedTextRange) {
                    removeHighlightFromSelection(selectedTextRange);
                    contextMenu.style.display = 'none';
                }
            });
        }
        
        // Clear all highlights
        if (clearHighlightsBtn) {
            clearHighlightsBtn.addEventListener('click', function() {
                clearAllHighlights();
                contextMenu.style.display = 'none';
            });
        }
    }

    function saveSelection() {
        const selection = window.getSelection();
        if (selection.rangeCount === 0) return null;
        
        return selection.getRangeAt(0).cloneRange();
    }

    function highlightSelection(range) {
        if (!range) return;
        
        const span = document.createElement('span');
        span.className = 'highlighted-text';
        
        try {
            range.surroundContents(span);
        } catch(e) {
            // If the range selects partially across nodes, we need a different approach
            const div = document.createElement('div');
            div.innerHTML = range.toString();
            span.innerHTML = div.innerHTML;
            range.deleteContents();
            range.insertNode(span);
        }
        
        const selection = window.getSelection();
        selection.removeAllRanges();
    }

    function removeHighlightFromSelection(range) {
        if (!range) return;
        
        const parent = range.commonAncestorContainer;
        const highlightSpans = parent.parentElement.querySelectorAll('.highlighted-text');
        
        highlightSpans.forEach(span => {
            if (range.intersectsNode(span)) {
                const parent = span.parentNode;
                while (span.firstChild) {
                    parent.insertBefore(span.firstChild, span);
                }
                parent.removeChild(span);
            }
        });
        
        const selection = window.getSelection();
        selection.removeAllRanges();
    }

    function clearAllHighlights() {
        const highlights = document.querySelectorAll('.highlighted-text');
        highlights.forEach(highlight => {
            const parent = highlight.parentNode;
            while (highlight.firstChild) {
                parent.insertBefore(highlight.firstChild, highlight);
            }
            parent.removeChild(highlight);
        });
    }

    // Task 8 specific: highlight paragraph
    function highlightParagraph(paraId) {
        // Remove previous hint highlights
        document.querySelectorAll('.hint-highlight').forEach(el => {
            el.classList.remove('hint-highlight');
        });
        
        // Add highlight to the specified paragraph
        const para = document.getElementById(paraId);
        if (para) {
            para.classList.add('hint-highlight');
        }
    }

    // ==================== RENDERING FUNCTIONS ====================

    // Task 1A, 1B, 1C render
    function renderMatching(containerId, defContainerId, data) {
        const vocabContainer = document.getElementById(containerId);
        const defContainer = document.getElementById(defContainerId);

        if (!vocabContainer || !defContainer) return;

        vocabContainer.innerHTML = '';
        defContainer.innerHTML = '';

        const definitions = {};
        data.forEach(item => {
            definitions[item.letter] = item.def;
        });

        const sortedLetters = Object.keys(definitions).sort();
        sortedLetters.forEach(letter => {
            defContainer.innerHTML += `
                <div class="definition-item">
                    <span class="definition-letter">${letter}.</span>
                    <span class="definition-text">${definitions[letter]}</span>
                </div>`;
        });

        data.forEach((item, i) => {
            const qid = `${containerId.replace('vocab-', '')}-q${i}`;

            vocabContainer.innerHTML += `
                <div class="vocab-item">
                    <span class="vocab-text">${item.v}</span>
                    <input type="text" class="letter-input" id="${qid}" data-type="input" data-ans="${item.letter}" maxlength="1" oninput="adjustWidth(this)">
                    <div class="row-btns">
                        <button class="btn-small" id="${qid}-eye" onclick="toggleSingleAns('${qid}')" title="Show/Hide answer">👁️</button>
                        <button class="info-btn" id="${qid}-info" onclick="toggleHint('${qid}')" title="Show/Hide hint">i</button>
                    </div>
                    <div class="hint-box" id="${qid}-hint">💡 ${item.hint || 'Match the word to its definition.'}</div>
                </div>`;
        });
    }

    // Fill gaps render
    function renderFillGaps(prefix, data, wordBank) {
        const bankContainer = document.getElementById(`bank-${prefix}`);
        const questionContainer = document.getElementById(`questions-${prefix}`);

        if (!bankContainer || !questionContainer) return;

        bankContainer.innerHTML = '';
        wordUsageCount[prefix] = {};

        wordBank.forEach((word, i) => {
            const wordId = `${prefix}-word-${i}`;
            bankContainer.innerHTML += `
                <div class="word-item" id="${wordId}" data-word="${word.toLowerCase()}" draggable="true" ondragstart="dragWord(event)" onclick="selectWordFromBank('${wordId}')">
                    ${word}
                </div>`;
            wordUsageCount[prefix][word.toLowerCase()] = 0;
        });

        questionContainer.innerHTML = '';

        data.forEach((item, i) => {
            const qid = `${prefix}-q${i}`;
            questionContainer.innerHTML += `
                <div class="question-row">
                    <strong>${i+1}</strong> ${item.q}
                    <input type="text" class="word-input" id="${qid}" data-type="input" data-ans="${item.ans}" oninput="adjustWidth(this); updateWordBank('${prefix}')" ondrop="dropWord(event, '${qid}')" ondragover="allowDrop(event)" onclick="this.select()">
                    <div class="row-btns">
                        <button class="btn-small" id="${qid}-eye" onclick="toggleSingleAns('${qid}')">👁️</button>
                        <button class="info-btn" id="${qid}-info" onclick="toggleHint('${qid}')">i</button>
                    </div>
                    <div class="hint-box" id="${qid}-hint">💡 ${item.hint}</div>
                </div>`;
        });

        addWordBankEventListeners(prefix);
    }

    // Task 3 render
    function renderFutureForms() {
        const container = document.getElementById('questions-t3');
        if (!container) return;

        container.innerHTML = '';

        t3_data.forEach((item, i) => {
            const qid = `t3-q${i}`;
            container.innerHTML += `
                <div class="question-row">
                    <strong>${i+1}</strong> ${item.q}
                    <input type="text" class="word-input" id="${qid}" data-type="input" data-ans="${item.ans}" oninput="adjustWidth(this)">
                    <div class="row-btns">
                        <button class="btn-small" id="${qid}-eye" onclick="toggleSingleAns('${qid}')">👁️</button>
                        <button class="info-btn" id="${qid}-info" onclick="toggleHint('${qid}')">i</button>
                    </div>
                    <div class="hint-box" id="${qid}-hint">💡 ${item.hint}</div>
                </div>`;
        });
    }

    // Task 4 render
    function renderConditionals() {
        const container = document.getElementById('questions-t4');
        if (!container) return;

        container.innerHTML = '';

        t4_data.forEach((item, i) => {
            const qid = `t4-q${i}`;

            let optionsHtml = '';
            item.options.forEach((option, optIndex) => {
                optionsHtml += `<button class="option-btn" onclick="selectOption('${qid}', '${option}')" id="${qid}-opt${optIndex}">${option}</button>`;
            });

            container.innerHTML += `
                <div class="question-row">
                    <strong>${i+1}</strong> <span class="sentence-text">
                        ${item.q}
                        <div class="option-container">
                            ${optionsHtml}
                        </div>
                    </span>
                    <div class="row-btns">
                        <button class="btn-small" id="${qid}-eye" onclick="toggleSingleAns('${qid}')">👁️</button>
                        <button class="info-btn" id="${qid}-info" onclick="toggleHint('${qid}')">i</button>
                    </div>
                    <div class="hint-box" id="${qid}-hint">💡 ${item.hint}</div>
                </div>`;
        });
    }

    // Task 5 render
    function renderMustNot() {
        const container = document.getElementById('questions-t5');
        if (!container) return;

        container.innerHTML = '';

        t5_data.forEach((item, i) => {
            const qid = `t5-q${i}`;

            let optionsHtml = '';
            item.options.forEach((option, optIndex) => {
                optionsHtml += `<button class="option-btn" onclick="selectOption('${qid}', '${option}')" id="${qid}-opt${optIndex}">${option}</button>`;
            });

            container.innerHTML += `
                <div class="question-row">
                    <strong>${i+1}</strong> ${item.q}
                    <div class="option-container">
                        ${optionsHtml}
                    </div>
                    <div class="row-btns">
                        <button class="btn-small" id="${qid}-eye" onclick="toggleSingleAns('${qid}')">👁️</button>
                        <button class="info-btn" id="${qid}-info" onclick="toggleHint('${qid}')">i</button>
                    </div>
                    <div class="hint-box" id="${qid}-hint">💡 ${item.hint}</div>
                </div>`;
        });
    }

    // Task 6 render
    function renderModals() {
        const container = document.getElementById('questions-t6');
        if (!container) return;

        container.innerHTML = '';

        t6_data.forEach((item, i) => {
            const qid = `t6-q${i}`;

            let optionsHtml = '';
            item.options.forEach((option, optIndex) => {
                optionsHtml += `<button class="option-btn" onclick="selectOption('${qid}', '${option}')" id="${qid}-opt${optIndex}">${option}</button>`;
            });

            container.innerHTML += `
                <div class="question-row">
                    <strong>${i+1}</strong> <span class="sentence-text">
                        ${item.q}
                        <div class="option-container">
                            ${optionsHtml}
                        </div>
                    </span>
                    <div class="row-btns">
                        <button class="btn-small" id="${qid}-eye" onclick="toggleSingleAns('${qid}')">👁️</button>
                        <button class="info-btn" id="${qid}-info" onclick="toggleHint('${qid}')">i</button>
                    </div>
                    <div class="hint-box" id="${qid}-hint">💡 ${item.hint}</div>
                </div>`;
        });
    }

    // Task 7 render - CẬP NHẬT HIỂN THỊ
    function renderDialogue() {
        const bankContainer = document.getElementById('bank-t7');
        const questionContainer = document.getElementById('questions-t7');

        if (!bankContainer || !questionContainer) return;

        bankContainer.innerHTML = '';
        wordUsageCount['t7'] = {};

        t7_wordBank.forEach((item, i) => {
            const wordId = `t7-word-${i}`;
            bankContainer.innerHTML += `
                <div class="word-item" id="${wordId}" data-word="${item.id}" draggable="true" ondragstart="dragWord(event)" onclick="selectWordFromBank('${wordId}')">
                    ${item.text}
                </div>`;
            wordUsageCount['t7'][item.id] = 0;
        });

        questionContainer.innerHTML = '';

        t7_data.forEach((item, i) => {
            const qid = `t7-q${i}`;
            questionContainer.innerHTML += `
                <div class="question-row" style="margin-bottom: 20px; padding: 15px; background-color: #f9f9f9; border-radius: 8px; border-left: 4px solid var(--primary);">
                    <div style="margin-bottom: 10px; line-height: 1.8;">${item.q}</div>
                    <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                        <input type="text" class="word-input" id="${qid}" data-type="input" data-ans="${item.ans}" placeholder="Enter letter (a-e)" style="width: 80px;" oninput="adjustWidth(this); updateWordBank('t7')" ondrop="dropWord(event, '${qid}')" ondragover="allowDrop(event)" onclick="this.select()">
                        <div class="row-btns">
                            <button class="btn-small" id="${qid}-eye" onclick="toggleSingleAns('${qid}')" title="Show/Hide answer">👁️</button>
                            <button class="info-btn" id="${qid}-info" onclick="toggleHint('${qid}')" title="Show/Hide hint">i</button>
                        </div>
                    </div>
                    <div class="hint-box" id="${qid}-hint" style="margin-top: 10px;">💡 ${item.hint}</div>
                </div>`;
        });

        addWordBankEventListeners('t7');
    }

    // Task 8 render
    function renderReading() {
        const questionsContainer = document.getElementById('reading-questions-t8');
        if (!questionsContainer) return;

        questionsContainer.innerHTML = '';

        t8_data.forEach((item, i) => {
            const qid = `t8-q${i}`;

            questionsContainer.innerHTML += `
                <div class="truefalse-item" id="${qid}-container">
                    <div class="truefalse-question">
                        <strong>${i+1}.</strong> ${item.statement}
                    </div>
                    <div class="truefalse-options">
                        <div class="truefalse-option" id="${qid}-T" onclick="selectTrueFalse('${qid}', 'T')">
                            <input type="radio" name="${qid}" id="${qid}-T-radio"> True
                        </div>
                        <div class="truefalse-option" id="${qid}-F" onclick="selectTrueFalse('${qid}', 'F')">
                            <input type="radio" name="${qid}" id="${qid}-F-radio"> False
                        </div>
                    </div>
                    <div class="row-btns" style="margin-top: 10px;">
                        <button class="btn-small" id="${qid}-eye" onclick="toggleSingleAns('${qid}')" title="Show answer & highlight paragraph">👁️</button>
                        <button class="info-btn" id="${qid}-info" onclick="toggleHint('${qid}')" title="Hint">i</button>
                    </div>
                    <div class="hint-box" id="${qid}-hint">💡 ${item.hint}</div>
                </div>`;
        });
    }

    // ==================== UTILITY FUNCTIONS ====================

    function adjustWidth(el) {
        let baseWidth;
        if (el.classList.contains('letter-input')) {
            baseWidth = 45;
        } else if (el.classList.contains('word-input')) {
            baseWidth = 120;
        } else {
            baseWidth = 60;
        }

        const charWidth = el.classList.contains('word-input') ? 9 : 10;
        const newWidth = Math.max(el.value.length * charWidth + 20, baseWidth);

        let maxWidth;
        if (el.classList.contains('letter-input')) {
            maxWidth = 80;
        } else if (el.classList.contains('word-input')) {
            maxWidth = 400;
        } else {
            maxWidth = 300;
        }

        el.style.width = Math.min(newWidth, maxWidth) + "px";
    }

    function toggleHint(id) {
        const h = document.getElementById(id + '-hint');
        const infoBtn = document.getElementById(id + '-info');

        if (h) {
            if (h.style.display === 'block') {
                h.style.display = 'none';
                if (infoBtn) infoBtn.classList.remove('active');
            } else {
                h.style.display = 'block';
                if (infoBtn) infoBtn.classList.add('active');
            }
        }
    }

    function toggleSingleAns(id) {
        const qid = id.replace('-eye', '');

        // Handle Task 8 True/False questions
        if (qid.startsWith('t8-q')) {
            const questionIndex = parseInt(qid.split('-q')[1]);
            const questionData = t8_data[questionIndex];
            const correctAnswer = questionData.ans;

            const trueOption = document.getElementById(`${qid}-T`);
            const falseOption = document.getElementById(`${qid}-F`);
            const eyeBtn = document.getElementById(id);
            const stateKey = `${qid}-state`;
            const isCurrentlyShown = answerStates.get(stateKey) || false;

            if (isCurrentlyShown) {
                // Hide answer
                trueOption.classList.remove('correct', 'incorrect');
                falseOption.classList.remove('correct', 'incorrect');
                if (eyeBtn) eyeBtn.classList.remove('active');
                answerStates.set(stateKey, false);
                
                // Remove paragraph highlight
                document.querySelectorAll('.hint-highlight').forEach(el => {
                    el.classList.remove('hint-highlight');
                });
            } else {
                // Show answer
                trueOption.classList.remove('correct', 'incorrect');
                falseOption.classList.remove('correct', 'incorrect');

                if (correctAnswer === 'T') {
                    trueOption.classList.add('correct');
                } else {
                    falseOption.classList.add('correct');
                }

                if (eyeBtn) eyeBtn.classList.add('active');
                answerStates.set(stateKey, true);
                
                // Highlight the relevant paragraph
                highlightParagraph(questionData.para);
            }
            return;
        }

        // Handle option button questions (t4, t5, t6)
        if (qid.startsWith('t4-q') || qid.startsWith('t5-q') || qid.startsWith('t6-q')) {
            let data;
            if (qid.startsWith('t4-q')) data = t4_data;
            else if (qid.startsWith('t5-q')) data = t5_data;
            else data = t6_data;

            const questionIndex = parseInt(qid.split('-q')[1]);
            const questionData = data[questionIndex];
            const correctAnswer = questionData.ans;

            const optionButtons = [];
            for (let i = 0; i < questionData.options.length; i++) {
                const btn = document.getElementById(`${qid}-opt${i}`);
                if (btn) optionButtons.push(btn);
            }

            const stateKey = `${qid}-state`;
            const isCurrentlyShown = answerStates.get(stateKey) || false;

            if (isCurrentlyShown) {
                optionButtons.forEach(btn => {
                    btn.classList.remove('correct-option', 'incorrect-option');
                    const userSelection = optionSelections.get(qid);
                    if (userSelection && btn.textContent === userSelection) {
                        btn.classList.add('selected');
                    }
                });

                const eyeBtn = document.getElementById(id);
                if (eyeBtn) eyeBtn.classList.remove('active');
                answerStates.set(stateKey, false);
            } else {
                optionButtons.forEach(btn => {
                    btn.classList.remove('selected', 'correct-option', 'incorrect-option');
                    if (btn.textContent === correctAnswer) {
                        btn.classList.add('correct-option');
                    }
                });

                const eyeBtn = document.getElementById(id);
                if (eyeBtn) eyeBtn.classList.add('active');
                answerStates.set(stateKey, true);
            }
            return;
        }

        // Handle input questions
        const el = document.getElementById(qid);
        if (!el) return;

        const ans = el.dataset.ans;
        const eyeBtn = document.getElementById(id);
        const stateKey = `${qid}-state`;
        const isCurrentlyShown = answerStates.get(stateKey) || false;

        if (isCurrentlyShown) {
            el.value = "";
            el.classList.remove('correct', 'incorrect-marked');
            adjustWidth(el);
            if (eyeBtn) eyeBtn.classList.remove('active');
            answerStates.set(stateKey, false);
        } else {
            if (ans) {
                el.value = ans;
                el.classList.add('correct');
                el.classList.remove('incorrect-marked');
                adjustWidth(el);
                if (eyeBtn) eyeBtn.classList.add('active');
                answerStates.set(stateKey, true);
            }
        }
    }

    function selectTrueFalse(qid, value) {
        const trueOption = document.getElementById(`${qid}-T`);
        const falseOption = document.getElementById(`${qid}-F`);
        const trueRadio = document.getElementById(`${qid}-T-radio`);
        const falseRadio = document.getElementById(`${qid}-F-radio`);

        trueOption.classList.remove('selected');
        falseOption.classList.remove('selected');

        if (value === 'T') {
            trueOption.classList.add('selected');
            trueRadio.checked = true;
            falseRadio.checked = false;
        } else {
            falseOption.classList.add('selected');
            falseRadio.checked = true;
            trueRadio.checked = false;
        }

        readingSelections.set(qid, value);
    }

    function selectOption(qid, option) {
        const questionIndex = parseInt(qid.split('-q')[1]);
        let data;

        if (qid.startsWith('t4-q')) data = t4_data;
        else if (qid.startsWith('t5-q')) data = t5_data;
        else if (qid.startsWith('t6-q')) data = t6_data;
        else return;

        const optionButtons = [];
        for (let i = 0; i < data[questionIndex].options.length; i++) {
            const btn = document.getElementById(`${qid}-opt${i}`);
            if (btn) optionButtons.push(btn);
        }

        optionButtons.forEach(btn => {
            btn.classList.remove('selected');
        });

        const selectedBtn = optionButtons.find(btn => btn.textContent === option);
        if (selectedBtn) {
            selectedBtn.classList.add('selected');
        }

        optionSelections.set(qid, option);
    }

    function showAnswers(prefix) {
        if (prefix === 't8') {
            // Clear previous highlights
            document.querySelectorAll('.hint-highlight').forEach(el => {
                el.classList.remove('hint-highlight');
            });
            
            t8_data.forEach((item, i) => {
                const qid = `${prefix}-q${i}`;
                const correctAnswer = item.ans;

                const trueOption = document.getElementById(`${qid}-T`);
                const falseOption = document.getElementById(`${qid}-F`);

                trueOption.classList.remove('correct', 'incorrect');
                falseOption.classList.remove('correct', 'incorrect');

                if (correctAnswer === 'T') {
                    trueOption.classList.add('correct');
                } else {
                    falseOption.classList.add('correct');
                }

                const eyeBtn = document.getElementById(`${qid}-eye`);
                if (eyeBtn) eyeBtn.classList.add('active');
                answerStates.set(`${qid}-state`, true);
                
                // Highlight all relevant paragraphs
                highlightParagraph(item.para);
            });
            return;
        }

        if (prefix === 't4' || prefix === 't5' || prefix === 't6') {
            let data;
            if (prefix === 't4') data = t4_data;
            else if (prefix === 't5') data = t5_data;
            else data = t6_data;

            data.forEach((item, i) => {
                const qid = `${prefix}-q${i}`;
                const correctAnswer = item.ans;

                const optionButtons = [];
                for (let j = 0; j < item.options.length; j++) {
                    const btn = document.getElementById(`${qid}-opt${j}`);
                    if (btn) optionButtons.push(btn);
                }

                optionButtons.forEach(btn => {
                    btn.classList.remove('selected', 'correct-option', 'incorrect-option');
                    if (btn.textContent === correctAnswer) {
                        btn.classList.add('correct-option');
                    }
                });

                const eyeBtn = document.getElementById(`${qid}-eye`);
                if (eyeBtn) eyeBtn.classList.add('active');
                answerStates.set(`${qid}-state`, true);
            });
            return;
        }

        if (prefix === 't7') {
            // Đáp án lần lượt: b, c, e, d, a
            const correctAnswers = ['b', 'c', 'e', 'd', 'a'];
            
            t7_data.forEach((item, i) => {
                const qid = `${prefix}-q${i}`;
                const el = document.getElementById(qid);
                const eyeBtn = document.getElementById(`${qid}-eye`);

                if (el) {
                    el.value = correctAnswers[i];
                    el.classList.add('correct');
                    el.classList.remove('incorrect-marked');
                    adjustWidth(el);
                    if (eyeBtn) eyeBtn.classList.add('active');
                    answerStates.set(`${qid}-state`, true);

                    const wordItems = document.querySelectorAll(`#bank-${prefix} .word-item`);
                    wordItems.forEach(wordItem => {
                        const wordData = wordItem.dataset.word;
                        if (wordData === correctAnswers[i]) {
                            wordItem.classList.add('used');
                            if (wordUsageCount[prefix]) {
                                wordUsageCount[prefix][wordData] = 1;
                            }
                        }
                    });
                }
            });
            return;
        }

        // Handle fill-in-the-gap tasks (t2a, t2b, t2c, t3)
        if (prefix === 't2a' || prefix === 't2b' || prefix === 't2c' || prefix === 't3') {
            let data;
            if (prefix === 't2a') data = t2a_data;
            else if (prefix === 't2b') data = t2b_data;
            else if (prefix === 't2c') data = t2c_data;
            else if (prefix === 't3') data = t3_data;

            data.forEach((item, i) => {
                const qid = `${prefix}-q${i}`;
                const el = document.getElementById(qid);
                const eyeBtn = document.getElementById(`${qid}-eye`);

                if (el && item.ans) {
                    el.value = item.ans;
                    el.classList.add('correct');
                    el.classList.remove('incorrect-marked');
                    adjustWidth(el);
                    if (eyeBtn) eyeBtn.classList.add('active');
                    answerStates.set(`${qid}-state`, true);

                    if (prefix.startsWith('t2')) {
                        const normalizedAnswer = normalizeAnswer(item.ans);
                        const wordItems = document.querySelectorAll(`#bank-${prefix} .word-item`);

                        wordItems.forEach(wordItem => {
                            const wordText = wordItem.textContent.trim();
                            const normalizedWord = normalizeAnswer(wordText);

                            if (normalizedWord === normalizedAnswer) {
                                wordItem.classList.add('used');
                                if (wordUsageCount[prefix]) {
                                    wordUsageCount[prefix][normalizedWord] = 1;
                                }
                            }
                        });
                    }
                }
            });
            return;
        }

        // Handle matching tasks (t1a, t1b, t1c)
        document.querySelectorAll(`[id^="${prefix}-q"]`).forEach(el => {
            if (el.dataset && el.dataset.type === 'input') {
                const ans = el.dataset.ans;
                const eyeBtn = document.getElementById(el.id + '-eye');

                if (ans) {
                    el.value = ans;
                    el.classList.add('correct');
                    el.classList.remove('incorrect-marked');
                    adjustWidth(el);
                    if (eyeBtn) eyeBtn.classList.add('active');
                    answerStates.set(`${el.id}-state`, true);
                }
            }
        });
    }

    function resetSection(prefix) {
        if (prefix === 't8') {
            // Reset True/False options
            t8_data.forEach((item, i) => {
                const qid = `t8-q${i}`;
                const trueOption = document.getElementById(`${qid}-T`);
                const falseOption = document.getElementById(`${qid}-F`);
                const trueRadio = document.getElementById(`${qid}-T-radio`);
                const falseRadio = document.getElementById(`${qid}-F-radio`);
                const eyeBtn = document.getElementById(`${qid}-eye`);

                trueOption.classList.remove('correct', 'incorrect', 'selected');
                falseOption.classList.remove('correct', 'incorrect', 'selected');
                if (trueRadio) trueRadio.checked = false;
                if (falseRadio) falseRadio.checked = false;
                if (eyeBtn) eyeBtn.classList.remove('active');
                
                answerStates.delete(`${qid}-state`);
                readingSelections.delete(qid);
            });
            
            // Remove all highlights
            document.querySelectorAll('.hint-highlight').forEach(el => {
                el.classList.remove('hint-highlight');
            });
            return;
        }

        document.querySelectorAll(`[id^="${prefix}"]`).forEach(i => {
            if(i.tagName === 'INPUT') {
                i.value = "";
                i.classList.remove('correct', 'incorrect-marked');
                adjustWidth(i);
            }

            const hBox = document.getElementById(i.id + '-hint');
            if(hBox) hBox.style.display = 'none';
        });

        document.querySelectorAll(`[id$="-eye"], [id$="-info"]`).forEach(btn => {
            if (btn.id.includes(prefix)) {
                btn.classList.remove('active');
            }
        });

        if (prefix === 't4' || prefix === 't5' || prefix === 't6') {
            const allOptionBtns = document.querySelectorAll(`#questions-${prefix} .option-btn`);

            allOptionBtns.forEach(btn => {
                btn.classList.remove('selected', 'correct-option', 'incorrect-option');
            });

            for (const [key, value] of optionSelections.entries()) {
                if (key.startsWith(`${prefix}-`)) {
                    optionSelections.delete(key);
                }
            }

            for (const [key, value] of answerStates.entries()) {
                if (key.includes(`${prefix}-q`)) {
                    answerStates.delete(key);
                }
            }
        }

        if (prefix === 't2a' || prefix === 't2b' || prefix === 't2c' || prefix === 't7') {
            const wordItems = document.querySelectorAll(`#bank-${prefix} .word-item`);
            wordItems.forEach(item => {
                item.classList.remove('used');
                item.style.display = 'flex';
            });

            if (wordUsageCount[prefix]) {
                Object.keys(wordUsageCount[prefix]).forEach(word => {
                    wordUsageCount[prefix][word] = 0;
                });
            }
        }
    }

    function normalizeAnswer(answer) {
        return answer.toLowerCase()
            .trim()
            .replace(/\s+/g, ' ')
            .replace(/[.,;:!?]$/, '');
    }

    function validateMultipleAnswers(userAnswer, correctAnswers) {
        const answers = correctAnswers.split('|').map(ans => normalizeAnswer(ans));
        const normalizedUser = normalizeAnswer(userAnswer);

        return answers.some(ans => ans === normalizedUser);
    }

    function checkAll() {
        // Check input fields
        document.querySelectorAll('[data-type="input"]').forEach(el => {
            const correctAnswers = el.dataset.ans;
            const userAnswer = el.value;

            el.classList.remove('correct', 'incorrect-marked');

            if(!userAnswer.trim()) {
                return;
            }

            if(validateMultipleAnswers(userAnswer, correctAnswers)) {
                el.classList.add('correct');
            } else {
                el.classList.add('incorrect-marked');
            }
        });

        // Check option buttons (t4, t5, t6)
        ['t4', 't5', 't6'].forEach(taskId => {
            let data;
            if (taskId === 't4') data = t4_data;
            else if (taskId === 't5') data = t5_data;
            else data = t6_data;

            data.forEach((item, i) => {
                const qid = `${taskId}-q${i}`;
                const selectedOption = optionSelections.get(qid);
                const correctAnswer = item.ans;

                if (!selectedOption) {
                    return;
                }

                const optionButtons = [];
                for (let j = 0; j < item.options.length; j++) {
                    const btn = document.getElementById(`${qid}-opt${j}`);
                    if (btn) optionButtons.push(btn);
                }

                optionButtons.forEach(btn => {
                    btn.classList.remove('correct-option', 'incorrect-option');
                });

                const userSelectedBtn = optionButtons.find(btn => btn.textContent === selectedOption);
                if (userSelectedBtn) {
                    if (selectedOption === correctAnswer) {
                        userSelectedBtn.classList.add('correct-option');
                    } else {
                        userSelectedBtn.classList.add('incorrect-option');
                    }
                }
            });
        });

        // Check Task 8 True/False
        t8_data.forEach((item, i) => {
            const qid = `t8-q${i}`;
            const userSelection = readingSelections.get(qid);
            const correctAnswer = item.ans;

            const trueOption = document.getElementById(`${qid}-T`);
            const falseOption = document.getElementById(`${qid}-F`);

            trueOption.classList.remove('correct', 'incorrect');
            falseOption.classList.remove('correct', 'incorrect');

            if (userSelection) {
                if (userSelection === 'T') {
                    if (correctAnswer === 'T') {
                        trueOption.classList.add('correct');
                    } else {
                        trueOption.classList.add('incorrect');
                    }
                } else if (userSelection === 'F') {
                    if (correctAnswer === 'F') {
                        falseOption.classList.add('correct');
                    } else {
                        falseOption.classList.add('incorrect');
                    }
                }
            }
        });
    }

    // Word bank functions
    function addWordBankEventListeners(id) {
        const wordItems = document.querySelectorAll(`#bank-${id} .word-item`);
        const inputs = document.querySelectorAll(`#questions-${id} input.word-input`);

        wordItems.forEach(item => {
            item.addEventListener('click', function() {
                selectWordFromBank(this.id);
            });

            item.addEventListener('dragstart', function(e) {
                dragWord(e);
            });
        });

        inputs.forEach(input => {
            input.addEventListener('dragover', function(e) {
                allowDrop(e);
            });

            input.addEventListener('drop', function(e) {
                dropWord(e, this.id);
            });

            input.addEventListener('input', function() {
                updateWordBank(id);
            });
        });
    }

    function dragWord(event) {
        event.dataTransfer.setData("text/plain", event.target.dataset.word);
        event.dataTransfer.setData("wordId", event.target.id);
    }

    function allowDrop(event) {
        event.preventDefault();
    }

    function dropWord(event, inputId) {
        event.preventDefault();
        const word = event.dataTransfer.getData("text/plain");
        const wordId = event.dataTransfer.getData("wordId");

        const input = document.getElementById(inputId);
        if (input) {
            input.value = word;
            adjustWidth(input);

            const wordElement = document.getElementById(wordId);
            if (wordElement) {
                wordElement.classList.add('used');
            }

            const taskId = inputId.split('-')[0];
            updateWordBankUsage(word, taskId);
        }
    }

    function selectWordFromBank(wordId) {
        const wordItem = document.getElementById(wordId);
        if (!wordItem || wordItem.classList.contains('used')) return;

        const word = wordItem.dataset.word;
        const taskId = wordId.split('-')[0];

        const inputs = document.querySelectorAll(`#questions-${taskId} input.word-input`);
        let emptyInput = null;

        for (const input of inputs) {
            if (!input.value.trim()) {
                emptyInput = input;
                break;
            }
        }

        if (emptyInput) {
            emptyInput.value = word;
            adjustWidth(emptyInput);

            wordItem.classList.add('used');

            updateWordBankUsage(word, taskId);
        } else {
            alert('All gaps are filled. You can click on a gap to replace its content.');
        }
    }

    function updateWordBankUsage(word, taskId) {
        if (!wordUsageCount[taskId]) {
            wordUsageCount[taskId] = {};
        }

        if (!wordUsageCount[taskId][word]) {
            wordUsageCount[taskId][word] = 0;
        }

        const inputs = document.querySelectorAll(`#questions-${taskId} input.word-input`);
        let count = 0;

        inputs.forEach(input => {
            if (normalizeAnswer(input.value) === normalizeAnswer(word)) {
                count++;
            }
        });

        wordUsageCount[taskId][word] = count;

        updateWordBankDisplay(taskId);
    }

    function updateWordBankDisplay(taskId) {
        const wordItems = document.querySelectorAll(`#bank-${taskId} .word-item`);

        wordItems.forEach(item => {
            const word = item.dataset.word;
            const count = wordUsageCount[taskId][word] || 0;

            if (count > 0) {
                item.classList.add('used');
            } else {
                item.classList.remove('used');
                item.style.display = 'flex';
            }
        });
    }

    function updateWordBank(taskId) {
        const inputs = document.querySelectorAll(`#questions-${taskId} input.word-input`);

        if (wordUsageCount[taskId]) {
            Object.keys(wordUsageCount[taskId]).forEach(word => {
                wordUsageCount[taskId][word] = 0;
            });
        }

        inputs.forEach(input => {
            const word = normalizeAnswer(input.value);
            if (word) {
                const wordItems = document.querySelectorAll(`#bank-${taskId} .word-item`);
                wordItems.forEach(item => {
                    const bankWord = normalizeAnswer(item.dataset.word);
                    if (bankWord === word) {
                        if (wordUsageCount[taskId][bankWord] !== undefined) {
                            wordUsageCount[taskId][bankWord]++;
                        }
                    }
                });
            }
        });

        updateWordBankDisplay(taskId);
    }

    // Resizer function
    function initializeResizer() {
        const resizer = document.getElementById('resizer-t8');
        const leftPanel = document.getElementById('text-panel-t8');
        const rightPanel = document.getElementById('questions-panel-t8');

        if (!resizer || !leftPanel || !rightPanel) return;

        leftPanel.style.width = '50%';
        rightPanel.style.flex = '1';

        let isResizing = false;
        let startX = 0;
        let startLeftWidth = 0;

        resizer.addEventListener('mousedown', function(e) {
            isResizing = true;
            startX = e.clientX;
            startLeftWidth = leftPanel.offsetWidth;

            document.body.style.cursor = 'col-resize';
            document.body.style.userSelect = 'none';

            document.addEventListener('mousemove', handleMouseMove);
            document.addEventListener('mouseup', handleMouseUp);
        });

        function handleMouseMove(e) {
            if (!isResizing) return;

            const dx = e.clientX - startX;
            const newLeftWidth = startLeftWidth + dx;

            const containerWidth = leftPanel.parentElement.offsetWidth;
            const minWidth = 200;
            const maxWidth = containerWidth - minWidth - resizer.offsetWidth;

            if (newLeftWidth >= minWidth && newLeftWidth <= maxWidth) {
                leftPanel.style.width = newLeftWidth + 'px';
                rightPanel.style.flex = '1';
            }
        }

        function handleMouseUp() {
            isResizing = false;
            document.body.style.cursor = '';
            document.body.style.userSelect = '';

            document.removeEventListener('mousemove', handleMouseMove);
            document.removeEventListener('mouseup', handleMouseUp);
        }
    }

    // Toggle functions
    function toggleGrammar(grammarId) {
        const element = document.getElementById(`grammar-${grammarId}`);
        const toggleBtn = element.querySelector('.group-toggle');

        if (element.classList.contains('expanded')) {
            element.classList.remove('expanded');
            element.classList.add('collapsed');
            toggleBtn.textContent = '+';
        } else {
            element.classList.remove('collapsed');
            element.classList.add('expanded');
            toggleBtn.textContent = '−';
        }
    }

    function toggleTopic(topicId) {
        const element = document.getElementById(`topic-${topicId}`);
        const toggleBtn = element.parentElement.querySelector('.group-toggle');

        if (element.classList.contains('expanded')) {
            element.classList.remove('expanded');
            element.classList.add('collapsed');
            toggleBtn.textContent = '+';
        } else {
            element.classList.remove('collapsed');
            element.classList.add('expanded');
            toggleBtn.textContent = '−';
        }
    }

    function toggleReferenceSection() {
        const content = document.getElementById('reference-content');
        const toggleBtn = document.getElementById('reference-toggle');

        if (content.style.display === 'none' || content.style.display === '') {
            content.style.display = 'block';
            toggleBtn.textContent = '−';
        } else {
            content.style.display = 'none';
            toggleBtn.textContent = '+';
        }
    }

    // Window onload
    window.onload = () => {
        // Render all tasks
        renderMatching('vocab-t1a', 'def-t1a', t1a_data);
        renderFillGaps('t2a', t2a_data, t2a_wordBank);

        renderMatching('vocab-t1b', 'def-t1b', t1b_data);
        renderFillGaps('t2b', t2b_data, t2b_wordBank);

        renderMatching('vocab-t1c', 'def-t1c', t1c_data);
        renderFillGaps('t2c', t2c_data, t2c_wordBank);

        renderFutureForms();
        renderConditionals();
        renderMustNot();
        renderModals();
        renderDialogue();
        renderReading();

        initializeResizer();
        initializeTextHighlighting();

        // Collapse reference section by default
        const referenceContent = document.getElementById('reference-content');
        const referenceToggle = document.getElementById('reference-toggle');
        if (referenceContent) {
            referenceContent.style.display = 'none';
            referenceToggle.textContent = '+';
        }

        // Make functions global
        window.toggleGrammar = toggleGrammar;
        window.toggleTopic = toggleTopic;
        window.toggleReferenceSection = toggleReferenceSection;
        window.toggleSingleAns = toggleSingleAns;
        window.toggleHint = toggleHint;
        window.selectOption = selectOption;
        window.selectTrueFalse = selectTrueFalse;
        window.showAnswers = showAnswers;
        window.resetSection = resetSection;
        window.checkAll = checkAll;
        window.dragWord = dragWord;
        window.allowDrop = allowDrop;
        window.dropWord = dropWord;
        window.selectWordFromBank = selectWordFromBank;
        window.adjustWidth = adjustWidth;
        window.updateWordBank = updateWordBank;
        window.normalizeAnswer = normalizeAnswer;
    };

    // Enter key to check all answers
    document.addEventListener('keydown', e => {
        if(e.key === 'Enter') {
            checkAll();
        }
    });
</script>
</body>
</html>
